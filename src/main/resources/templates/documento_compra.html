<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Documentos de Compra</title>
    <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css"/>
    <link rel="stylesheet" href="/dist/css/adminlte.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/plugins/jquery/jquery.min.js"></script>
    <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/dist/js/adminlte.min.js"></script>
    <style>
        /* Estilos generales para los modales Bootstrap/AdminLTE */
        .modal-xl {
            max-width: 900px; /* Asegura un ancho más grande para el modal de compra */
        }
        .bg-light {
            background-color: #f8f9fa !important; /* Color para campos readonly */
        }
        /* NUEVO ESTILO PARA FILAS DE DOCUMENTOS INACTIVOS/CANCELADOS (similar a venta.html) */
        .cancelled-item { /* Renombrado para consistencia con 'venta.html' si lo deseas, o usa table-danger-custom */
            background-color: #f8d7da !important; /* Rojo claro para indicar cancelación */
            color: #721c24 !important; /* Texto oscuro para contraste */
        }
        .cancelled-item a, .cancelled-item button {
            color: #721c24 !important; /* Asegura que los enlaces y botones también se vean afectados */
        }
        /* Asegurarse de que el color de los iconos también se vea afectado */
        .cancelled-item .fas {
            color: #721c24 !important;
        }

    </style>
</head>
<body class="hold-transition sidebar-mini">
<section th:fragment="contenido" class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Documentos de Compra</h3>
                        <div class="card-tools">
                            <button type="button" onclick="openFormModal(null)"
                                    class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                                <i class="fas fa-plus"></i> Registrar Nueva Compra
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="input-group">
                                    <input type="search" id="searchTermDocumentoCompra" class="form-control" placeholder="Buscar por proveedor, N° documento..."
                                           onkeyup="aplicarFiltrosDocumentoCompra()"/>
                                    <div class="input-group-append">
                                        <button class="btn btn-default" type="button" onclick="aplicarFiltrosDocumentoCompra()">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                        <button class="btn btn-secondary ml-2" type="button" onclick="generarReporteDocumentoCompra()">
                                            <i class="fas fa-file-alt"></i> Generar Reporte
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="tablaDocumentosCompraContainer" class="table-responsive">
                            <table id="documentosCompraTable" class="table table-bordered table-striped">
                                <thead>
                                <tr>
                                    <th>ID Compra</th>
                                    <th>Fecha Registro</th>
                                    <th>Proveedor</th>
                                    <th>Tipo Doc.</th>
                                    <th>N° Documento</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody id="documentosCompraTableBody">
                                <!-- ELIMINADO: La tabla ahora se renderiza completamente con JavaScript -->
                                <!-- <tr th:each="doc : ${documentosCompra}">...</tr> -->
                                <!-- <tr th:if="${#lists.isEmpty(documentosCompra)}">...</tr> -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="documentoCompraModal" tabindex="-1" role="dialog" aria-labelledby="documentoCompraModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content" id="modalFormContent">
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewDocumentoCompraModal" tabindex="-1" role="dialog" aria-labelledby="viewDocumentoCompraModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" id="modalViewContent">
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirmar Cancelar Documento de Compra</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeDeleteConfirmModal()">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    ¿Estás seguro de que quieres cancelar este documento de compra? Esta acción no se puede revertir.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closeDeleteConfirmModal()">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="reporteDocumentosCompraModal" tabindex="-1" role="dialog" aria-labelledby="reporteDocumentosCompraModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div id="modalReporteContentDocumentoCompra">
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/

        // Variables globales para los datos iniciales y el contador de detalles
        let allDocumentosCompra = []; // Inicializar como array vacío, siempre se cargará por AJAX
        let allProductosData = /*[[${productos}]]*/ []; // Pasados desde el controlador
        let allProveedoresData = /*[[${proveedores}]]*/ []; // Pasados desde el controlador

        // Elementos del DOM del modal principal
        const documentoCompraModalElement = $('#documentoCompraModal'); // Usando jQuery para el modal Bootstrap
        const viewDocumentoCompraModalElement = $('#viewDocumentoCompraModal'); // Nuevo modal para visualizar
        const deleteConfirmModalElement = $('#deleteConfirmModal'); // Usando jQuery
        const modalFormContent = document.getElementById('modalFormContent');
        const modalViewContent = document.getElementById('modalViewContent'); // Contenido para el modal de visualización

        let detalleCount = 0; // Contador para generar IDs únicos para los detalles
        let documentIdToDelete = null; // ID del documento a eliminar

        // ===============================================
        // FUNCIONES DE UTILIDAD (NOTIFICACIONES, ERRORES)
        // ===============================================

        function showNotification(type, message) {
            Swal.fire({
                icon: type, // 'success', 'error', 'warning', 'info', 'question'
                title: type.charAt(0).toUpperCase() + type.slice(1), // Capitalizar el tipo
                text: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                customClass: {
                    container: 'swal2-container-custom' // Para posibles estilos CSS personalizados si se requieren
                }
            });
        }

        function clearErrors() {
            // Solo buscar errores dentro del modal activo para evitar limpiar la tabla principal
            const currentForm = document.getElementById('documentoCompraForm');
            if (currentForm) {
                currentForm.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
                currentForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            }
        }

        function displayError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                let inputElement = null;
                // Buscar el input o select asociado, ya sea hermano anterior o dentro del mismo form-group
                if (errorElement.previousElementSibling &&
                   (errorElement.previousElementSibling.tagName === 'INPUT' ||
                    errorElement.previousElementSibling.tagName === 'SELECT')) {
                    inputElement = errorElement.previousElementSibling;
                } else {
                    const parentDiv = errorElement.closest('.form-group'); // Buscar el contenedor de form-group
                    if (parentDiv) {
                        inputElement = parentDiv.querySelector('input, select');
                    }
                }

                if (inputElement) {
                    inputElement.classList.add('is-invalid');
                }
            }
        }

        // ===============================================
        // LÓGICA DE LA TABLA PRINCIPAL
        // ===============================================

        // (Esta función es principalmente para la carga inicial y recargas)
        function renderMainTable(documentsToDisplay) {
            const tableBody = document.getElementById('documentosCompraTableBody');
            if (!tableBody) { // Agrega esta validación por si acaso
                console.error("Error: Elemento 'documentosCompraTableBody' no encontrado.");
                return;
            }
            tableBody.innerHTML = ''; // Limpiar la tabla

            if (documentsToDisplay.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay documentos de compra registrados.</td></tr>';
                return;
            }

            documentsToDisplay.forEach(doc => {
                const row = document.createElement('tr');
                const fechaFormatted = doc.fechaRegistro ? new Date(doc.fechaRegistro).toLocaleDateString('es-ES') : 'N/A';
                const totalFormatted = parseFloat(doc.total).toFixed(2);

                // *** CAMBIO CLAVE AQUÍ: Agregar clase condicionalmente basada en el estado ***
                // Asumiendo que doc.estado es un Byte (1 para activo, 0 para inactivo)
                const rowClass = (doc.estado !== null && doc.estado === 0) ? 'cancelled-item' : ''; // Usar 'cancelled-item'
                if (rowClass) {
                    row.classList.add(rowClass); // Aplica la clase si el estado es 0
                }

                // Lógica condicional para los botones de acción
                let actionButtonsHtml = '';
                if (doc.estado !== null && doc.estado === 0) {
                    // Documento cancelado: solo visualizar y botón deshabilitado
                    actionButtonsHtml = `
                        <button type="button" onclick="openViewModal(${doc.idCompra})"
                                class="btn btn-primary btn-sm">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm ml-1" disabled>
                            <i class="fas fa-ban"></i>
                        </button>
                    `;
                } else {
                    // Documento activo: visualizar y cancelar
                    actionButtonsHtml = `
                        <button type="button" onclick="openViewModal(${doc.idCompra})"
                                class="btn btn-primary btn-sm">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" onclick="confirmDelete(${doc.idCompra})"
                                class="btn btn-danger btn-sm ml-1">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    `;
                }


                row.innerHTML = `
                    <td>${doc.idCompra}</td>
                    <td>${fechaFormatted}</td>
                    <td>${doc.proveedor ? doc.proveedor.razonSocial : 'N/A'}</td>
                    <td>${doc.tipoDocumento}</td>
                    <td>${doc.numDocumento}</td>
                    <td>S/ ${totalFormatted}</td>
                    <td>
                        <div class="btn-group">
                            ${actionButtonsHtml}
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Función para recargar la lista de documentos de compra (llamada después de CRUD)
        window.recargarListaDocumentosCompraCompleta = function() { // Hacer global
            fetch('/documento-compra/all')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok for /documento-compra/all');
                    }
                    return response.json();
                })
                .then(data => {
                    allDocumentosCompra = data; // Actualizar la variable global
                    renderMainTable(allDocumentosCompra); // Volver a renderizar la tabla
                })
                .catch(error => {
                    console.error('Error al recargar la lista de documentos de compra:', error);
                    showNotification('error', 'Error al recargar la lista de documentos de compra.');
                });
        }

        // Función de filtro simplificada (puedes expandirla)
        function aplicarFiltrosDocumentoCompra() {
            const searchTermInput = document.getElementById('searchTermDocumentoCompra'); // Asegura que el input exista
            if (!searchTermInput) return; // Validación
            const searchTerm = searchTermInput.value.toLowerCase();
            const filteredDocs = allDocumentosCompra.filter(doc => {
                const proveedorMatch = doc.proveedor && doc.proveedor.razonSocial && doc.proveedor.razonSocial.toLowerCase().includes(searchTerm);
                const numDocMatch = doc.numDocumento && doc.numDocumento.toLowerCase().includes(searchTerm);
                return proveedorMatch || numDocMatch;
            });
            renderMainTable(filteredDocs);
        }

 // ===============================================
// FUNCIONES PARA EL REPORTE DE DOCUMENTOS DE COMPRA
// ===============================================

// Abre el modal de filtros del reporte de documentos de compra
function generarReporteDocumentoCompra() {
    console.log("Abriendo modal de reporte de documentos de compra...");
    $('#modalReporteContentDocumentoCompra').load('/documento-compra/reporte/modal', function(response, status, xhr) {
        if (status === "error") {
            console.error("Error al cargar el formulario de reporte de documentos de compra:", xhr.status, xhr.statusText, response);
            Swal.fire({
                icon: 'error',
                title: 'Error al cargar reporte',
                text: 'Hubo un problema al cargar el formulario de reporte. Por favor, inténtalo de nuevo.',
                footer: `Detalles: ${xhr.status} ${xhr.statusText}`
            });
        } else {
            console.log("Formulario de reporte de documentos de compra cargado exitosamente.");
            // Establecer las fechas máximas/mínimas para los campos de fecha
            setReportDateCompraMaxAttributes();
            setReportDateCompraMinAttributes();

            // *** CAMBIO CLAVE AQUÍ: Desmarcar "Activo" y "Cancelado" por defecto ***
            $('#estadoActivoCompra').prop('checked', false);
            $('#estadoInactivoCompra').prop('checked', false);

            $('#reporteDocumentosCompraModal').modal('show');
        }
    });
}

// Cierra el modal de reporte de documentos de compra
function cerrarReporteDocumentoCompraModal() {
    $('#reporteDocumentosCompraModal').modal('hide');
    setTimeout(() => {
        $('#modalReporteContentDocumentoCompra').empty();
    }, 300); // Pequeño delay para la animación del modal
}

// Limpia los filtros del modal de reporte de documentos de compra
function limpiarFiltrosReporteDocumentoCompra() {
    $('#formReporteDocumentoCompra')[0].reset();
    $('.estado-checkbox-compra').prop('checked', false); // Desmarcar ambos al limpiar
    setReportDateCompraMaxAttributes();
    setReportDateCompraMinAttributes();
}

// Función para ajustar el atributo 'max' de la fecha de inicio del reporte de compra
function setReportDateCompraMaxAttributes() {
    const today = new Date().toISOString().split('T')[0];
    $('#fechaRegistroStartCompra').attr('max', today);

    const fechaFin = $('#fechaRegistroEndCompra').val();
    if (fechaFin && $('#fechaRegistroStartCompra').val() && new Date(fechaFin) < new Date($('#fechaRegistroStartCompra').val())) {
        $('#fechaRegistroEndCompra').val($('#fechaRegistroStartCompra').val());
    }
    $('#fechaRegistroEndCompra').attr('min', $('#fechaRegistroStartCompra').val());
}

// Función para ajustar el atributo 'min' de la fecha de fin del reporte de compra
function setReportDateCompraMinAttributes() {
    const today = new Date().toISOString().split('T')[0];
    $('#fechaRegistroEndCompra').attr('max', today);

    const fechaInicio = $('#fechaRegistroStartCompra').val();
    if (fechaInicio && $('#fechaRegistroEndCompra').val() && new Date(fechaInicio) > new Date($('#fechaRegistroEndCompra').val())) {
        $('#fechaRegistroStartCompra').val($('#fechaRegistroEndCompra').val());
    }
    $('#fechaRegistroStartCompra').attr('max', $('#fechaRegistroEndCompra').val() || today);
}

// Ejecuta la generación del reporte PDF de documentos de compra
function ejecutarGenerarReporteDocumentoCompra() {
    Swal.fire({
        title: 'Generando Reporte...',
        text: 'Por favor, espera mientras se genera el PDF de documentos de compra.',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    const form = $('#formReporteDocumentoCompra');
    // Obtener los valores de los checkboxes de estado y crear un array
    const estadosSeleccionados = [];
    $('.estado-checkbox-compra:checked').each(function() {
        estadosSeleccionados.push($(this).val());
    });

    // Serializar el formulario y añadir los estados como un parámetro de consulta si hay alguno
    let formData = form.serialize();
    if (estadosSeleccionados.length > 0) {
        // Eliminar cualquier 'estados=' que haya generado el serialize() para manejarlo manualmente
        formData = formData.replace(/&estados=\d+/g, '');
        estadosSeleccionados.forEach(estado => {
            formData += '&estados=' + estado;
        });
    }

    const url = '/documento-compra/reporte/pdf?' + formData;

    setTimeout(() => {
        const newWindow = window.open(url, '_blank');
        if (newWindow) {
            Swal.close();
            showNotification("success", "El reporte PDF se está generando y debería abrirse en una nueva pestaña.");
            cerrarReporteDocumentoCompraModal();
        } else {
            Swal.close();
            showNotification("error", "Error: Tu navegador bloqueó la descarga del PDF. Por favor, permite los pop-ups para este sitio.");
        }
    }, 300); // Pequeño delay para asegurar que el modal de carga de Swal se muestre
}

        // ===============================================
        // LÓGICA DEL FORMULARIO MODAL (PARA DOCUMENTO DE COMPRA)
        // ===============================================

        function openFormModal(idCompra) {
            clearErrors(); // Limpiar errores antes de abrir el modal
            detalleCount = 0; // Resetear el contador de detalles cada vez que se abre el modal

            // Asegurar que solo se cargue el formulario de creación si idCompra es null
            // Si quieres que el botón "Registrar Nueva Compra" SIEMPRE abra para nueva, entonces:
            let url = '/documento-compra/nuevo'; // Solo para creación
            // Si necesitas edición en algún punto, tendrías que re-introducir la lógica:
            // let url = idCompra ? `/documento-compra/editar/${idCompra}` : '/documento-compra/nuevo';


            $.ajax({ // Usar jQuery AJAX para cargar el fragmento
                url: url,
                type: 'GET',
                success: function(html) {
                    modalFormContent.innerHTML = html; // Cargar el fragmento HTML en el modal
                    documentoCompraModalElement.modal('show'); // Mostrar el modal usando Bootstrap JS

                    // Re-adjuntar el manejador de envío del formulario después de que se cargue
                    const form = document.getElementById('documentoCompraForm');
                    if (form) {
                        form.onsubmit = function(event) {
                            event.preventDefault();
                            saveDocumentoCompra(form);
                        };
                    } else {
                        console.error("Formulario no encontrado en el modal.");
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al cargar el formulario:', error, xhr.responseText);
                    showNotification('error', 'No se pudo cargar el formulario. Inténtalo de nuevo.');
                }
            });
        }

        function closeFormModal() {
            documentoCompraModalElement.modal('hide'); // Ocultar el modal usando Bootstrap JS
            // Limpiar el contenido del modal después de que se haya ocultado completamente
            documentoCompraModalElement.on('hidden.bs.modal', function () {
                modalFormContent.innerHTML = '';
                documentoCompraModalElement.off('hidden.bs.modal'); // Remover el listener para evitar duplicados
            });
            clearErrors(); // Limpiar errores al cerrar
        }

        // ===============================================
        // LÓGICA DEL MODAL DE VISUALIZACIÓN
        // ===============================================

        function openViewModal(idCompra) {
            const url = `/documento-compra/ver/${idCompra}`;

            $.ajax({
                url: url,
                type: 'GET',
                success: function(html) {
                    modalViewContent.innerHTML = html; // Cargar el fragmento HTML en el modal de visualización
                    viewDocumentoCompraModalElement.modal('show'); // Mostrar el modal de visualización
                },
                error: function(xhr, status, error) {
                    console.error('Error al cargar los detalles del documento de compra:', error, xhr.responseText);
                    showNotification('error', 'No se pudo cargar los detalles. Inténtalo de nuevo.');
                }
            });
        }

        function closeViewModal() {
            viewDocumentoCompraModalElement.modal('hide');
            // Limpiar el contenido del modal después de que se haya ocultado completamente
            viewDocumentoCompraModalElement.on('hidden.bs.modal', function () {
                modalViewContent.innerHTML = '';
                viewDocumentoCompraModalElement.off('hidden.bs.modal'); // Remover el listener
            });
        }

        // ===============================================
        // LÓGICA DE DETALLES DE COMPRA EN EL FORMULARIO MODAL
        // (Estas funciones deben ser globales para ser accesibles desde el fragmento)
        // ===============================================

        // Esta función se llama desde el script dentro del fragmento del modal
        // para inicializar los detalles de compra y los productos.
        window.initializeModalDetails = function(modalProductos, modalDocumento) {
            // Asegurarse de que allProductosData se actualice con los productos pasados desde el controlador
            allProductosData = modalProductos;
            const detalleComprasContainer = document.getElementById('detalleComprasContainer');
            if (!detalleComprasContainer) {
                console.error("Error: 'detalleComprasContainer' no encontrado en el modal cargado.");
                return;
            }
            detalleComprasContainer.innerHTML = ''; // Limpiar detalles existentes

            if (modalDocumento && modalDocumento.detalleCompras && modalDocumento.detalleCompras.length > 0) {
                modalDocumento.detalleCompras.forEach(detalle => {
                    addDetalleCompra(detalle);
                });
            } else {
                addDetalleCompra(); // Añadir una fila vacía para nuevos documentos
            }
            calculateTotalGeneral();
        }

        window.addDetalleCompra = function(detalle = null) {
            const index = detalleCount++;
            const detalleDiv = document.createElement('tr'); // Cambiado a <tr> para compatibilidad con la tabla
            detalleDiv.classList.add('detalle-item'); // Mantener la clase para estilos y selección
            detalleDiv.setAttribute('data-index', index);
            detalleDiv.id = `detalleRow-${index}`; // Añadir un ID para la fila

            let productoOptions = allProductosData.map(p =>
                `<option value="${p.idProducto}" data-precio="${p.precioUnitario}" ${detalle && detalle.producto && detalle.producto.idProducto === p.idProducto ? 'selected' : ''}>
                    ${p.nombre} (Stock: ${p.stock})
                </option>`
            ).join('');

            const initialCantidad = detalle ? (detalle.cantidad || '') : '';
            const initialPrecioUnitario = detalle ? (parseFloat(detalle.precioUnitario).toFixed(2) || '') : ''; // Formatear a 2 decimales
            const initialTotalDetalle = detalle ? (parseFloat(detalle.total) || 0).toFixed(2) : '0.00';


            detalleDiv.innerHTML = `
                <td>
                    <input type="hidden" name="detalleCompras[${index}].idDetalleCompra" value="${detalle ? detalle.idDetalleCompra || '' : ''}">
                    <select name="detalleCompras[${index}].producto.idProducto" id="producto-${index}" required
                            class="form-control">
                        <option value="">Seleccione un Producto</option>
                        ${productoOptions}
                    </select>
                    <span class="text-danger" id="productoError-${index}"></span>
                </td>
                <td>
                    <input type="number" name="detalleCompras[${index}].cantidad" id="cantidad-${index}" placeholder="Cantidad" required min="1"
                           value="${initialCantidad}"
                           class="form-control">
                    <span class="text-danger" id="cantidadError-${index}"></span>
                </td>
                <td>
                    <input type="number" name="detalleCompras[${index}].precioUnitario" id="precioUnitario-${index}" placeholder="Precio Unitario" required min="0" step="0.01"
                           value="${initialPrecioUnitario}"
                           class="form-control">
                    <span class="text-danger" id="precioUnitarioError-${index}"></span>
                </td>
                <td>
                    <input type="text" class="form-control total-detalle-display bg-light" id="detalleTotalDisplay-${index}" value="${initialTotalDetalle}" readonly>
                </td>
                <td>
                    <button type="button" onclick="removeDetalleCompra(this)"
                            class="btn btn-danger btn-sm">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            const detalleComprasContainer = document.getElementById('detalleComprasContainer');
            detalleComprasContainer.appendChild(detalleDiv);

            // Adjuntar event listeners para la nueva fila
            const cantidadInput = document.getElementById(`cantidad-${index}`);
            const precioInput = document.getElementById(`precioUnitario-${index}`);
            const productoSelect = document.getElementById(`producto-${index}`);

            if (cantidadInput) cantidadInput.addEventListener('input', () => updateDetalleTotal(index));
            if (precioInput) precioInput.addEventListener('input', () => updateDetalleTotal(index));
            if (productoSelect) {
                productoSelect.addEventListener('change', () => {
                    const selectedProduct = allProductosData.find(p => p.idProducto == productoSelect.value);
                    if (selectedProduct) {
                        precioInput.value = parseFloat(selectedProduct.precioUnitario).toFixed(2);
                    }
                    updateDetalleTotal(index);
                });
            }

            // Si el precio unitario no se inicializó desde el detalle, intenta usar el del producto
            if (detalle && initialPrecioUnitario === '' && productoSelect && productoSelect.value) {
                const selectedProduct = allProductosData.find(p => p.idProducto == productoSelect.value);
                if (selectedProduct) {
                    precioInput.value = parseFloat(selectedProduct.precioUnitario).toFixed(2);
                }
            } else if (!detalle && productoSelect && productoSelect.value) { // Para nueva fila con producto pre-seleccionado
                 const selectedProduct = allProductosData.find(p => p.idProducto == productoSelect.value);
                 if (selectedProduct) {
                     precioInput.value = parseFloat(selectedProduct.precioUnitario).toFixed(2);
                 }
            }
            updateDetalleTotal(index);
        }

        window.removeDetalleCompra = function(button) {
            const detalleDiv = button.closest('tr.detalle-item'); // Seleccionar el <tr>
            if (detalleDiv) { // Agrega esta validación por si acaso
                detalleDiv.remove();
                calculateTotalGeneral();
            }
        }

        window.updateDetalleTotal = function(index) {
            const cantidadInput = document.getElementById(`cantidad-${index}`); // Asegura que existan
            const precioUnitarioInput = document.getElementById(`precioUnitario-${index}`); // Asegura que existan
            const totalDisplay = document.getElementById(`detalleTotalDisplay-${index}`); // Asegura que existan

            if (cantidadInput && precioUnitarioInput && totalDisplay) { // Validación de existencia
                const cantidad = parseFloat(cantidadInput.value) || 0;
                const precioUnitario = parseFloat(precioUnitarioInput.value) || 0;
                const totalDetalle = cantidad * precioUnitario;
                totalDisplay.value = totalDetalle.toFixed(2); // Usar .value para inputs
                calculateTotalGeneral();
            }
        }

        window.calculateTotalGeneral = function() {
            let totalGeneral = 0;
            document.querySelectorAll('.detalle-item').forEach(detalleDiv => {
                const totalDisplay = detalleDiv.querySelector('.total-detalle-display');
                if (totalDisplay) { // Validación de existencia
                    // Para inputs, leer el valor con .value
                    const totalValue = parseFloat(totalDisplay.value) || 0;
                    totalGeneral += totalValue;
                }
            });
            const totalGeneralDisplay = document.getElementById('totalGeneralDisplay'); // Asegura que exista
            if (totalGeneralDisplay) { // Validación de existencia
                totalGeneralDisplay.value = totalGeneral.toFixed(2); // Usar .value para inputs
            }
        }

        // ===============================================
        // VALIDACIÓN DEL FORMULARIO
        // ===============================================

        async function validateForm() {
            clearErrors();
            let isValid = true;

            // Validar campos principales
            const tipoDocumentoInput = document.getElementById('tipoDocumento');
            if (tipoDocumentoInput && !tipoDocumentoInput.value) { // Agregado null check
                displayError('tipoDocumentoError', 'El tipo de documento es obligatorio.');
                tipoDocumentoInput.classList.add('is-invalid');
                isValid = false;
            } else if (tipoDocumentoInput) { // Solo remueve si existe
                tipoDocumentoInput.classList.remove('is-invalid');
            }

            const numDocumentoInput = document.getElementById('numDocumento');
            if (numDocumentoInput && !numDocumentoInput.value.trim()) { // Agregado null check
                displayError('numDocumentoError', 'El número de documento es obligatorio.');
                numDocumentoInput.classList.add('is-invalid');
                isValid = false;
            } else if (numDocumentoInput) { // Solo remueve si existe
                numDocumentoInput.classList.remove('is-invalid');
            }

            const proveedorSelect = document.getElementById('proveedorSelect');
            if (proveedorSelect && !proveedorSelect.value) { // Agregado null check
                displayError('proveedorSelectError', 'Debe seleccionar un proveedor.');
                provelectSelect.classList.add('is-invalid');
                isValid = false;
            } else if (proveedorSelect) { // Solo remueve si existe
                proveedorSelect.classList.remove('is-invalid');
            }


            // Validar detalles de compra
            const detalleRows = document.querySelectorAll('.detalle-item');
            if (detalleRows.length === 0) {
                showNotification('error', 'Debe añadir al menos un producto a la compra.');
                isValid = false;
            }

            for (const row of detalleRows) {
                const index = row.getAttribute('data-index');

                const productoSelect = document.getElementById(`producto-${index}`);
                const cantidadInput = document.getElementById(`cantidad-${index}`);
                const precioUnitarioInput = document.getElementById(`precioUnitario-${index}`);

                // Agregadas validaciones de existencia antes de acceder a .value o .classList
                if (productoSelect && !productoSelect.value) {
                    displayError(`productoError-${index}`, 'Seleccione un producto.');
                    productoSelect.classList.add('is-invalid');
                    isValid = false;
                } else if (productoSelect) {
                    productoSelect.classList.remove('is-invalid');
                }

                const cantidad = parseFloat(cantidadInput ? cantidadInput.value : ''); // Usar null-check y valor vacío
                if (cantidadInput && (isNaN(cantidad) || cantidad <= 0)) {
                    displayError(`cantidadError-${index}`, 'Cantidad > 0.');
                    cantidadInput.classList.add('is-invalid');
                    isValid = false;
                } else if (cantidadInput) {
                    cantidadInput.classList.remove('is-invalid');
                }

                const precio = parseFloat(precioUnitarioInput ? precioUnitarioInput.value : ''); // Usar null-check y valor vacío
                if (precioUnitarioInput && (isNaN(precio) || precio < 0)) {
                    displayError(`precioUnitarioError-${index}`, 'Precio >= 0.');
                    precioUnitarioInput.classList.add('is-invalid');
                    isValid = false;
                } else if (precioUnitarioInput) {
                    precioUnitarioInput.classList.remove('is-invalid');
                }
            }

            return isValid;
        }

        // ===============================================
        // LÓGICA DE GUARDADO DEL DOCUMENTO DE COMPRA
        // ===============================================

        async function saveDocumentoCompra(form) { // Convertido a async
            if (!(await validateForm())) { // Esperar la validación
                return;
            }

            const idCompra = document.getElementById('idCompra') ? document.getElementById('idCompra').value : null; // Añadido null check
            const fechaRegistro = document.getElementById('fechaRegistro') ? document.getElementById('fechaRegistro').value : ''; // Añadido null check
            const idProveedor = document.getElementById('proveedorSelect') ? document.getElementById('proveedorSelect').value : null; // Añadido null check
            const tipoDocumento = document.getElementById('tipoDocumento') ? document.getElementById('tipoDocumento').value : ''; // Añadido null check
            const numDocumento = document.getElementById('numDocumento') ? document.getElementById('numDocumento').value : ''; // Añadido null check
            const totalElement = document.getElementById('totalGeneralDisplay'); // Obtener elemento antes
            const total = totalElement ? parseFloat(totalElement.value) : 0; // Añadido null check y parseFloat

            const detallesCompras = [];
            document.querySelectorAll('.detalle-item').forEach(detalleDiv => {
                const index = detalleDiv.getAttribute('data-index');
                // Añadidos null checks y parseInt/parseFloat para asegurar tipos correctos
                const currentIdDetalleCompra = detalleDiv.querySelector(`input[name="detalleCompras[${index}].idDetalleCompra"]`).value;
                detallesCompras.push({
                    idDetalleCompra: (currentIdDetalleCompra && currentIdDetalleCompra.trim() !== '') ? parseInt(currentIdDetalleCompra) : null,
                    producto: { idProducto: parseInt(detalleDiv.querySelector(`#producto-${index}`).value) },
                    cantidad: parseInt(detalleDiv.querySelector(`#cantidad-${index}`).value),
                    precioUnitario: parseFloat(detalleDiv.querySelector(`#precioUnitario-${index}`).value),
                    total: parseFloat(detalleDiv.querySelector(`#detalleTotalDisplay-${index}`).value)
                });
            });

            const data = {
                idCompra: idCompra ? parseInt(idCompra) : null,
                fechaRegistro: fechaRegistro,
                proveedor: { idProveedor: idProveedor ? parseInt(idProveedor) : null },
                tipoDocumento: tipoDocumento,
                numDocumento: numDocumento,
                total: total,
                detalleCompras: detallesCompras
            };

            const url = '/documento-compra/guardar';

            try {
                const response = await fetch(url, { // Usar await
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                if (!response.ok) {
                    const errorData = await response.json(); // Usar await
                    throw new Error(errorData.message || 'Error al guardar el documento de compra.');
                }
                const resultData = await response.json(); // Usar await
                showNotification('success', resultData.message);
                closeFormModal();
                recargarListaDocumentosCompraCompleta(); // Recargar la tabla principal
            } catch (error) {
                console.error('Error:', error);
                showNotification('error', error.message || 'Ocurrió un error inesperado al guardar.');
            }
        }


        // ===============================================
        // LÓGICA DE CANCELACIÓN (Eliminar)
        // ===============================================

        window.confirmDelete = function(id) { // Hacer global para que el onclick funcione
            documentIdToDelete = id;
            deleteConfirmModalElement.modal('show'); // Mostrar el modal de confirmación
        }

        window.closeDeleteConfirmModal = function() { // Hacer global
            deleteConfirmModalElement.modal('hide');
            documentIdToDelete = null;
        }

        // Se usa 'click' porque es un botón en el modal de confirmación, no en la tabla principal
        document.getElementById('confirmDeleteButton').addEventListener('click', function() {
            if (documentIdToDelete) {
                fetch(`/documento-compra/eliminar/${documentIdToDelete}`) // Asumiendo que 'eliminar' cambia el estado a inactivo
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.message || 'Error al cancelar el documento de compra.'); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        showNotification('success', data.message);
                        closeDeleteConfirmModal(); // Cerrar el modal y resetear ID
                        recargarListaDocumentosCompraCompleta(); // Recargar para mostrar el estado actualizado
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('error', error.message || 'Ocurrió un error al cancelar.');
                    });
            }
        });

        // ===============================================
        // INICIALIZACIÓN
        // ===============================================

        // Usa $(document).ready para asegurar que el DOM esté completamente cargado
        // Esto reemplaza document.addEventListener('DOMContentLoaded', ...) si ya usas jQuery.
        $(document).ready(function() {
            // Asegúrate de que esta sea la ÚNICA llamada a recargarListaDocumentosCompraCompleta() al cargar la página
            recargarListaDocumentosCompraCompleta();
        });

        /*]]>*/
    </script>
</section>
</body>
</html>
