<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <title layout:fragment="title">Gestión de Productos</title>
</head>
<section layout:fragment="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Lista de Productos</h3>
            <div class="card-tools">
              <a href="javascript:void(0)" onclick="abrirFormularioProducto('/productos/nuevo')"
                 class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                <i class="fas fa-plus"></i> Crear Nuevo Producto
              </a>
            </div>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <button class="btn btn-info" type="button" data-toggle="collapse" data-target="#collapseProductFilters" aria-expanded="false" aria-controls="collapseProductFilters">
                <i class="fas fa-filter"></i> Mostrar/Ocultar Filtros Avanzados
              </button>
            </div>

            <div class="collapse" id="collapseProductFilters">
              <div class="card card-body">
                <form id="mainProductFilterForm" onsubmit="event.preventDefault(); aplicarFiltrosProductos();">
                  <div class="form-row">
                    <div class="form-group col-md-4">
                      <label for="filtroNombreProductoMain">Nombre:</label>
                      <input type="text" id="filtroNombreProductoMain" name="nombre" class="form-control" placeholder="Nombre del producto"/>
                    </div>
                    <div class="form-group col-md-4">
                      <label for="filtroDescripcionProductoMain">Presentación:</label>
                      <input type="text" id="filtroDescripcionProductoMain" name="descripcion" class="form-control" placeholder="Presentación del producto"/>
                    </div>
                    <div class="form-group col-md-4">
                      <label for="filtroIdCategoriaProductoMain">Categoría:</label>
                      <select id="filtroIdCategoriaProductoMain" name="idCategoria" class="form-control">
                        <option value="">Todas las Categorías</option>
                      </select>
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group col-md-3">
                      <label>Precio 1 (Min/Max):</label>
                      <div class="input-group">
                        <input type="number" step="0.01" id="precio1MinMain" name="precio1Min" class="form-control" placeholder="Min">
                        <input type="number" step="0.01" id="precio1MaxMain" name="precio1Max" class="form-control" placeholder="Max">
                      </div>
                    </div>
                    <div class="form-group col-md-3">
                      <label>Precio 2 (Min/Max):</label>
                      <div class="input-group">
                        <input type="number" step="0.01" id="precio2MinMain" name="precio2Min" class="form-control" placeholder="Min">
                        <input type="number" step="0.01" id="precio2MaxMain" name="precio2Max" class="form-control" placeholder="Max">
                      </div>
                    </div>
                    <div class="form-group col-md-3">
                      <label>Stock (Min/Max):</label>
                      <div class="input-group">
                        <input type="number" id="stockMinMain" name="stockMin" class="form-control" placeholder="Min">
                        <input type="number" id="stockMaxMain" name="stockMax" class="form-control" placeholder="Max">
                      </div>
                    </div>
                    <div class="form-group col-md-3">
                      <label>Estado:</label><br>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input estado-checkbox-producto-main" type="checkbox" id="estadoActivoProductoMain" name="estados" value="1">
                        <label class="form-check-label" for="estadoActivoProductoMain">Activo</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input estado-checkbox-producto-main" type="checkbox" id="estadoInactivoProductoMain" name="estados" value="0">
                        <label class="form-check-label" for="estadoInactivoProductoMain">Inactivo</label>
                      </div>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label>Fecha de Registro:</label>
                      <div class="input-group">
                        <input type="date" id="fechaRegistroStartMain" name="fechaRegistroStart" class="form-control" onchange="setMainDateMaxAttributes()">
                        <input type="date" id="fechaRegistroEndMain" name="fechaRegistroEnd" class="form-control" onchange="setMainDateMinAttributes()">
                      </div>
                    </div>
                  </div>

                  <div class="form-group">
                    <button class="btn btn-default" type="submit">
                      <i class="fas fa-search"></i> Buscar
                    </button>
                    <button class="btn btn-success ml-2" type="button" onclick="ejecutarGenerarReporteProductos()"
                            style="background-color:#b45f06 !important; border-color:#b45f06 !important;">
                      <i class="fas fa-file-pdf"></i> Generar Reporte PDF
                    </button>
                    <button class="btn btn-secondary ml-2" type="button" onclick="limpiarFiltrosMainProducto()">
                      <i class="fas fa-redo"></i> Limpiar Filtros
                    </button>
                  </div>
                </form>
                <div class="alert alert-info text-center mt-3" role="alert">
                  <i class="fas fa-info-circle"></i> Deje todas las opciones de filtro sin marcar para buscar/generar un reporte de todos los productos.
                </div>
              </div>
            </div>
            <div id="tablaProductosContainer" class="mt-3"> <table id="productosTable" class="table table-bordered table-striped">
              <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Presentación</th>
                <th>Categoría</th>
                <th>Precio 1</th>
                <th>Precio 2</th>
                <th>Stock</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
              </thead>
              <tbody id="productosTableBody">
              </tbody>
            </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="productoModal" tabindex="-1" role="dialog" aria-labelledby="productoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div id="modalFormContentProducto">
        </div>
      </div>
    </div>
  </div>
</section>

<th:block layout:fragment="scripts">
  <script th:inline="javascript">
    /*<![CDATA[*/

    allProducts = []; 

    function renderizarTablaProductos(productsToDisplay) {
        const tableBody = $('#productosTableBody');
        tableBody.empty();

        if (productsToDisplay.length === 0) {
            tableBody.append('<tr><td colspan="9" class="text-center">No se encontraron productos.</td></tr>');
            return;
        }

        productsToDisplay.forEach(producto => {
            const estadoText = producto.estado === 1 ? 'Activo' : 'Inactivo';
            const estadoClass = producto.estado === 1 ? 'badge badge-success badge-pill' : 'badge badge-danger badge-pill';
            const categoriaNombre = producto.categoria ? producto.categoria.nombreCategoria : 'N/A';

            const row = `
                <tr>
                    <td>${producto.idProducto}</td>
                    <td>${producto.nombre}</td>
                    <td>${producto.descripcion}</td>
                    <td>${categoriaNombre}</td>
                    <td>${producto.precio1 ? producto.precio1.toFixed(2) : 'N/A'}</td>
                    <td>${producto.precio2 ? producto.precio2.toFixed(2) : 'N/A'}</td>
                    <td>${producto.stock}</td>
                    <td class="text-center"><span class="${estadoClass}">${estadoText}</span></td>
                    <td>
                        <a href="javascript:void(0)" onclick="abrirFormularioProducto('/productos/editar/${producto.idProducto}')"
                           class="btn btn-info btn-sm">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="javascript:void(0)" onclick="confirmarEliminarProducto(${producto.idProducto})"
                           class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>
            `;
            tableBody.append(row);
        });
    }

    function clearErrors(container) {
        const $c = (container instanceof HTMLElement)
            ? $(container)
            : $(container);
        $c.find('.text-danger').text('');
        $c.find('.is-invalid').removeClass('is-invalid');
    }

    function displayError(elementId, message) {
        $('#' + elementId).text(message);
        $('#' + elementId).prevAll('.form-control, .input-group').first().find('input, select').first().addClass('is-invalid');
    }


    // ===========================================
    // MANEJADORES DE EVENTOS DEL MODAL Y FORMULARIO DE PRODUCTO
    // ===========================================

    function abrirFormularioProducto(url) {
        console.log("Intentando abrir formulario de producto desde URL:", url);
        $('#modalFormContentProducto').load(url, function(response, status, xhr) {
            if (status === "error") {
                console.error("Error al cargar el formulario de producto:", xhr.status, xhr.statusText, response);
                Swal.fire({
                    icon: 'error',
                    title: 'Error al cargar formulario',
                    text: 'Hubo un problema al cargar el formulario. Por favor, inténtalo de nuevo.',
                    footer: `Detalles: ${xhr.status} ${xhr.statusText}`
                });
                return;
            }

            console.log("Formulario de producto cargado exitosamente.");

            clearErrors('#formProducto');

            $('#formProducto')
                .off('submit')
                .on('submit', async function(e) {
                    e.preventDefault();
                    const formIsValid = await validarFormularioProducto();
                    if (formIsValid) {
                        guardarProductoAjax($(this));
                    } else {
                        console.log("Formulario de producto inválido. No se envía.");
                        mostrarNotificacion("error", "Por favor, corrige los errores en el formulario.");
                    }
                });

            $('#productoModal').modal('show');
            console.log("Modal de producto intentando mostrarse.");
        });
    }

    function cerrarFormularioProducto() {
        $('#productoModal').modal('hide');
        $('#modalFormContentProducto').empty();
        clearErrors('#formProducto');
        console.log("Modal de producto cerrado.");
    }

    function guardarProductoAjax(formElement) {
        let formData = formElement.serialize();
        let url = formElement.attr('action');

        $.ajax({
            type: "POST",
            url: url,
            data: formData,
            success: function(response) {
                if (response.status === "success") {
                    mostrarNotificacion("success", response.message);
                    cerrarFormularioProducto();
                    aplicarFiltrosProductos();
                } else {
                    if (response.errors) {
                        // Parsea la cadena JSON de errores si viene como string
                        const errors = JSON.parse(response.errors);
                        for (const [key, value] of Object.entries(errors)) {
                            displayError(key + 'Error', value);
                        }
                    }
                    mostrarNotificacion("error", "Error: " + response.message);
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = "Error al procesar la solicitud.";
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage += ": " + xhr.responseJSON.message;
                } else if (xhr.responseText) {
                    errorMessage += ": " + xhr.responseText.substring(0, 100) + "...";
                }
                mostrarNotificacion("error", errorMessage);
                console.error("Error AJAX al guardar producto:", error, xhr.responseText);
            }
        });
    }

    function confirmarEliminarProducto(id) {
        Swal.fire({
            title: '¿Estás seguro?',
            text: "¡No podrás revertir esto!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                console.log("Eliminando producto con ID:", id);
                $.ajax({
                    type: "GET",
                    url: '/productos/eliminar/' + id,
                    success: function(response) {
                        if (response.status === "success") {
                            mostrarNotificacion("success", response.message);
                            aplicarFiltrosProductos();
                        } else {
                            mostrarNotificacion("error", "Error: " + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = "Error al eliminar el producto.";
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage += ": " + xhr.responseJSON.message;
                        } else if (xhr.responseText) {
                            errorMessage += ": " + xhr.responseText.substring(0, 100) + "...";
                        }
                        mostrarNotificacion("error", errorMessage);
                        console.error("Error AJAX al eliminar producto:", error, xhr.responseText);
                    }
                });
            }
        });
    }

    // ===========================================
    // FUNCIONES DE FILTRADO Y REPORTE DE PRODUCTOS (SERVER-SIDE)
    // ===========================================

    function aplicarFiltrosProductos() {
        const filterDTO = {
            nombre: $('#filtroNombreProductoMain').val(),
            descripcion: $('#filtroDescripcionProductoMain').val(),
            idCategoria: $('#filtroIdCategoriaProductoMain').val() === "" ? null : parseInt($('#filtroIdCategoriaProductoMain').val()),
            precio1Min: $('#precio1MinMain').val() === "" ? null : parseFloat($('#precio1MinMain').val()),
            precio1Max: $('#precio1MaxMain').val() === "" ? null : parseFloat($('#precio1MaxMain').val()),
            precio2Min: $('#precio2MinMain').val() === "" ? null : parseFloat($('#precio2MinMain').val()),
            precio2Max: $('#precio2MaxMain').val() === "" ? null : parseFloat($('#precio2MaxMain').val()),
            stockMin: $('#stockMinMain').val() === "" ? null : parseInt($('#stockMinMain').val()),
            stockMax: $('#stockMaxMain').val() === "" ? null : parseInt($('#stockMaxMain').val()),
            estados: [],
            fechaRegistroStart: $('#fechaRegistroStartMain').val() === "" ? null : $('#fechaRegistroStartMain').val(),
            fechaRegistroEnd: $('#fechaRegistroEndMain').val() === "" ? null : $('#fechaRegistroEndMain').val()
        };

        $('.estado-checkbox-producto-main:checked').each(function() {
            filterDTO.estados.push(parseInt($(this).val()));
        });

        const queryString = $.param(filterDTO);
        const url = '/productos/buscar?' + queryString;

        $.ajax({
            type: "GET",
            url: url,
            dataType: "json",
            success: function(response) {
                renderizarTablaProductos(response);
            },
            error: function(xhr, status, error) {
                console.error("Error al buscar productos con filtros:", error, xhr.responseText);
                mostrarNotificacion("error", "Error al buscar productos. Intenta de nuevo.");
            }
        });
    }

    function ejecutarGenerarReporteProductos() {
        Swal.fire({
            title: 'Generando Reporte...',
            text: 'Por favor, espera mientras se genera el PDF.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const filterDTO = {
            nombre: $('#filtroNombreProductoMain').val(),
            descripcion: $('#filtroDescripcionProductoMain').val(),
            idCategoria: $('#filtroIdCategoriaProductoMain').val() === "" ? null : parseInt($('#filtroIdCategoriaProductoMain').val()),
            precio1Min: $('#precio1MinMain').val() === "" ? null : parseFloat($('#precio1MinMain').val()),
            precio1Max: $('#precio1MaxMain').val() === "" ? null : parseFloat($('#precio1MaxMain').val()),
            precio2Min: $('#precio2MinMain').val() === "" ? null : parseFloat($('#precio2MinMain').val()),
            precio2Max: $('#precio2MaxMain').val() === "" ? null : parseFloat($('#precio2MaxMain').val()),
            stockMin: $('#stockMinMain').val() === "" ? null : parseInt($('#stockMinMain').val()),
            stockMax: $('#stockMaxMain').val() === "" ? null : parseInt($('#stockMaxMain').val()),
            estados: [],
            fechaRegistroStart: $('#fechaRegistroStartMain').val() === "" ? null : $('#fechaRegistroStartMain').val(),
            fechaRegistroEnd: $('#fechaRegistroEndMain').val() === "" ? null : $('#fechaRegistroEndMain').val()
        };

        $('.estado-checkbox-producto-main:checked').each(function() {
            filterDTO.estados.push(parseInt($(this).val()));
        });

        const queryString = $.param(filterDTO);
        const url = '/productos/reporte/pdf?' + queryString;

        setTimeout(() => {
            const newWindow = window.open(url, '_blank');
            if (newWindow) {
                Swal.close();
                mostrarNotificacion("success", "El reporte PDF se está generando y debería abrirse en una nueva pestaña.");
            } else {
                Swal.close();
                mostrarNotificacion("error", "Error: Tu navegador bloqueó la apertura del PDF. Por favor, permite los pop-ups para este sitio.");
            }
        }, 300);
    }

    function limpiarFiltrosMainProducto() {
        $('#mainProductFilterForm')[0].reset();
        $('.estado-checkbox-producto-main').prop('checked', false);
        $('#filtroIdCategoriaProductoMain').val('');
        setMainDateMaxAttributes();
        setMainDateMinAttributes();
        aplicarFiltrosProductos();
    }

    function cargarCategoriasEnFiltro() {
        $.ajax({
            type: "GET",
            url: '/categorias/all',
            dataType: "json",
            success: function(categorias) {
                const select = $('#filtroIdCategoriaProductoMain');
                select.empty();
                select.append('<option value="">Todas las Categorías</option>');
                categorias.forEach(categoria => {
                    if (categoria.estado === 1) { // Mostrar solo categorías activas
                        select.append(`<option value="${categoria.idCategoria}">${categoria.nombreCategoria}</option>`);
                    }
                });
            },
            error: function(xhr, status, error) {
                console.error("Error al cargar categorías para el filtro de productos:", error);
            }
        });
    }

    function setMainDateMaxAttributes() {
        const today = new Date().toISOString().split('T')[0];
        $('#fechaRegistroStartMain').attr('max', today);

        const fechaFin = $('#fechaRegistroEndMain').val();
        if (fechaFin && $('#fechaRegistroStartMain').val() && new Date(fechaFin) < new Date($('#fechaRegistroStartMain').val())) {
            $('#fechaRegistroEndMain').val($('#fechaRegistroStartMain').val());
        }
        $('#fechaRegistroEndMain').attr('min', $('#fechaRegistroStartMain').val());
    }

    function setMainDateMinAttributes() {
        const today = new Date().toISOString().split('T')[0];
        $('#fechaRegistroEndMain').attr('max', today);

        const fechaInicio = $('#fechaRegistroStartMain').val();
        if (fechaInicio && $('#fechaRegistroEndMain').val() && new Date(fechaInicio) > new Date($('#fechaRegistroEndMain').val())) {
            $('#fechaRegistroStartMain').val($('#fechaRegistroEndMain').val());
        }
        $('#fechaRegistroStartMain').attr('max', $('#fechaRegistroEndMain').val() || today);
    }

    function mostrarNotificacion(type, message) {
        $(document).Toasts('create', {
            class: type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-info' : 'bg-danger'),
            title: type === 'success' ? 'Éxito' : (type === 'info' ? 'Información' : 'Error'),
            body: message,
            autohide: true,
            delay: 3000
        });
    }

    $(document).ready(function() {
        cargarCategoriasEnFiltro();
        setMainDateMaxAttributes();
        setMainDateMinAttributes();
        aplicarFiltrosProductos();
    });

    /*]]>*/
  </script>
</th:block>
</html>
