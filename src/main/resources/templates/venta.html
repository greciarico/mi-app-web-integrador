<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Ventas</title>
    <!-- Incluye CSS AdminLTE y dependencias -->
    <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css"/>
    <link rel="stylesheet" href="/dist/css/adminlte.min.css"/>
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- SweetAlert2 para notificaciones -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jQuery y Bootstrap Bundle (necesarios para AdminLTE) -->
    <script src="/plugins/jquery/jquery.min.js"></script>
    <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App JS -->
    <script src="/dist/js/adminlte.min.js"></script>
    <!-- Select2 JS (después de jQuery) -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        /* Estilos generales para los modales Bootstrap/AdminLTE */
        .modal-xl {
            max-width: 900px; /* Ancho para el modal de venta */
        }
        .bg-light {
            background-color: #f8f9fa !important; /* Color para campos readonly */
        }
        .form-control-static {
            padding-top: .5rem;
            padding-bottom: .5rem;
            margin-bottom: 0;
            line-height: 1.25;
        }
        /* Nuevo estilo para filas de ventas canceladas */
        .cancelled-sale {
            background-color: #f8d7da !important; /* Rojo claro para indicar cancelación */
            color: #721c24 !important; /* Texto oscuro para contraste */
        }
        .cancelled-sale a, .cancelled-sale button {
            color: #721c24 !important; /* Asegura que los enlaces y botones también se vean afectados */
        }
    </style>
</head>
<body class="hold-transition sidebar-mini">
<section th:fragment="contenido" class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Ventas</h3>
                        <div class="card-tools">
                            <button type="button" onclick="openFormModal(null)"
                                    class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                                <i class="fas fa-plus"></i> Registrar Nueva Venta
                            </button>
                            <div class="input-group-append">
                                <!-- AQUI CAMBIAMOS LA LLAMADA DIRECTA -->
                                <button type="button" class="btn btn-outline-secondary" onclick="window.openClienteFormModal()">
                                    <i class="fas fa-plus"></i>Añadir Cliente
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body">
                        <!-- BUSCADOR SIMPLIFICADO -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="input-group">
                                    <input type="search" id="searchTermVenta" class="form-control" placeholder="Buscar por cliente, N° documento..."
                                           onkeyup="aplicarFiltrosVenta()"/>
                                    <div class="input-group-append">
                                        <button class="btn btn-default" type="button" onclick="aplicarFiltrosVenta()">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                        <button class="btn btn-secondary ml-2" type="button" onclick="generarReporteVenta()">
                                            <i class="fas fa-file-alt"></i> Generar Reporte
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- FIN BUSCADOR SIMPLIFICADO -->

                        <!-- Tabla de Ventas -->
                        <div id="tablaVentasContainer" class="table-responsive">
                            <table id="ventasTable" class="table table-bordered table-striped">
                                <thead>
                                <tr>
                                    <th>ID Venta</th>
                                    <th>Fecha Registro</th>
                                    <th>Cliente</th>
                                    <th>Usuario</th>
                                    <th>Tipo Doc.</th>
                                    <th>N° Documento</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody id="ventasTableBody">
                                <!-- Los datos se renderizarán aquí con JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- /.card-body -->
                </div>
                <!-- /.card -->
            </div>
            <!-- /.col -->
        </div>
        <!-- /.row -->
    </div>
    <!-- /.container-fluid -->

    <!-- Modal para el formulario/visualización de Venta (Cargado con el fragmento) -->
    <div class="modal fade" id="ventaModal" tabindex="-1" role="dialog" aria-labelledby="ventaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content" id="modalContentContainer">
                <!-- El contenido del formulario/visualización se carga aquí via AJAX -->
            </div>
        </div>
    </div>

    <!-- *************************************************************** -->
    <!-- MODAL PARA EL FORMULARIO DE CLIENTE - INICIO -->
    <!-- *************************************************************** -->
    <div class="modal fade" id="clienteFormModal" tabindex="-1" role="dialog" aria-labelledby="clienteFormModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" id="clienteFormModalContent">
                <!-- El contenido del formulario de cliente se cargará aquí con JS -->
            </div>
        </div>
    </div>
    <div class="modal fade" id="reporteVentasModal" tabindex="-1" role="dialog" aria-labelledby="reporteVentasModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div id="modalReporteContentVenta">
                </div>
            </div>
        </div>
    </div>
    <!-- SCRIPT PRINCIPAL CON TODA LA LÓGICA JAVASCRIPT -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        $(document).ready(function() {
            // Variables globales para este script
            let allVentas = /*[[${ventas}]]*/ [];
            let allProductosData = [];
            let allClientesData = []; // Esta variable será actualizada por el callback
            let allIgvData = [];
            const ventaModalElement = $('#ventaModal');
            const modalContentContainer = document.getElementById('modalContentContainer');

            // Referencia al modal de cliente para adjuntar eventos de cierre


            let detalleCount = 0;
            let modalIsTransitioning = false;

            // ===============================================
            // FUNCIONES DE UTILIDAD (NOTIFICACIONES, ERRORES)
            // ===============================================

            function showNotification(type, message) {
                Swal.fire({
                    icon: type,
                    title: type.charAt(0).toUpperCase() + type.slice(1),
                    text: message,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    customClass: {
                        container: 'swal2-container-custom'
                    }
                });
            }

            // Esta función limpia los errores en ambos formularios si están presentes
            function clearErrors() {
                const ventaForm = document.getElementById('ventaForm');
                const clienteForm = document.getElementById('clienteForm'); // ID del formulario de cliente

                if (ventaForm) {
                    ventaForm.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
                    ventaForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                }
                if (clienteForm) {
                    // Si el formulario de cliente se carga dinámicamente, esta parte limpia sus errores.
                    // Asegúrate de que el formulario cliente tenga el id="clienteForm"
                    clienteForm.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
                    clienteForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                }
            }


            function displayError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                if (errorElement) {
                    errorElement.textContent = message;
                    let inputElement = null;
                    if (errorElement.previousElementSibling &&
                       (errorElement.previousElementSibling.tagName === 'INPUT' ||
                        errorElement.previousElementSibling.tagName === 'SELECT')) {
                        inputElement = errorElement.previousElementSibling;
                    } else {
                        const parentDiv = errorElement.closest('.form-group');
                        if (parentDiv) {
                            inputElement = parentDiv.querySelector('input, select');
                        }
                    }
                    if (inputElement) {
                        inputElement.classList.add('is-invalid');
                    }
                }
            }

            // ===============================================
            // LÓGICA DE LA TABLA PRINCIPAL
            // ===============================================

            function getClientDisplayName(client) {
                if (!client) return 'N/A';
                if (client.razonSocial && client.razonSocial.trim() !== '') {
                    return client.razonSocial;
                }
                if (client.nombre && client.nombre.trim() !== '') {
                    let fullName = client.nombre.trim();
                    if (client.apPaterno && client.apPaterno.trim() !== '') fullName += ' ' + client.apPaterno.trim();
                    if (client.apMaterno && client.apMaterno.trim() !== '') fullName += ' ' + client.apMaterno.trim();
                    return fullName;
                }
                return 'Cliente Desconocido';
            }
        //la cambie para anular venta
          function renderMainTable(ventasToDisplay) {
                    const tableBody = document.getElementById('ventasTableBody');
                    if (!tableBody) {
                        return;
                    }
                    tableBody.innerHTML = '';
                    if (ventasToDisplay.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay ventas registradas.</td></tr>';
                        return;
                    }

                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // Establecer la hora a 00:00:00 para comparar solo la fecha

                    ventasToDisplay.forEach(venta => {
                        const rowClass = venta.estado === 0 ? 'cancelled-sale' : '';
                        const row = document.createElement('tr');
                        if (rowClass) {
                            row.classList.add(rowClass);
                        }

                        // --- INICIO DE LA CORRECCIÓN DE FECHA ---
                        let fechaFormatted = 'N/A';
                        let ventaDateForComparison; // Variable para la comparación de la fecha de anulación

                        if (venta.fechaRegistro) {
                            // Divide la cadena "YYYY-MM-DD" en componentes
                            const dateParts = venta.fechaRegistro.split('-'); // ["YYYY", "MM", "DD"]
                            const year = parseInt(dateParts[0]);
                            // Los meses en JavaScript son 0-indexados (0 para Enero, 11 para Diciembre)
                            const month = parseInt(dateParts[1]) - 1;
                            const day = parseInt(dateParts[2]);

                            // Crea un objeto Date en el huso horario local
                            const localDate = new Date(year, month, day);
                            fechaFormatted = localDate.toLocaleDateString('es-ES');

                            // También para la comparación: asegúrate de que sea la fecha correcta
                            ventaDateForComparison = new Date(year, month, day);
                            ventaDateForComparison.setHours(0, 0, 0, 0); // Limpiar la hora para la comparación
                        } else {
                            ventaDateForComparison = new Date(0); // Fecha por defecto si no hay fecha de registro (ej: 1970-01-01)
                        }
                        // --- FIN DE LA CORRECCIÓN DE FECHA ---

                        const totalFormatted = parseFloat(venta.total).toFixed(2);
                        const clientDisplayName = getClientDisplayName(venta.cliente);

                        // --- Lógica para deshabilitar botón de cancelar (usando ventaDateForComparison) ---
                        // Compara si la fecha de la venta (sin hora) es igual a la fecha de hoy (sin hora)
                        const isSameDay = ventaDateForComparison.getTime() === today.getTime();
                        const canCancel = venta.estado !== 0 && isSameDay; // Solo si no está cancelada y es del mismo día
                        // --- Fin de la lógica para deshabilitar botón ---

                        row.innerHTML = `
                            <td>${venta.idVenta}</td>
                            <td>${fechaFormatted}</td>
                            <td>${clientDisplayName}</td>
                            <td>${venta.usuario ? venta.usuario.nombre : 'N/A'}</td>
                            <td>${venta.tipoDocumento}</td>
                            <td>${venta.numDocumento}</td>
                            <td>S/ ${totalFormatted}</td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" onclick="openViewModal(${venta.idVenta})"
                                            class="btn btn-primary btn-sm">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="/ventas/comprobante/${venta.idVenta}" target="_blank"
                                       class="btn btn-info btn-sm ml-1">
                                        <i class="fas fa-file-invoice"></i> </a>
                                    ${canCancel ? `
                                    <button type="button" onclick="confirmCancelVenta(${venta.idVenta})"
                                            class="btn btn-danger btn-sm ml-1">
                                        <i class="fas fa-times-circle"></i>
                                    </button>
                                    ` : `
                                    <button type="button" class="btn btn-secondary btn-sm ml-1" disabled title="${venta.estado === 0 ? 'Venta ya cancelada' : 'Solo se pueden anular ventas del día actual.'}">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                    `}
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }

            window.recargarListaVentasCompleta = function() {
                Promise.all([
                    fetch('/ventas/all')
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok for /ventas/all');
                            return response.json();
                        })
                        .then(data => { allVentas = data; }),

                    fetch('/productos/activos')
                        .then(r => {
                          if (!r.ok) throw new Error('Error al cargar productos activos');
                          return r.json();
                        })
                        .then(data => { allProductosData = data; }),


                    // Actualizamos allClientesData desde el backend
                   fetch('/clientes/activos')
                      .then(r => {
                        if (!r.ok) throw new Error('Error al cargar clientes activos');
                        return r.json();
                      })
                      .then(data =>  {
                            allClientesData = data;
                            // También actualizamos el Select2 si el modal de ventas está abierto
                            const clienteSelectInModal = $('#modalContentContainer #clienteSelect');
                            if (clienteSelectInModal.length && clienteSelectInModal.data('select2')) {
                                clienteSelectInModal.empty(); // Limpiar opciones existentes
                                clienteSelectInModal.append('<option value="">-- Seleccione un Cliente --</option>');
                                allClientesData.forEach(cliente => {
                                    const displayName = getClientDisplayName(cliente);
                                    clienteSelectInModal.append(`<option value="${cliente.idCliente}">${displayName}</option>`);
                                });
                                // Mantiene la selección actual si es posible, o limpia
                                clienteSelectInModal.trigger('change');
                            }
                        }),

                    // dentro de recargarListaVentasCompleta():
                fetch('/tasa/activos')
                  .then(r => {
                    if (!r.ok) throw new Error('Error al cargar tasas activas');
                    return r.json();
                  })
                  .then(data => {
                    console.log("IGV activos desde servidor: ", data );
                    allIgvData = data;
                  })
                  .catch(err => showNotification('error', err.message)),

                ]).then(() => {
                    renderMainTable(allVentas);
                }).catch(error => {
                    showNotification('error', error.message || 'Error al recargar la lista de ventas, productos, clientes o IGV.');
                });
            }

            function aplicarFiltrosVenta() {
                const searchTermInput = document.getElementById('searchTermVenta');
                if (!searchTermInput) return;
                const searchTerm = searchTermInput.value.toLowerCase();
                const filteredVentas = allVentas.filter(venta => {
                    const clientName = getClientDisplayName(venta.cliente).toLowerCase(); // Usa la nueva función
                    const numDocMatch = venta.numDocumento && venta.numDocumento.toLowerCase().includes(searchTerm);
                    return clientName.includes(searchTerm) || numDocMatch;
                });
                renderMainTable(filteredVentas);
            }

            // ===============================================
// LÓGICA DE REPORTE DE VENTAS (CLIENT-SIDE)
// ===============================================

// Abre el modal de filtros del reporte de ventas
window.generarReporteVenta = function() {
    console.log("Abriendo modal de reporte de ventas...");
    $('#modalReporteContentVenta').load('/ventas/reporte/modal', function(response, status, xhr) {
        if (status === "error") {
            console.error("Error al cargar el formulario de reporte de ventas:", xhr.status, xhr.statusText, response);
            showNotification('error', 'Hubo un problema al cargar el formulario de reporte de ventas. Por favor, inténtalo de nuevo.');
        } else {
            console.log("Formulario de reporte de ventas cargado exitosamente.");
            // Inicializar Select2 para los selects de cliente y usuario en el modal
            $('#filtroIdCliente').select2({
                placeholder: "-- Seleccione un Cliente --",
                allowClear: true,
                width: '100%',
                dropdownParent: $('#reporteVentasModal')
            });
            $('#filtroIdUsuario').select2({
                placeholder: "-- Seleccione un Vendedor --",
                allowClear: true,
                width: '100%',
                dropdownParent: $('#reporteVentasModal')
            });

            // Establecer las fechas máximas/mínimas para los campos de fecha
            setReportDateRangeVenta();
            $('#reporteVentasModal').modal('show');
        }
    });
}

// Cierra el modal de reporte de ventas
window.cerrarReporteVentasModal = function() {
    $('#reporteVentasModal').modal('hide');
    // Destruir Select2 para evitar duplicados en futuras aperturas
    $('#filtroIdCliente').select2('destroy');
    $('#filtroIdUsuario').select2('destroy');
    setTimeout(() => {
        $('#modalReporteContentVenta').empty();
    }, 300); // Pequeño retraso para que la transición del modal se complete
}

// Limpia los filtros del modal de reporte de ventas
window.limpiarFiltrosReporteVentas = function() {
    $('#formReporteVentas')[0].reset();
    $('.estado-checkbox-venta').prop('checked', false); // Desmarcar checkboxes
    $('#filtroIdCliente').val('').trigger('change'); // Limpiar Select2
    $('#filtroIdUsuario').val('').trigger('change'); // Limpiar Select2
    setReportDateRangeVenta(); // Restablecer límites de fecha
}

// Función para ajustar el atributo 'max' y 'min' de las fechas en el modal de reporte de ventas
window.setReportDateRangeVenta = function() {
    const today = new Date().toISOString().split('T')[0];
    const fechaInicioInput = document.getElementById('fechaRegistroVentaStart');
    const fechaFinInput = document.getElementById('fechaRegistroVentaEnd');

    if (fechaInicioInput) {
        fechaInicioInput.setAttribute('max', today);
        if (fechaFinInput && fechaFinInput.value) {
            fechaInicioInput.setAttribute('max', fechaFinInput.value);
        }
    }
    if (fechaFinInput) {
        fechaFinInput.setAttribute('max', today);
        if (fechaInicioInput && fechaInicioInput.value) {
            fechaFinInput.setAttribute('min', fechaInicioInput.value);
        } else {
            fechaFinInput.removeAttribute('min'); // Si fecha de inicio está vacía, no hay mínimo
        }
    }
}

// Ejecuta la generación del reporte PDF de ventas
window.ejecutarGenerarReporteVentas = function() {
    Swal.fire({
        title: 'Generando Reporte...',
        text: 'Por favor, espera mientras se genera el PDF.',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    const form = $('#formReporteVentas');
    let formData = form.serialize();

    // Manejar múltiples checkboxes para el campo 'estados'
    const estadosChecked = [];
    $('.estado-checkbox-venta:checked').each(function() {
        estadosChecked.push('estados=' + $(this).val());
    });
    if (estadosChecked.length > 0) {
        formData += '&' + estadosChecked.join('&');
    }

    const url = '/ventas/reporte/pdf?' + formData;

    // Pequeño retardo para asegurar que el Swal.showLoading() se vea
    setTimeout(() => {
        const newWindow = window.open(url, '_blank');
        if (newWindow) {
            Swal.close();
            showNotification("success", "El reporte PDF se está generando y debería descargarse pronto.");
            cerrarReporteVentasModal();
        } else {
            Swal.close();
            showNotification("error", "Error: Tu navegador bloqueó la descarga del PDF. Por favor, permite los pop-ups para este sitio.");
        }
    }, 300);
}

            // ===============================================
            // LÓGICA DEL FORMULARIO MODAL (CREAR VENTA SOLAMENTE)
            // ===============================================

            // Declarar loadAndShowModalContent a nivel global
            function loadAndShowModalContent(idVenta, url) {
                modalContentContainer.innerHTML = '';
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open');

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(html) {
                        modalContentContainer.innerHTML = html;
                        setTimeout(() => {
                            const clienteSelectInModal = $('#modalContentContainer #clienteSelect');
                            const igvSelectInModal = $('#modalContentContainer #igvSelect');

                            if (igvSelectInModal.length) {
                              igvSelectInModal
                                .select2({
                                  placeholder: "-- Seleccione el IGV --",
                                  allowClear: true,
                                  width: '100%',
                                  dropdownParent: ventaModalElement
                                })
                                // 1) Cada vez que cambie la tasa, recalcula
                                .on('change', calculateTotalGeneral);

                              // 2) Al cargar el modal la primera vez, forzamos el cálculo
                              calculateTotalGeneral();
                            }
                            if (igvSelectInModal.length) {
                              igvSelectInModal
                                .select2({
                                  placeholder: "-- Seleccione el IGV --",
                                  allowClear: true,
                                  width: '100%',
                                  dropdownParent: ventaModalElement
                                })
                                // 1) Cada vez que cambie la tasa, recalcula
                                .on('change', calculateTotalGeneral);

                              // 2) Al cargar el modal la primera vez, forzamos el cálculo
                              calculateTotalGeneral();
                            }

                            $('#modalContentContainer').find('.detalle-item select[id^="producto-"]').each(function() {
                                if (!$(this).data('select2')) {
                                    $(this).select2({
                                        placeholder: "-- Seleccione un Producto --",
                                        allowClear: true,
                                        width: '100%',
                                        dropdownParent: ventaModalElement
                                    });
                                }
                            });
                            ventaModalElement.modal('show');
                            modalIsTransitioning = false;
                        }, 150);
                    },
                    error: function(xhr, status, error) {
                        showNotification('error', 'No se pudo cargar el formulario de venta. Inténtalo de nuevo.');
                        modalIsTransitioning = false;
                    }
                });
            }


            window.openFormModal = function(idVenta) {
                if (modalIsTransitioning) {
                    return;
                }
                modalIsTransitioning = true;
                clearErrors();
                detalleCount = 0;

                // Siempre carga el formulario para CREAR (ignora idVenta si se pasa, ya que no editamos)
                let url = '/ventas/nuevo';

                if (ventaModalElement.hasClass('show')) {
                    ventaModalElement.one('hidden.bs.modal', () => loadAndShowModalContent(idVenta, url));
                    ventaModalElement.modal('hide');
                } else {
                    loadAndShowModalContent(idVenta, url);
                }
            }

            window.closeFormModal = function() {
                if (modalIsTransitioning) {
                    return;
                }
                modalIsTransitioning = true;
                ventaModalElement.modal('hide');
                ventaModalElement.one('hidden.bs.modal', function () {
                    $('#modalContentContainer').find('select.select2-hidden-accessible').each(function() {
                        if ($(this).data('select2')) {
                            $(this).select2('destroy');
                        }
                    });

                    modalContentContainer.innerHTML = '';
                    modalIsTransitioning = false;
                    $('.modal-backdrop').remove();
                    $('body').removeClass('modal-open');
                });
                clearErrors();
            }

            // ===============================================
            // LÓGICA DEL MODAL DE VISUALIZACIÓN
            // ===============================================

            window.openViewModal = function(idVenta) {
                if (modalIsTransitioning) {
                    return;
                }
                modalIsTransitioning = true;
                if (!idVenta) {
                    showNotification('error', 'ID de venta no proporcionado para visualizar.');
                    modalIsTransitioning = false;
                    return;
                }
                let url = `/ventas/visualizar/${idVenta}`;
                // Reutilizar loadAndShowModalContent, adaptado para la vista
                if (ventaModalElement.hasClass('show')) {
                    ventaModalElement.one('hidden.bs.modal', () => loadAndShowModalContent(idVenta, url));
                    // Reutilizar y pasar argumentos
                    ventaModalElement.modal('hide');
                } else {
                    loadAndShowModalContent(idVenta, url);
                    // Reutilizar y pasar argumentos
                }
            }

            window.closeViewModal = function() {
                if (modalIsTransitioning) {
                    return;
                }
                modalIsTransitioning = true;
                ventaModalElement.modal('hide');
                ventaModalElement.one('hidden.bs.modal', function () {
                    modalContentContainer.innerHTML = '';
                    modalIsTransitioning = false;
                    $('.modal-backdrop').remove();
                    $('body').removeClass('modal-open');
                });
            }

            // ===============================================
            // LÓGICA DE DETALLES DE VENTA EN EL FORMULARIO MODAL
            // ===============================================

            window.initializeModalDetails = function(modalProducts, modalSale, modalClients, modalIgvs) {
                allProductosData = modalProducts;
                allClientesData = modalClients;
                allIgvData = modalIgvs;

                const detalleVentasContainer = document.getElementById('detalleVentasContainer');
                if (!detalleVentasContainer) {
                    return;
                }
                detalleVentasContainer.innerHTML = '';
                if (modalSale && modalSale.detalleVentas && modalSale.detalleVentas.length > 0) {
                    modalSale.detalleVentas.forEach(detalle => {
                        addDetalleVenta(detalle, allProductosData);
                    });
                } else {
                    addDetalleVenta(null, allProductosData);
                }
                calculateTotalGeneral();
            }

            window.addDetalleVenta = function(detalle = null, productsArray = allProductosData) {
                const index = detalleCount++;
                const detalleDiv = document.createElement('tr');
                detalleDiv.classList.add('detalle-item');
                detalleDiv.setAttribute('data-index', index);
                detalleDiv.id = `detalleRow-${index}`;
                let activos = productsArray.filter(p => p.estado === 1);

                let productoOptions = activos.map(p =>
                  `<option value="${p.idProducto}"
                          data-precio1="${p.precio1 || ''}"
                          data-precio2="${p.precio2 || ''}"
                          data-stock="${p.stock}"
                          ${detalle && detalle.producto && detalle.producto.idProducto === p.idProducto ? 'selected' : ''}>
                      ${p.nombre} (Stock: ${p.stock})
                   </option>`
                ).join('');

                const initialCantidad = detalle ? (detalle.cantidad || '') : '';
                const initialPrecioUnitario = detalle && detalle.precioUnitario ? (parseFloat(detalle.precioUnitario).toFixed(2) || '') : '';
                const initialTotalDetalle = detalle && detalle.total ? (parseFloat(detalle.total) || 0).toFixed(2) : '0.00';
                detalleDiv.innerHTML = `
                    <td>
                        <input type="hidden" name="detalleVentas[${index}].idDetalleVenta" value="${detalle ? detalle.idDetalleVenta || '' : ''}">
                        <select name="detalleVentas[${index}].producto.idProducto" id="producto-${index}" required
                               class="form-control">
                            <option value="">Seleccione un Producto</option>
                            ${productoOptions}
                        </select>
                        <span class="text-danger" id="productoError-${index}"></span>
                    </td>
                    <td>
                        <input type="number" name="detalleVentas[${index}].cantidad" id="cantidad-${index}" placeholder="Cantidad" required min="1"
                               value="${initialCantidad}"
                               class="form-control">
                        <span class="text-danger" id="cantidadError-${index}"></span>
                    </td>
                    <td>
                        <input type="number" step="0.01" class="form-control" id="precioUnitario-${index}" placeholder="Precio Unitario" min="0" value="${initialPrecioUnitario}">
                        <span class="text-danger" id="precioUnitarioError-${index}"></span>
                        <div class="mt-1">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setProductPrice(${index}, 'precio1')">P1</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ml-1" onclick="setProductPrice(${index}, 'precio2')">P2</button>
                        </div>
                    </td>
                    <td>
                        <input type="text" class="form-control total-detalle-display bg-light" id="detalleTotalDisplay-${index}" value="${initialTotalDetalle}" readonly>
                    </td>
                    <td>
                        <button type="button" onclick="removeDetalleVenta(this)"
                                class="btn btn-danger btn-sm">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                const detalleVentasContainer = document.getElementById('detalleVentasContainer');
                if (detalleVentasContainer) {
                    detalleVentasContainer.appendChild(detalleDiv);
                } else {
                    return;
                }

                setTimeout(() => {
                    const newProductoSelect = $(`#producto-${index}`);
                    if (newProductoSelect.length && !newProductoSelect.data('select2')) {
                        newProductoSelect.select2({
                            placeholder: "-- Seleccione un Producto --",
                            allowClear: true,
                            width: '100%',
                            dropdownParent: ventaModalElement
                        });
                    }
                }, 10);
                const cantidadInput = document.getElementById(`cantidad-${index}`);
                const precioInput = document.getElementById(`precioUnitario-${index}`);
                const productoSelect = document.getElementById(`producto-${index}`);

                if (cantidadInput) cantidadInput.addEventListener('input', () => updateDetalleTotal(index));
                if (precioInput) precioInput.addEventListener('input', () => updateDetalleTotal(index));
                if (productoSelect) {
                    productoSelect.addEventListener('change', () => {
                        const selectedOption = productoSelect.options[productoSelect.selectedIndex];
                        const precio1 = selectedOption.dataset.precio1;
                        if (precio1 && (initialPrecioUnitario === '' || parseFloat(precioInput.value) === 0 || precioInput.value === '')) {
                             precioInput.value = parseFloat(precio1).toFixed(2);
                        } else if (precio1 && !precioInput.value) { // Si no hay valor previo, usa precio1
                            precioInput.value = parseFloat(precio1).toFixed(2);
                        }
                        updateDetalleTotal(index);
                    });
                }

                // Si el precio unitario no se inicializó desde el detalle (es decir, es una nueva línea vacía)
                // Y si el producto ya está seleccionado, intenta usar precio1
                if (detalle && initialPrecioUnitario === '' && productoSelect && productoSelect.value) {
                    const selectedOption = productoSelect.options[productoSelect.selectedIndex];
                    const precio1 = selectedOption.dataset.precio1;
                    if (precio1) {
                        precioInput.value = parseFloat(precio1).toFixed(2);
                    }
                } else if (!detalle && productoSelect && productoSelect.value) {
                     const selectedOption = productoSelect.options[productoSelect.selectedIndex];
                     const precio1 = selectedOption.dataset.precio1;
                     if (precio1) {
                         precioInput.value = parseFloat(precio1).toFixed(2);
                    }
                }
                updateDetalleTotal(index);
            }

            window.setProductPrice = function(index, priceType) {
                const productoSelect = document.getElementById(`producto-${index}`);
                const precioInput = document.getElementById(`precioUnitario-${index}`);

                if (productoSelect && precioInput && productoSelect.value) {
                    const selectedOption = productoSelect.options[productoSelect.selectedIndex];
                    let priceValue;
                    if (priceType === 'precio1') {
                        priceValue = selectedOption.dataset.precio1;
                    } else if (priceType === 'precio2') {
                        priceValue = selectedOption.dataset.precio2;
                    }

                    if (priceValue) {
                        precioInput.value = parseFloat(priceValue).toFixed(2);
                        updateDetalleTotal(index);
                    }
                } else {
                    showNotification('info', 'Por favor, selecciona un producto primero para fijar el precio.');
                }
            }


            window.removeDetalleVenta = function(button) {
                const detalleDiv = button.closest('tr.detalle-item');
                if (detalleDiv) {
                    const productoSelect = detalleDiv.querySelector('select[id^="producto-"]');
                    if (productoSelect && $(productoSelect).data('select2')) {
                        $(productoSelect).select2('destroy');
                    }
                    detalleDiv.remove();
                    calculateTotalGeneral();
                }
            }

            window.updateDetalleTotal = function(index) {
                const cantidadInput = document.getElementById(`cantidad-${index}`);
                const precioUnitarioInput = document.getElementById(`precioUnitario-${index}`);
                const totalDisplay = document.getElementById(`detalleTotalDisplay-${index}`);

                if (cantidadInput && precioUnitarioInput && totalDisplay) {
                    const cantidad = parseFloat(cantidadInput.value) || 0;
                    const precioUnitario = parseFloat(precioUnitarioInput.value) || 0;
                    const totalDetalle = cantidad * precioUnitario;
                    totalDisplay.value = totalDetalle.toFixed(2);
                    calculateTotalGeneral();
                }
            }

            window.calculateTotalGeneral = function() {
                let subtotal = 0;
                document.querySelectorAll('.detalle-item').forEach(detalleDiv => {
                    const totalDisplay = detalleDiv.querySelector('.total-detalle-display');
                    if (totalDisplay) {
                        const totalValue = parseFloat(totalDisplay.value) || 0;
                        subtotal += totalValue;
                    }
                });
                const igvSelect = document.getElementById('igvSelect');
                let igvRate = 0;
                if (igvSelect && igvSelect.value) {
                    const selectedIgv = allIgvData.find(tasa => tasa.idIgv == igvSelect.value);
                    if (selectedIgv) {
                        igvRate = parseFloat(selectedIgv.tasa) ;
                    }
                }

                const igvAmount = subtotal * igvRate;
                const totalGeneral = subtotal + igvAmount;

                const subtotalDisplay = document.getElementById('subtotalDisplay');
                if(subtotalDisplay) subtotalDisplay.value = subtotal.toFixed(2);

                const igvCalculatedDisplay = document.getElementById('igvCalculatedDisplay');
                if(igvCalculatedDisplay) igvCalculatedDisplay.value = igvAmount.toFixed(2);

                const totalGeneralDisplay = document.getElementById('totalGeneralDisplay');
                if (totalGeneralDisplay) {
                    totalGeneralDisplay.value = totalGeneral.toFixed(2);
                }
            }

            const igvSelectElement = document.getElementById('igvSelect');
            if (igvSelectElement) {
                igvSelectElement.addEventListener('change', calculateTotalGeneral);
            }


            // ===============================================
            // VALIDACIÓN DEL FORMULARIO
            // ===============================================

            async function validateForm() {
                clearErrors();
                let isValid = true;

                const tipoDocumentoInput = document.getElementById('tipoDocumento');
                if (tipoDocumentoInput && !tipoDocumentoInput.value) {
                    displayError('tipoDocumentoError', 'El tipo de documento es obligatorio.');
                    tipoDocumentoInput.classList.add('is-invalid');
                    isValid = false;
                } else if (tipoDocumentoInput) {
                    tipoDocumentoInput.classList.remove('is-invalid');
                }
                const numDocumentoInput = document.getElementById('numDocumento');
                if (numDocumentoInput && !numDocumentoInput.value.trim()) {
                    displayError('numDocumentoError', 'El número de documento es obligatorio.');
                    numDocumentoInput.classList.add('is-invalid');
                    isValid = false;
                } else if (numDocumentoInput) {
                    numDocumentoInput.classList.remove('is-invalid');
                }
                const clienteSelect = document.getElementById('clienteSelect');
                if (clienteSelect && !clienteSelect.value) {
                    displayError('clienteSelectError', 'Debe seleccionar un cliente.');
                    clienteSelect.classList.add('is-invalid');
                    isValid = false;
                } else if (clienteSelect) {
                    clienteSelect.classList.remove('is-invalid');
                }
                const igvSelect = document.getElementById('igvSelect');
                if (igvSelect && !igvSelect.value) {
                    displayError('igvSelectError', 'Debe seleccionar un tipo de IGV.');
                    igvSelect.classList.add('is-invalid');
                    isValid = false;
                } else if (igvSelect) {
                    igvSelect.classList.remove('is-invalid');
                }
                const tipoPagoInput = document.getElementById('tipoPago');
                if (tipoPagoInput && !tipoPagoInput.value) {
                    displayError('tipoPagoError', 'El tipo de pago es obligatorio.');
                    tipoPagoInput.classList.add('is-invalid');
                    isValid = false;
                } else if (tipoPagoInput) {
                    tipoPagoInput.classList.remove('is-invalid');
                }
                const detalleRows = document.querySelectorAll('.detalle-item');
                if (detalleRows.length === 0) {
                    showNotification('error', 'Debe añadir al menos un producto a la venta.');
                    isValid = false;
                }
                for (const row of detalleRows) {
                    const index = row.getAttribute('data-index');
                    const productoSelect = document.getElementById(`producto-${index}`);
                    const cantidadInput = document.getElementById(`cantidad-${index}`);
                    const precioUnitarioInput = document.getElementById(`precioUnitario-${index}`);
                    if (productoSelect && !productoSelect.value) {
                        displayError(`productoError-${index}`, 'Seleccione un producto.');
                        productoSelect.classList.add('is-invalid');
                        isValid = false;
                    } else if (productoSelect) {
                        productoSelect.classList.remove('is-invalid');
                    }
                    const cantidad = parseFloat(cantidadInput ? cantidadInput.value : '');
                    if (cantidadInput && (isNaN(cantidad) || cantidad <= 0)) {
                        displayError(`cantidadError-${index}`, 'Cantidad > 0.');
                        cantidadInput.classList.add('is-invalid');
                        isValid = false;
                    } else if (cantidadInput) {
                        cantidadInput.classList.remove('is-invalid');
                    }
                    if (productoSelect && cantidadInput) {
                        const selectedOption = productoSelect.options[productoSelect.selectedIndex];
                        const availableStock = parseInt(selectedOption.dataset.stock || '0');
                        const currentSaleId = document.getElementById('idVenta') ? document.getElementById('idVenta').value : null;
                        let oldQuantityInThisDetail = 0;
                        if (currentSaleId) {
                            const oldSale = allVentas.find(v => v.idVenta == currentSaleId);
                            if (oldSale && oldSale.detalleVentas) {
                                const oldDetailForProduct = oldSale.detalleVentas.find(d => d.producto && d.producto.idProducto == productoSelect.value );
                                if (oldDetailForProduct) {
                                    oldQuantityInThisDetail = oldDetailForProduct.cantidad;
                                }
                            }
                        }
                        const effectiveAvailableStock = availableStock + oldQuantityInThisDetail;
                        if (cantidad > effectiveAvailableStock) {
                            displayError(`cantidadError-${index}`, `Stock insuficiente. Disponible: ${availableStock} (cantidad previa en esta venta: ${oldQuantityInThisDetail}).`);
                            cantidadInput.classList.add('is-invalid');
                            isValid = false;
                        }
                    }
                    const precio = parseFloat(precioUnitarioInput ? precioUnitarioInput.value : '');
                    if (precioUnitarioInput && (isNaN(precio) || precio < 0)) {
                        displayError(`precioUnitarioError-${index}`, 'Precio >= 0.');
                        precioUnitarioInput.classList.add('is-invalid');
                        isValid = false;
                    } else if (precioUnitarioInput) {
                        precioUnitarioInput.classList.remove('is-invalid');
                    }
                }
                return isValid;
            }
            // ===============================================
            // LÓGICA DE GUARDADO DE LA VENTA (EN EL CLIENTE)
            // ===============================================
            window.saveVenta = async function(event) { // Recibe el objeto 'event'
                event.preventDefault(); // Evita el envío del formulario por defecto
                if (!(await validateForm())) {
                    showNotification('error', 'Por favor, corrige los errores en el formulario.');
                    // Notificación genérica si la validación falla en el frontend
                    return;
                }
                const idVenta = document.getElementById('idVenta') ? document.getElementById('idVenta').value : null;
                const idCliente = document.getElementById('clienteSelect') ? document.getElementById('clienteSelect').value : null;
                const tipoDocumento = document.getElementById('tipoDocumento') ? document.getElementById('tipoDocumento').value : '';
                const numDocumento = document.getElementById('numDocumento') ? document.getElementById('numDocumento').value : '';
                const tipoPago = document.getElementById('tipoPago') ? document.getElementById('tipoPago').value : '';
                const idIgv = document.getElementById('igvSelect') ? document.getElementById('igvSelect').value : null;
                const totalElement = document.getElementById('totalGeneralDisplay');
                const total = totalElement ? parseFloat(totalElement.value) : 0;
                const igvCalculatedAmount = document.getElementById('igvCalculatedDisplay') ? parseFloat(document.getElementById('igvCalculatedDisplay').value) : 0;
                const detallesVentas = [];
                // Itera sobre todas las filas con la clase 'detalle-item' en el tbody
                document.querySelectorAll('#detalleVentasContainer tr.detalle-item').forEach(detalleRow => {
                    const index = detalleRow.getAttribute('data-index');
                    // Función para obtener el valor de un elemento dentro de la fila actual
                    const getVal = (selector) => {
                        const element = detalleRow.querySelector(selector);
                        // Asegúrate de que el valor sea un string vacío si es null o undefined, para que parseInt/parseFloat no fallen
                        return element ? element.value : '';
                    };
                    // Obtén el idDetalleVenta. Si está vacío o null, conviértelo a null para el backend.
                    const currentIdDetalleVenta = getVal(`input[name="detalleVentas[${index}].idDetalleVenta"]`);
                    const parsedIdDetalleVenta = (currentIdDetalleVenta && currentIdDetalleVenta.trim() !== '') ? parseInt(currentIdDetalleVenta) : null;
                    detallesVentas.push({
                        idDetalleVenta: parsedIdDetalleVenta,
                        producto: { idProducto: getVal(`#producto-${index}`) ? parseInt(getVal(`#producto-${index}`)) : null },
                        cantidad: getVal(`#cantidad-${index}`) ? parseInt(getVal(`#cantidad-${index}`)) : null,
                        precioUnitario: getVal(`#precioUnitario-${index}`) ? parseFloat(getVal(`#precioUnitario-${index}`)) : null,
                        total: getVal(`#detalleTotalDisplay-${index}`) ? parseFloat(getVal(`#detalleTotalDisplay-${index}`)) : null
                    });
                });
                const data = {
                  idVenta: idVenta ? parseInt(idVenta) : null,
                  cliente:       { idCliente: parseInt(idCliente) },
                  total:           total,
                  tipoDocumento:  tipoDocumento,
                  numDocumento:    numDocumento,
                  tipoPago:        tipoPago,
                  tasa:            igvCalculatedAmount,
                  igvEntity:    { idIgv: parseInt(idIgv) },
                  detalleVentas:   detallesVentas
                  };
                // --- AÑADIDO PARA DEPURACIÓN ---
                console.log("JSON de la venta a enviar:");
                console.log(JSON.stringify(data, null, 2)); // El 'null, 2' formatea el JSON para que sea legible
                // --- FIN AÑADIDO ---
                const url = '/ventas/guardar';
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        showNotification('error', errorData.message || 'Error al guardar la venta. Inténtalo de nuevo.');
                        return;
                    }
                    const resultData = await response.json();
                    showNotification('success', resultData.message);
                    closeFormModal();
                    recargarListaVentasCompleta();
                } catch (error) {
                    showNotification('error', error.message || 'Ocurrió un error de red o interno al guardar la venta.');
                }
            }

            // ===============================================
            // NUEVAS FUNCIONES PARA CANCELAR VENTA (cambioo para anular)
            // ===============================================

            window.confirmCancelVenta = function(idVenta) {
                Swal.fire({
                    title: 'Anular Venta',
                    html: `
                        <p>¿Está seguro de que desea anular esta venta? Esta acción no se puede revertir y el stock de productos será repuesto.</p>
                        <input type="password" id="adminPassword" class="swal2-input" placeholder="Contraseña de Administrador" autocomplete="new-password">
                        <div id="passwordError" class="text-danger" style="display:none; margin-top: 5px;"></div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33', // Rojo para anular
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, Anular',
                    cancelButtonText: 'Cancelar',
                    focusConfirm: false,
                    preConfirm: () => {
                        const password = Swal.getPopup().querySelector('#adminPassword').value;
                        if (!password) {
                            Swal.getPopup().querySelector('#passwordError').textContent = 'La contraseña es obligatoria.';
                            Swal.getPopup().querySelector('#passwordError').style.display = 'block';
                            return false; // Evita que el modal se cierre
                        }
                        Swal.getPopup().querySelector('#passwordError').style.display = 'none';
                        return { password: password };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        cancelarVenta(idVenta, result.value.password);
                    }
                });
            }

            async function cancelarVenta(idVenta, adminPassword) {
                // Muestra un loader mientras se procesa la solicitud
                Swal.fire({
                    title: 'Anulando Venta...',
                    text: 'Por favor, espera.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    const response = await fetch(`/ventas/cancelar/${idVenta}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ password: adminPassword }) // Enviar la contraseña en el cuerpo
                    });

                    Swal.close(); // Cierra el loader

                    if (!response.ok) {
                        const errorData = await response.json();
                        // Muestra el mensaje de error del backend
                        showNotification('error', errorData.message || 'Error al cancelar la venta.');
                        return; // Detiene la ejecución si hay un error
                    }

                    const result = await response.json();
                    showNotification('success', result.message || 'Venta cancelada exitosamente.');
                    recargarListaVentasCompleta(); // Recarga la tabla para reflejar el cambio de estado y color
                } catch (error) {
                    Swal.close(); // Asegúrate de cerrar el loader incluso si hay un error de red
                    console.error('Error al cancelar la venta:', error);
                    showNotification('error', error.message || 'Ocurrió un error de red o interno al intentar cancelar la venta.');
                }
            }


            const clienteFormModalElement = $('#clienteFormModal');
            const clienteFormModalContent = $('#clienteFormModalContent');

            // ===============================================
            // LÓGICA DEL FORMULARIO DE CLIENTE (NUEVO/EDICIÓN)
            // ===============================================

            /**
             * Función para abrir el modal del formulario de cliente.
             * Se llama desde venta.html (botón de la tabla) o desde form_venta.html (botón en el select de cliente).
             */
            window.openClienteFormModal = function() {
                $.ajax({
                    url: '/ventas/cliente/nuevo', // Endpoint del controlador para cargar el fragmento del cliente
                    type: 'GET',
                    success: function(response) {
                        clienteFormModalContent.html(response); // Carga el HTML del formulario en el modal
                        clienteFormModalElement.modal('show'); // Muestra el modal

                        // **** AQUI ES DONDE LLAMAMOS A LAS FUNCIONES DEL FORMULARIO DE CLIENTE ****
                        // Adjuntar manejador de evento para el cambio en el select del tipo de cliente
                        // Usamos .off() para evitar múltiples adjunciones si el modal se abre varias veces
                        $('#clienteFormModalContent #idTipoCliente').off('change').on('change', toggleClientFields);

                        // Inicializar el estado de los campos al abrir el modal (para edición o nuevo)
                        toggleClientFields();

                        // Adjuntar el manejador de envío del formulario (para guardar el cliente)
                        $('#clienteFormModalContent #formCliente').off('submit').on('submit', saveCliente);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error al cargar el formulario de cliente:', error);
                        showNotification('error', 'Error al cargar el formulario de cliente. Por favor, intente de nuevo.');
                    }
                });
            };

            /**
             * Función para cerrar el modal del cliente.
             * Esta función debe ser llamada por los botones de cerrar/cancelar dentro del modal de cliente.
             * Al cerrar, recarga la lista de clientes en el formulario de ventas.
             */
            window.closeClienteFormModal = function() {
                clienteFormModalElement.modal('hide');
                clienteFormModalElement.one('hidden.bs.modal', function () {
                    clienteFormModalContent.empty(); // Limpiar el contenido al cerrar
                    clearErrors(); // Limpia errores del formulario de cliente al cerrar

                    // IMPORTANTE: Recargar los datos de clientes en el modal de ventas
                    // para asegurar que el select tenga el cliente recién añadido.
                    recargarListaVentasCompleta(); // Esto actualizará allClientesData y el Select2 en el modal de ventas
                });
            };

            // **** INICIO: FUNCIONES ESPECÍFICAS DEL FORMULARIO DE CLIENTE (MOVIDAS AQUÍ) ****

            // Función para alternar campos visibles según el tipo de cliente
            function toggleClientFields() {
                const tipoClienteId = parseInt($('#clienteFormModalContent #idTipoCliente').val(), 10);
                clearErrors(); // Limpiar errores al cambiar de tipo

                // Primero, ocultar todos los campos específicos de tipo
                $('#clienteFormModalContent #naturalFields').hide();
                $('#clienteFormModalContent #juridicaFields').hide();

                // Determinar qué conjunto de campos mostrar y qué conjunto de campos limpiar
                if (tipoClienteId === 1) { // Persona Natural (Ajusta el ID si es diferente en tu DB)
                    $('#clienteFormModalContent #naturalFields').show();
                    // Limpiar solo los campos de Persona Jurídica
                    $('#clienteFormModalContent #ruc').val('');
                    $('#clienteFormModalContent #razonSocial').val('');
                    $('#clienteFormModalContent #nombreComercial').val('');
                } else if (tipoClienteId === 2) { // Persona Jurídica (Ajusta el ID si es diferente en tu DB)
                    $('#clienteFormModalContent #juridicaFields').show();
                    // Limpiar solo los campos de Persona Natural
                    $('#clienteFormModalContent #dni').val('');
                    $('#clienteFormModalContent #nombre').val('');
                    $('#clienteFormModalContent #apPaterno').val('');
                    $('#clienteFormModalContent #apMaterno').val('');
                } else { // No se ha seleccionado ningún tipo (ej. al cargar el formulario para un nuevo cliente)
                    // Limpiar todos los campos específicos de tipo
                    $('#clienteFormModalContent #dni').val('');
                    $('#clienteFormModalContent #nombre').val('');
                    $('#clienteFormModalContent #apPaterno').val('');
                    $('#clienteFormModalContent #apMaterno').val('');
                    $('#clienteFormModalContent #ruc').val('');
                    $('#clienteFormModalContent #razonSocial').val('');
                    $('#clienteFormModalContent #nombreComercial').val('');
                }
                // (Opcional): Re-adjunta los escuchadores de validación en tiempo real si son relevantes
                // attachRealTimeValidationListeners(); // Solo si estas funciones están adaptadas para el modal
            }

            // Las funciones de validación (validateRequiredCliente, validateDniCliente, etc.)
            // deben ser definidas aquí en venta.html y deben usar el prefijo
            // '#clienteFormModalContent' para seleccionar los elementos del formulario dentro del modal.

            function validateRequiredCliente(inputElementId, errorElementId, fieldName) {
                const input = $('#clienteFormModalContent #' + inputElementId);
                const value = input.val().trim();
                if (value === "") {
                    displayError(errorElementId, `${fieldName} es obligatorio.`);
                    return false;
                }
                input.removeClass('is-invalid');
                return true;
            }

            function validateDniCliente(inputElementId, errorElementId) {
                const input = $('#clienteFormModalContent #' + inputElementId);
                const value = input.val().trim();
                const regex = /^\d{8}$/;

                if (value === "") {
                    displayError(errorElementId, "El DNI es obligatorio.");
                    return false;
                } else if (!regex.test(value)) {
                    displayError(errorElementId, "El DNI debe tener 8 dígitos numéricos.");
                    return false;
                }
                input.removeClass('is-invalid');
                return true;
            }

            // ... (Aquí irían todas las demás funciones de validación para el cliente,
            // como validateRucCliente, validateNombreApellidosCliente, validateTelefonoCliente,
            // checkDniUnicoCliente, checkRucUnicoCliente, etc., asegurándote de que todas
            // usen '#clienteFormModalContent #' al seleccionar elementos del DOM.)

            async function checkDniUnicoCliente(dniInputId, dniErrorId, idCliente) {
                const dni = $('#clienteFormModalContent #' + dniInputId).val();
                if (dni.trim() === "") return true;

                let url = '/ventas/checkDni?dni=' + encodeURIComponent(dni); // Usar el endpoint de VentaController si es este quien valida
                if (idCliente) {
                    url += '&idCliente=' + idCliente;
                }
                try {
                    const response = await $.ajax({ type: "GET", url: url, dataType: "json" });
                    if (response.exists) {
                        displayError(dniErrorId, "Este DNI ya está registrado.");
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error("Error al verificar DNI de cliente:", error);
                    displayError(dniErrorId, "Error al verificar DNI. Intenta de nuevo.");
                    return false;
                }
            }
            // ... (checkRucUnicoCliente similar) ...



            // Función para guardar el cliente
            window.saveCliente = async function(event) {
                event.preventDefault();

                const idCliente = $('#clienteFormModalContent #idCliente').val() === '' ? null : parseInt($('#clienteFormModalContent #idCliente').val(), 10);
                const fechaRegistro = $('#clienteFormModalContent #fechaRegistro').val();
                const tipoClienteId = parseInt($('#clienteFormModalContent #idTipoCliente').val(), 10);

                const clienteData = {
                    idCliente: idCliente,
                    fechaRegistro: fechaRegistro,
                    tipoCliente: { idRolCliente: tipoClienteId },
                    dni: $('#clienteFormModalContent #dni').val() || null,
                    nombre: $('#clienteFormModalContent #nombre').val() || null,
                    apPaterno: $('#clienteFormModalContent #apPaterno').val() || null,
                    apMaterno: $('#clienteFormModalContent #apMaterno').val() || null,
                    ruc: $('#clienteFormModalContent #ruc').val() || null,
                    razonSocial: $('#clienteFormModalContent #razonSocial').val() || null,
                    nombreComercial: $('#clienteFormModalContent #nombreComercial').val() || null,
                    direccion: $('#clienteFormModalContent #direccion').val(),
                    telefono: $('#clienteFormModalContent #telefono').val() || null,
                    estado: parseInt($('#clienteFormModalContent #estado').val(), 10)
                };

                try {
                    const response = await fetch('/ventas/cliente/guardar', { // Asegúrate que esta URL coincida con tu @PostMapping en VentaController
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(clienteData),
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        showNotification('success', result.message);
                        closeClienteFormModal(); // Cierra el modal y recarga clientes en el select de ventas
                    } else {
                        showNotification('error', result.message);
                        // Opcional: Si el backend devuelve errores de validación específicos, mostrarlos
                        if (result.errors) {
                            result.errors.forEach(err => {
                                displayError(err.field + 'Error', err.defaultMessage);
                            });
                        }
                    }
                } catch (error) {
                    showNotification('error', 'Error al guardar el cliente: ' + error.message);
                }
            };
            // **** FIN: FUNCIONES ESPECÍFICAS DEL FORMULARIO DE CLIENTE ****

            // ... (resto de la inicialización de $(document).ready y funciones para Ventas) ...

            function recargarListaVentasCompleta() {
                $.ajax({
                    type: "GET",
                    url: '/ventas/all', // Este endpoint DEBE existir en tu backend y devolver JSON
                    dataType: "json",
                    success: function(response) {
                        allVentas = response; // Actualizar la variable global con los nuevos datos
                        aplicarFiltrosVenta(); // Aplicar el filtro actual a la nueva lista (mantener el término de búsqueda)
                    },
                    error: function(xhr, status, error) {
                        console.error("Error al recargar la lista completa de centas:", error);
                        mostrarNotificacion("error", "Error al recargar la lista de ventas. Verifica el endpoint /ventas/all en tu backend.");
                    }
                });
                }

            // Estas funciones son genéricas y deben estar en tu venta.html
            window.clearErrors = function() {
                $('.text-danger').text('');
                $('.form-control').removeClass('is-invalid');
            };

            window.displayError = function(elementId, message) {
                $('#' + elementId).text(message);
                $('#' + elementId).prevAll('.form-control').first().addClass('is-invalid');
            };

            window.showNotification = function(type, message) {
                $(document).Toasts('create', {
                    class: type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-info' : 'bg-danger'),
                    title: type === 'success' ? 'Éxito' : (type === 'info' ? 'Información' : 'Error'),
                    body: message,
                    autohide: true,
                    delay: 3000
                });
            };

            // ===============================================
            // INICIALIZACIÓN
            // ===============================================

            recargarListaVentasCompleta();

        }); // Fin de $(document).ready
        /*]]>*/
    </script>
</section>
</body>
</html>
