<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title layout:fragment="title">Gestión de Usuarios</title>
</head>
<section layout:fragment="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Usuarios</h3>
                        <div class="card-tools">
                            <a href="javascript:void(0)" onclick="abrirFormulario('/usuarios/nuevo')"
                               class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                                <i class="fas fa-plus"></i> Crear Nuevo Usuario
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-info" type="button" data-toggle="collapse" data-target="#collapseUserFilters" aria-expanded="false" aria-controls="collapseUserFilters">
                                <i class="fas fa-filter"></i> Mostrar/Ocultar Filtros Avanzados
                            </button>
                        </div>

                        <div class="collapse" id="collapseUserFilters">
                            <div class="card card-body">
                                <form id="mainUserFilterForm" onsubmit="event.preventDefault(); aplicarFiltrosUsuarios();">
                                    <div class="form-row">
                                        <div class="form-group col-md-4">
                                            <label for="filtroNombreApellidoDniCorreo">Búsqueda General:</label>
                                            <input type="text" id="filtroNombreApellidoDniCorreo" name="nombreApellidoDniCorreo" class="form-control" placeholder="Nombre, Apellido, DNI, Correo, Celular"/>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="filtroIdRoles">Rol:</label>
                                            <select id="filtroIdRoles" name="idRoles" class="form-control">
                                                <option value="">Todos los Roles</option> </select>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label>Estado:</label><br>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input estado-checkbox-usuario-main" type="checkbox" id="estadoActivoUsuarioMain" name="estados" value="1">
                                                <label class="form-check-label" for="estadoActivoUsuarioMain">Activo</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input estado-checkbox-usuario-main" type="checkbox" id="estadoInactivoUsuarioMain" name="estados" value="0">
                                                <label class="form-check-label" for="estadoInactivoUsuarioMain">Inactivo</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label>Fecha de Registro:</label>
                                            <div class="input-group">
                                                <input type="date" id="fechaRegistroStartUserMain" name="fechaRegistroStart" class="form-control" onchange="setMainDateMaxAttributesUser()">
                                                <input type="date" id="fechaRegistroEndUserMain" name="fechaRegistroEnd" class="form-control" onchange="setMainDateMinAttributesUser()">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <button class="btn btn-default" type="submit">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                        <button class="btn btn-success ml-2" type="button" onclick="ejecutarGenerarReporteUsuarios()"
                                                style="background-color:#b45f06 !important; border-color:#b45f06 !important;">
                                            <i class="fas fa-file-pdf"></i> Generar Reporte PDF
                                        </button>
                                        <button class="btn btn-secondary ml-2" type="button" onclick="limpiarFiltrosMainUsuario()">
                                            <i class="fas fa-redo"></i> Limpiar Filtros
                                        </button>
                                    </div>
                                </form>
                                <div class="alert alert-info text-center mt-3" role="alert">
                                    <i class="fas fa-info-circle"></i> Deje todas las opciones de filtro sin marcar para buscar/generar un reporte de todos los usuarios.
                                </div>
                            </div>
                        </div>

                        <div id="tablaUsuariosContainer" class="mt-3">
                            <table id="usuariosTable" class="table table-bordered table-striped">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Apellido Paterno</th>
                                    <th>Apellido Materno</th>
                                    <th>DNI</th>
                                    <th>Rol</th>
                                    <th>Correo</th>
                                    <th>Celular</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody id="usuariosTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="usuarioModal" tabindex="-1" role="dialog" aria-labelledby="usuarioModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div id="modalFormContent">
                </div>
            </div>
        </div>
    </div>
</section>
<th:block layout:fragment="scripts">
    <script th:inline="javascript">

        /*<![CDATA[*/

        // Función para renderizar la tabla con una lista de usuarios
        function renderizarTabla(usersToDisplay) {
            const tableBody = $('#usuariosTableBody');
            tableBody.empty(); // Limpiar el cuerpo de la tabla antes de añadir nuevos datos

            if (usersToDisplay.length === 0) {
                tableBody.append('<tr><td colspan="9" class="text-center">No se encontraron usuarios.</td></tr>');
                return;
            }

            usersToDisplay.forEach(usuario => {
                const estadoText = usuario.estado === 1 ? 'Activo' : 'Inactivo';
                // Puedes usar estadoClass si lo deseas para el botón de estado, pero lo haré directo en el HTML del botón.
                // const estadoClass = usuario.estado === 1 ? 'badge badge-success badge-pill' : 'badge badge-danger badge-pill';

                const rolNombre = usuario.rolUsuario ? usuario.rolUsuario.tipoRol : 'N/A';

                const row = `
                    <tr>
                        <td>${usuario.idUsuario}</td>
                        <td>${usuario.nombre}</td>
                        <td>${usuario.apPaterno}</td>
                        <td>${usuario.apMaterno}</td>
                        <td>${usuario.dni}</td>
                        <td>${rolNombre}</td>
                        <td>${usuario.correo}</td>
                        <td>${usuario.telefono}</td>
                        <td class="text-center">
                            <button class="btn btn-sm ${usuario.estado === 1 ? 'btn-success' : 'btn-secondary'}"
                                    onclick="cambiarEstadoUsuario(${usuario.idUsuario})">
                                ${usuario.estado === 1 ? '<i class="fas fa-toggle-on"></i> Activo' : '<i class="fas fa-toggle-off"></i> Inactivo'}
                            </button>
                        </td>
                        <td>
                            <a href="javascript:void(0)" onclick="abrirFormulario('/usuarios/editar/${usuario.idUsuario}')"
                               class="btn btn-info btn-sm">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="javascript:void(0)" onclick="confirmarEliminar(${usuario.idUsuario})"
                               class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tableBody.append(row);
            });
        }

        // Función para limpiar todos los mensajes de error
        function clearErrors() {
            $('.text-danger').text('');
            $('.form-control, .form-control-plaintext, .is-invalid').removeClass('is-invalid'); // Quitar is-invalid de todos
        }

        // Función para mostrar un mensaje de error específico
        function displayError(elementId, message) {
            $('#' + elementId).text(message);
            // Busca el input/select asociado y añade la clase is-invalid
            $('#' + elementId).closest('.form-group').find('.form-control, .form-control-plaintext, .selectpicker').first().addClass('is-invalid');
        }

        // ===========================================
        // FUNCIONES DE VALIDACIÓN ESPECÍFICAS (AHORA UNIFICADAS PARA REAL-TIME Y SUBMIT)
        // ===========================================

        function validateNombreApellido(inputElementId, errorElementId, fieldName, isSubmit = false) {
            const input = $('#' + inputElementId);
            let value = input.val();
            const originalValue = value;
            const regex = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]*$/;

            value = value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');
            if (value !== originalValue) {
                input.val(value);
            }

            if (isSubmit && value.trim() === "") {
                displayError(errorElementId, `${fieldName} es obligatorio.`);
                input.addClass('is-invalid'); // Asegurar que el input se marque como inválido
                return false;
            } else if (value.length > 0 && !regex.test(value)) {
                displayError(errorElementId, `${fieldName} solo debe contener letras.`);
                input.addClass('is-invalid'); // Asegurar que el input se marque como inválido
                return false;
            } else {
                displayError(errorElementId, '');
                input.removeClass('is-invalid');
                return true;
            }
        }

        function validateTelefono(inputElementId, errorElementId, isSubmit = false) {
            const input = $('#' + inputElementId);
            let value = input.val();
            const originalValue = value;
            const regex = /^\d{9}$/;

            value = value.replace(/\D/g, '').substring(0, 9);
            if (value !== originalValue) {
                input.val(value);
            }

            if (isSubmit && value === "") {
                displayError(errorElementId, "El teléfono es obligatorio.");
                input.addClass('is-invalid');
                return false;
            } else if (value.length > 0 && !regex.test(value)) {
                displayError(errorElementId, "El teléfono debe tener 9 dígitos numéricos.");
                input.addClass('is-invalid');
                return false;
            } else {
                displayError(errorElementId, '');
                input.removeClass('is-invalid');
                return true;
            }
        }

        function validateDni(inputElementId, errorElementId, isSubmit = false) {
            const input = $('#' + inputElementId);
            let value = input.val();
            const originalValue = value;
            const regex = /^\d{8}$/;

            value = value.replace(/\D/g, '').substring(0, 8);
            if (value !== originalValue) {
                input.val(value);
            }

            if (isSubmit && value === "") {
                displayError(errorElementId, "El DNI es obligatorio.");
                input.addClass('is-invalid');
                return false;
            } else if (value.length > 0 && !regex.test(value)) {
                displayError(errorElementId, "El DNI debe tener 8 dígitos numéricos.");
                input.addClass('is-invalid');
                return false;
            } else {
                displayError(errorElementId, '');
                input.removeClass('is-invalid');
                return true;
            }
        }

        function validateCorreo(inputElementId, errorElementId, isSubmit = false) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (isSubmit && value === "") {
                displayError(errorElementId, "El correo electrónico es obligatorio.");
                input.addClass('is-invalid');
                return false;
            } else if (value.length > 0 && !regex.test(value)) {
                displayError(errorElementId, "Formato de correo electrónico inválido.");
                input.addClass('is-invalid');
                return false;
            }
            input.removeClass('is-invalid');
            displayError(errorElementId, '');
            return true;
        }

        function validateContrasena(inputElementId, errorElementId, isNewUser, isSubmit = false) {
            const input = $('#' + inputElementId);
            const value = input.val();
            const minLength = 8;
            const regexSegura = /^(?=.*[A-Z])(?=.*[!@#$%^&*()_+\-={}[\]:;"'<>,.?/~`\\|]).{8,}$/;

            // Mostrar requisitos dinámicamente (opcional)
            const reqLongitud = $('#reqLongitud');
            const reqMayuscula = $('#reqMayuscula');
            const reqEspecial = $('#reqEspecial');

            if (reqLongitud.length) reqLongitud.text(value.length >= minLength ? '✅ Al menos 8 caracteres' : '❌ Al menos 8 caracteres');
            if (reqMayuscula.length) reqMayuscula.text(/[A-Z]/.test(value) ? '✅ Una letra mayúscula' : '❌ Una letra mayúscula');
            if (reqEspecial.length) reqEspecial.text(/[!@#$%^&*()_+\-={}[\]:;"\'<>,.?/~`\\|]/.test(value) ? '✅ Un carácter especial' : '❌ Un carácter especial');


            if (isNewUser || (isSubmit && value.length > 0)) { // Contraseña obligatoria para nuevos usuarios, o si se está enviando y hay algo escrito
                if (value === "") {
                    displayError(errorElementId, "La contraseña es obligatoria.");
                    input.addClass('is-invalid');
                    return false;
                } else if (!regexSegura.test(value)) {
                    displayError(errorElementId, "Debe contener al menos 8 caracteres, una mayúscula y un símbolo.");
                    input.addClass('is-invalid');
                    return false;
                }
            } else if (!isNewUser && value.length > 0 && !regexSegura.test(value)) { // Si no es nuevo usuario y se está cambiando
                displayError(errorElementId, "Debe contener al menos 8 caracteres, una mayúscula y un símbolo.");
                input.addClass('is-invalid');
                return false;
            }

            input.removeClass('is-invalid');
            displayError(errorElementId, '');
            return true;
        }

        // Función asíncrona para verificar la unicidad del DNI
        async function checkDniUnico(dniInputId, dniErrorId, userId) {
            const dni = $('#' + dniInputId);
            const value = dni.val().trim();

            if (value.length !== 8) {
                // If not 8 digits, let the DNI format validation handle it
                return true;
            }

            let url = '/usuarios/checkDni?dni=' + value;
            if (userId) {
                url += '&idUsuario=' + userId;
            }

            try {
                const response = await $.ajax({
                    type: "GET",
                    url: url,
                    dataType: "json"
                });
                if (response.exists) {
                    displayError(dniErrorId, "Este DNI ya está registrado.");
                    $('#' + dniInputId).addClass('is-invalid');
                    return false;
                }
                $('#' + dniInputId).removeClass('is-invalid');
                displayError(dniErrorId, '');
                return true;
            } catch (error) {
                console.error("Error al verificar DNI:", error);
                displayError(dniErrorId, "Error al verificar DNI. Intenta de nuevo.");
                $('#' + dniInputId).addClass('is-invalid');
                return false;
            }
        }

        // ===========================================
        // FUNCIÓN PRINCIPAL DE VALIDACIÓN DEL FORMULARIO AL ENVIAR (MODAL)
        // ===========================================

        async function validarFormulario() {
            clearErrors(); // Limpiar todos los errores antes de revalidar

            let isValid = true;
            const isNewUser = $('#idUsuario').val() === '';

            // Validaciones que requieren valor no vacío para el submit
            if (!validateNombreApellido('nombre', 'nombreError', 'El nombre', true)) isValid = false;
            if (!validateNombreApellido('apPaterno', 'apPaternoError', 'El apellido paterno', true)) isValid = false;
            if (!validateNombreApellido('apMaterno', 'apMaternoError', 'El apellido materno', true)) isValid = false;
            if (!validateTelefono('telefono', 'telefonoError', true)) isValid = false;
            if (!validateDni('dni', 'dniError', true)) isValid = false;
            if (!validateCorreo('correo', 'correoError', true)) isValid = false;
            // Solo validamos la contraseña si es un nuevo usuario O si hay algo escrito en el campo de contraseña
            if (isNewUser || $('#contrasena').val().length > 0) {
                 if (!validateContrasena('contrasena', 'contrasenaError', isNewUser, true)) isValid = false;
            }


            // Validar selección de rol (siempre obligatoria)
            const rolSeleccionado = $('#rolUsuario').val();
            if (rolSeleccionado === null || rolSeleccionado === "" || rolSeleccionado === "0") {
                displayError('rolUsuarioError', 'Debe seleccionar un rol.');
                $('#rolUsuario').addClass('is-invalid');
                isValid = false;
            } else {
                $('#rolUsuario').removeClass('is-invalid');
                $('#rolUsuarioError').text('');
            }


            if (!isValid) {
                return false;
            }

            const userId = $('#idUsuario').val();
            const dniUnico = await checkDniUnico('dni', 'dniError', userId ? parseInt(userId) : null);
            if (!dniUnico) {
                isValid = false;
            }

            return isValid;
        }

        // ===========================================
        // MANEJADORES DE EVENTOS DEL MODAL Y FORMULARIO
        // ===========================================

        function abrirFormulario(url) {
            console.log("Intentando abrir formulario desde URL:", url);
            $('#modalFormContent').load(url, function(response, status, xhr) {
                if (status === "error") {
                    console.error("Error al cargar el formulario:", xhr.status, xhr.statusText, response);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al cargar formulario',
                        text: 'Hubo un problema al cargar el formulario. Por favor, inténtalo de nuevo.',
                        footer: `Detalles: ${xhr.status} ${xhr.statusText}`
                    });
                } else {
                    console.log("Formulario cargado exitosamente.");
                    clearErrors(); // Limpiar errores del formulario antes de mostrarlo

                    // Aplicar validaciones en tiempo real después de que el formulario se carga
                    $('#nombre').on('input', function() { validateNombreApellido('nombre', 'nombreError', 'El nombre'); });
                    $('#apPaterno').on('input', function() { validateNombreApellido('apPaterno', 'apPaternoError', 'El apellido paterno'); });
                    $('#apMaterno').on('input', function() { validateNombreApellido('apMaterno', 'apMaternoError', 'El apellido materno'); });
                    $('#dni').on('input', function() { validateDni('dni', 'dniError'); });
                    $('#telefono').on('input', function() { validateTelefono('telefono', 'telefonoError'); });
                    $('#correo').on('input', function() { validateCorreo('correo', 'correoError'); });
                    $('#contrasena').on('input', function() {
                        const isNewUser = $('#idUsuario').val() === '';
                        validateContrasena('contrasena', 'contrasenaError', isNewUser);
                    });

                    // Validar unicidad de DNI en tiempo real (con un debounce para no saturar el servidor)
                    let dniCheckTimeout;
                    $('#dni').on('input', function() {
                        clearTimeout(dniCheckTimeout);
                        dniCheckTimeout = setTimeout(async () => {
                            const userId = $('#idUsuario').val();
                            await checkDniUnico('dni', 'dniError', userId ? parseInt(userId) : null);
                        }, 500); // Espera 500ms después de que el usuario deja de escribir
                    });


                    $('#formUsuario').off('submit').on('submit', async function(e) {
                        e.preventDefault();
                        const formIsValid = await validarFormulario();
                        if (formIsValid) {
                            guardarUsuarioAjax($(this));
                        } else {
                            console.log("Formulario inválido. No se envía.");
                            mostrarNotificacion("error", "Por favor, corrige los errores en el formulario.");
                        }
                    });
                    $('#usuarioModal').modal('show');
                    console.log("Modal de usuario intentando mostrarse.");
                }
            });
        }

        function cerrarFormulario() {
            $('#usuarioModal').modal('hide');
            $('#modalFormContent').empty();
            clearErrors();
            console.log("Modal de usuario cerrado.");
        }

        // Función para guardar/actualizar usuario usando AJAX
        function guardarUsuarioAjax(formElement) {
            let formData = formElement.serialize();
            let url = formElement.attr('action');

            $.ajax({
                type: "POST",
                url: url,
                data: formData,
                success: function(response) {
                    if (response.status === "success") {
                        mostrarNotificacion("success", response.message);
                        cerrarFormulario();
                        aplicarFiltrosUsuarios(); // Ahora llama al nuevo método de filtrado
                    } else {
                        // Si hay errores de validación desde el backend (ej: DNI duplicado)
                        if (response.message) {
                            mostrarNotificacion("error", "Error: " + response.message);
                        } else {
                             mostrarNotificacion("error", "Error desconocido al guardar el usuario.");
                        }

                        // Puedes intentar mostrar errores específicos si el backend los envía en un formato esperado
                        // Por ejemplo, si el backend devuelve { "errors": { "dni": "DNI ya existe" } }
                        if (xhr.responseJSON && xhr.responseJSON.errors) {
                            for (const field in xhr.responseJSON.errors) {
                                displayError(field + 'Error', xhr.responseJSON.errors[field]);
                            }
                        }
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = "Error al procesar la solicitud.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ": " + xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        errorMessage += ": " + xhr.responseText.substring(0, 100) + "...";
                    }
                    mostrarNotificacion("error", errorMessage);
                    console.error("Error AJAX al guardar usuario:", error, xhr.responseText);
                }
            });
        }

        // Función para confirmar la eliminación de un usuario usando AJAX
        function confirmarEliminar(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log("Eliminando usuario con ID:", id);
                    $.ajax({
                        type: "GET",
                        url: '/usuarios/eliminar/' + id,
                        success: function(response) {
                            if (response.status === "success") {
                                mostrarNotificacion("success", response.message);
                                aplicarFiltrosUsuarios(); // Ahora llama al nuevo método de filtrado
                            } else {
                                mostrarNotificacion("error", "Error: " + response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            let errorMessage = "Error al eliminar el usuario.";
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ": " + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ": " + xhr.responseText.substring(0, 100) + "...";
                            }
                            mostrarNotificacion("error", errorMessage);
                            console.error("Error AJAX al eliminar usuario:", error, xhr.responseText);
                        }
                    });
                }
            });
        }

        // ===========================================
        // FUNCIONES DE FILTRADO Y REPORTE (SERVER-SIDE)
        // ===========================================

        // NUEVA FUNCIÓN: Aplica los filtros y recarga la tabla de usuarios via AJAX
        function aplicarFiltrosUsuarios() {
            const filterDTO = {
                nombreApellidoDniCorreo: $('#filtroNombreApellidoDniCorreo').val(),
                idRoles: [], // Se llenará con los roles seleccionados
                estados: [], // Se llenará con los estados seleccionados
                fechaRegistroStart: $('#fechaRegistroStartUserMain').val() === "" ? null : $('#fechaRegistroStartUserMain').val(),
                fechaRegistroEnd: $('#fechaRegistroEndUserMain').val() === "" ? null : $('#fechaRegistroEndUserMain').val()
            };

            // Llenar idRoles para un select simple
            const selectedRolId = $('#filtroIdRoles').val();
            if (selectedRolId !== "" && selectedRolId !== null) { // Si hay un rol seleccionado (no la opción "Todos los Roles")
                filterDTO.idRoles.push(parseInt(selectedRolId));
            }

            // Llenar estados
            $('.estado-checkbox-usuario-main:checked').each(function() {
                filterDTO.estados.push(parseInt($(this).val()));
            });

            const queryString = $.param(filterDTO);
            const url = '/usuarios/buscar?' + queryString;

            $.ajax({
                type: "GET",
                url: url,
                dataType: "json",
                success: function(response) {
                    renderizarTabla(response); // Renderizar la tabla con los usuarios filtrados del servidor
                },
                error: function(xhr, status, error) {
                    console.error("Error al buscar usuarios con filtros:", error, xhr.responseText);
                    mostrarNotificacion("error", "Error al buscar usuarios. Intenta de nuevo.");
                }
            });
        }

        // NUEVA FUNCIÓN: Ejecuta la generación del reporte PDF con los filtros
        function ejecutarGenerarReporteUsuarios() {
            Swal.fire({
                title: 'Generando Reporte...',
                text: 'Por favor, espera mientras se genera el PDF.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const filterDTO = {
                nombreApellidoDniCorreo: $('#filtroNombreApellidoDniCorreo').val(),
                idRoles: [],
                estados: [],
                fechaRegistroStart: $('#fechaRegistroStartUserMain').val() === "" ? null : $('#fechaRegistroStartUserMain').val(),
                fechaRegistroEnd: $('#fechaRegistroEndUserMain').val() === "" ? null : $('#fechaRegistroEndUserMain').val()
            };

            const selectedRolId = $('#filtroIdRoles').val();
            if (selectedRolId !== "" && selectedRolId !== null) {
                filterDTO.idRoles.push(parseInt(selectedRolId));
            }

            $('.estado-checkbox-usuario-main:checked').each(function() {
                filterDTO.estados.push(parseInt($(this).val()));
            });

            const queryString = $.param(filterDTO);
            const url = '/usuarios/reporte/pdf?' + queryString;

            setTimeout(() => {
                const newWindow = window.open(url, '_blank');
                if (newWindow) {
                    Swal.close();
                    mostrarNotificacion("success", "El reporte PDF se está generando y debería abrirse en una nueva pestaña.");
                } else {
                    Swal.close();
                    mostrarNotificacion("error", "Error: Tu navegador bloqueó la apertura del PDF. Por favor, permite los pop-ups para este sitio.");
                }
            }, 300);
        }

        // NUEVA FUNCIÓN: Limpia todos los filtros principales de usuario
        function limpiarFiltrosMainUsuario() {
            $('#mainUserFilterForm')[0].reset();
            // Desmarcar todos los checkboxes de estados
            $('.estado-checkbox-usuario-main').prop('checked', false);
            // Restablecer el select de roles a la opción por defecto
            $('#filtroIdRoles').val('');

            // Restablecer atributos max/min de las fechas
            setMainDateMaxAttributesUser();
            setMainDateMinAttributesUser();

            aplicarFiltrosUsuarios(); // Volver a cargar la tabla sin filtros
        }

        // Función para cargar los roles en el select del filtro
        function cargarRolesEnFiltro() {
            $.ajax({
                type: "GET",
                url: '/roles/all', // Este endpoint DEBE existir y devolver los roles
                dataType: "json",
                success: function(roles) {
                    const select = $('#filtroIdRoles');
                    select.empty();
                    // select.append('<option value="">Seleccione Rol(es)</option>'); // No es necesario si es multiple y tiene placeholder
                    roles.forEach(rol => {
                        select.append(`<option value="${rol.idRol}">${rol.tipoRol}</option>`);
                    });

                },
                error: function(xhr, status, error) {
                    console.error("Error al cargar roles para el filtro de usuarios:", error);
                    mostrarNotificacion("error", "Error al cargar los roles. Verifica el endpoint /roles/all.");
                }
            });
        }


        // Funciones para manejar los atributos min/max de los campos de fecha en el filtro principal
        function setMainDateMaxAttributesUser() {
            const today = new Date().toISOString().split('T')[0];
            $('#fechaRegistroStartUserMain').attr('max', today);

            const fechaFin = $('#fechaRegistroEndUserMain').val();
            if (fechaFin && $('#fechaRegistroStartUserMain').val() && new Date(fechaFin) < new Date($('#fechaRegistroStartUserMain').val())) {
                $('#fechaRegistroEndUserMain').val($('#fechaRegistroStartUserMain').val());
            }
            // Asegura que la fecha de fin no sea anterior a la de inicio
            $('#fechaRegistroEndUserMain').attr('min', $('#fechaRegistroStartUserMain').val() || '');
        }

        function setMainDateMinAttributesUser() {
            const today = new Date().toISOString().split('T')[0];
            $('#fechaRegistroEndUserMain').attr('max', today);

            const fechaInicio = $('#fechaRegistroStartUserMain').val();
            if (fechaInicio && $('#fechaRegistroEndUserMain').val() && new Date(fechaInicio) > new Date($('#fechaRegistroEndUserMain').val())) {
                $('#fechaRegistroStartUserMain').val($('#fechaRegistroEndUserMain').val());
            }
            // Asegura que la fecha de inicio no sea posterior a la de fin
            $('#fechaRegistroStartUserMain').attr('max', $('#fechaRegistroEndUserMain').val() || today);
        }

        // Función para mostrar notificaciones usando AdminLTE Toasts
        function mostrarNotificacion(type, message) {
            $(document).Toasts('create', {
                class: type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-info' : 'bg-danger'),
                title: type === 'success' ? 'Éxito' : (type === 'info' ? 'Información' : 'Error'),
                body: message,
                autohide: true,
                delay: 3000
            });
        }

        function cambiarEstadoUsuario(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¿Deseas cambiar el estado del usuario?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, cambiar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/usuarios/cambiarEstado/' + id,
                        type: 'GET',
                        success: function(response) {
                            if (response.status === "success") {
                                mostrarNotificacion("success", response.message);
                                aplicarFiltrosUsuarios(); // Ahora llama al nuevo método de filtrado
                            } else {
                                mostrarNotificacion("error", response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            mostrarNotificacion("error", "Error al cambiar el estado del usuario.");
                            console.error("Error AJAX al cambiar estado:", xhr.responseText);
                        }
                    });
                }
            });
        }
        // Ejecutar al cargar la página por primera vez
        $(document).ready(function() {
            // Importante: Cargar roles primero, y luego aplicar filtros para que la tabla se llene.
            cargarRolesEnFiltro();
            setMainDateMaxAttributesUser();
            setMainDateMinAttributesUser();
            // Retrasar ligeramente la aplicación de filtros para asegurar que selectpicker se inicialice
            setTimeout(aplicarFiltrosUsuarios, 100);
        });

        /*]]>*/
    </script>
</th:block>
</html>
