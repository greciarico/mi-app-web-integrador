<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title layout:fragment="title">Gestión de IGV</title>
</head>

<section layout:fragment="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Registros de IGV</h3>
                        <div class="card-tools">
                            <a href="javascript:void(0)" onclick="abrirFormularioIgv('/tasa/nuevo')"
                               class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                                <i class="fas fa-plus"></i> Crear Nuevo IGV
                            </a>
                        </div>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body">
                        <!-- BUSCADOR SIMPLIFICADO DE IGV -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="input-group">
                                    <input type="search" id="searchTermIgv" class="form-control" placeholder="Buscar por valor, estado, descripción..."
                                           onkeyup="aplicarFiltrosIgv()"/>
                                    <div class="input-group-append">
                                        <button class="btn btn-default" type="button" onclick="aplicarFiltrosIgv()">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- FIN BUSCADOR SIMPLIFICADO DE IGV -->

                        <!-- Tabla de IGV -->
                        <div id="tablaIgvContainer">
                            <table id="igvTable" class="table table-bordered table-striped">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Valor IGV</th>
                                    <th>Fecha Registro</th>
                                    <th>Descripción</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody id="igvTableBody">
                                <!-- Contenido de la tabla se generará con JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- /.card-body -->
                </div>
                <!-- /.card -->
            </div>
            <!-- /.col -->
        </div>
        <!-- /.row -->
    </div>
    <!-- /.container-fluid -->

    <!-- Modal para el Formulario de IGV -->
    <div class="modal fade" id="igvModal" tabindex="-1" role="dialog" aria-labelledby="igvModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div id="modalFormContentIgv">
                    <!-- El fragmento igv_form_modal.html se insertará aquí -->
                </div>
            </div>
        </div>
    </div>
</section>
<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        /*<![CDATA[*/

        // Variable global para almacenar todos los registros de IGV
        allIgvs = /*[[${igvs}]]*/ [];

        // Función para renderizar la tabla con una lista de IGV
        function renderizarTablaIgv(igvsToDisplay) {
            const tableBody = $('#igvTableBody');
            tableBody.empty();

            if (igvsToDisplay.length === 0) {
                tableBody.append('<tr><td colspan="6" class="text-center">No se encontraron registros de IGV.</td></tr>');
                return;
            }

            igvsToDisplay.forEach(tasa => {
                const estadoText = tasa.estado === 1 ? 'Activo' : 'Inactivo';
                const estadoClass = tasa.estado === 1 ? 'badge badge-success badge-pill' : 'badge badge-danger badge-pill';
                const fechaRegistroFormatted = tasa.fechaRegistro ? new Date(tasa.fechaRegistro).toLocaleDateString('es-ES') : 'N/A';
                // Para mostrar en la tabla, multiplicamos por 100 para el porcentaje (sin decimales)
                const igvValueFormatted = tasa.tasa ? (parseFloat(tasa.tasa) * 100).toFixed(0) + '%' : 'N/A';

                const row = `
                    <tr>
                        <td>${tasa.idIgv}</td>
                        <td>${igvValueFormatted}</td>
                        <td>${fechaRegistroFormatted}</td>
                        <td>${tasa.descripcion || 'N/A'}</td>
                        <td class="text-center"><span class="${estadoClass}">${estadoText}</span></td>
                        <td>
                            <a href="javascript:void(0)" onclick="abrirFormularioIgv('/tasa/editar/${tasa.idIgv}')"
                               class="btn btn-info btn-sm">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="javascript:void(0)" onclick="confirmarEliminarIgv(${tasa.idIgv})"
                               class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tableBody.append(row);
            });
        }

        /**
         * Limpia mensajes de error y clases inválidas
         * SOLO dentro del contenedor que le pases.
         *
         * @param {string|HTMLElement} container – selector o elemento DOM
         */
        function clearErrors(container) {
          const $c = (container instanceof HTMLElement)
            ? $(container)
            : $(container);
          $c.find('.text-danger').text('');
          $c.find('.is-invalid').removeClass('is-invalid');
        }

        // Función para mostrar un mensaje de error específico (genérica)
        function displayError(elementId, message) {
            $('#' + elementId).text(message);
            $('#' + elementId).prevAll('.form-control').first().addClass('is-invalid');
        }

        // ===========================================
        // FUNCIONES DE VALIDACIÓN ESPECÍFICAS (PARA IGV)
        // ===========================================

        function validateTasaValue(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            if (input.length === 0) {
                console.error("Elemento no encontrado con ID:", inputElementId);
                return false;
            }
            const value = input.val().trim();
            const numValue = parseFloat(value); // Usamos parseFloat para decimales

            if (value === "") {
                displayError(errorElementId, "El valor es obligatorio.");
                return false;
            } else if (isNaN(numValue) || numValue <= 0) { // Validación más simple para números positivos
                displayError(errorElementId, "El valor debe ser un número positivo (ej: 0.18).");
                return false;
            }
            input.removeClass('is-invalid');
            return true;
        }

        // Función principal de validación del formulario de IGV
        async function validarFormularioIgv() {
            clearErrors('#formIgv');
            let isValid = true;

            // Llamamos a la nueva función de validación para el campo 'tasa'
            // y usamos un id de error más específico 'tasaError'
            if (!validateTasaValue('tasa', 'tasaError')) isValid = false;

            return isValid;
        }


        // ===========================================
        // MANEJADORES DE EVENTOS DEL MODAL Y FORMULARIO DE IGV
        // ===========================================

       function abrirFormularioIgv(url) {
          console.log("Intentando abrir formulario de IGV desde URL:", url);
          $('#modalFormContentIgv').load(url, function(response, status, xhr) {
            if (status === "error") {
              console.error("Error al cargar el formulario de IGV:", xhr.status, xhr.statusText, response);
              Swal.fire({
                icon: 'error',
                title: 'Error al cargar formulario',
                text: 'Hubo un problema al cargar el formulario. Por favor, inténtalo de nuevo.',
                footer: `Detalles: ${xhr.status} ${xhr.statusText}`
              });
              return;
            }

            console.log("Formulario de IGV cargado exitosamente.");

            // 1) Limpia errores previos SOLO de este form
            clearErrors('#formIgv');

            // 2) Adjunta validaciones en tiempo real (si las tienes)
            // p.ej. $('#tasa').on('input', ...);

            // 3) Captura el submit
            $('#formIgv').off('submit').on('submit', async function(e) {
              e.preventDefault();
              const formIsValid = await validarFormularioIgv();
              if (formIsValid) {
                guardarIgvAjax(); // tu función que envía el AJAX
              } else {
                console.log("Formulario de IGV inválido. No se envía.");
                mostrarNotificacion("error", "Por favor, corrige los errores en el formulario.");
              }
            });

            // 4) Muestra el modal
            $('#igvModal').modal('show');
            console.log("Modal de IGV intentando mostrarse.");
          });
        }


        function cerrarFormularioIgv() {
            $('#igvModal').modal('hide');
            $('#modalFormContentIgv').empty();
            clearErrors('#formIgv');
            console.log("Modal de IGV cerrado.");
        }

        // MODIFICADO: Esta función ahora construye los datos manualmente para AJAX y envía como JSON
        function guardarIgvAjax() {
            // Recoge los datos directamente del formulario
            const idIgv = $('#idIgv').val();
            const fechaRegistro = $('#fechaRegistro').val();

            // Lee directamente el valor decimal del campo 'tasa'
            const tasaValue = parseFloat($('#tasa').val());

            const descripcion = $('#descripcion').val();
            const estado = $('#estado').val();

            // Construye el objeto de datos para enviar
            const dataToSend = {
                idIgv: idIgv === '' ? null : parseInt(idIgv, 10),
                fechaRegistro: fechaRegistro,
                tasa: tasaValue, // Envía el valor decimal directamente
                descripcion: descripcion,
                estado: parseInt(estado, 10)
            };

            const url = '/tasa/guardar';

            $.ajax({
                type: "POST",
                url: url,
                contentType: 'application/json',
                data: JSON.stringify(dataToSend),
                success: function(response) {
                    if (response.status === "success") {
                        mostrarNotificacion("success", response.message);
                        cerrarFormularioIgv();
                        recargarListaIgvCompleta();
                    } else {
                        mostrarNotificacion("error", "Error: " + response.message);
                    }
                },
                error: function(xhr) {
                    let errorMessage = "Error al procesar la solicitud.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ": " + xhr.responseJSON.message;
                    }
                    mostrarNotificacion("error", errorMessage);
                }
            });
        }


        function confirmarEliminarIgv(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log("Eliminando IGV con ID:", id);
                    $.ajax({
                        type: "GET", // La eliminación lógica es un GET aquí
                        url: '/tasa/eliminar/' + id,
                        success: function(response) {
                            if (response.status === "success") {
                                mostrarNotificacion("success", response.message);
                                recargarListaIgvCompleta();
                            } else {
                                mostrarNotificacion("error", "Error: " + response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            let errorMessage = "Error al eliminar el IGV.";
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ": " + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ": " + xhr.responseText.substring(0, Math.min(xhr.responseText.length, 100)) + "...";
                            }
                            mostrarNotificacion("error", errorMessage);
                            console.error("Error AJAX al eliminar IGV:", error, xhr.responseText);
                        }
                    });
                }
            });
        }

        // ===========================================
        // FUNCIONES DE FILTRADO Y REPORTE DE IGV (CLIENT-SIDE)
        // ===========================================

        // Esta función debe ser global para que layout.html pueda llamarla
        function recargarListaIgvCompleta() {
            $.ajax({
                type: "GET",
                url: '/tasa/all',
                dataType: "json",
                success: function(response) {
                    allIgvs = response;
                    aplicarFiltrosIgv(); // Aplicar el filtro actual
                },
                error: function(xhr, status, error) {
                    console.error("Error al recargar la lista completa de IGV:", error);
                    mostrarNotificacion("error", "Error al recargar la lista de IGV. Verifica el endpoint /tasa/all en tu backend.");
                }
            });
        }

        function aplicarFiltrosIgv() {
            const searchTerm = $('#searchTermIgv').val().toLowerCase().trim();
            let filteredIgvs = allIgvs;

            if (searchTerm) {
                if (searchTerm === 'activo') {
                    filteredIgvs = allIgvs.filter(tasa => tasa.estado === 1);
                } else if (searchTerm === 'inactivo') {
                    filteredIgvs = allIgvs.filter(tasa => tasa.estado === 0);
                } else {
                    filteredIgvs = allIgvs.filter(tasa => {
                        const estadoText = tasa.estado === 1 ? 'activo' : 'inactivo';
                        // Convertir el valor numérico a string para buscar en porcentaje
                        const igvValuePercentageString = tasa.tasa ? (parseFloat(tasa.tasa) * 100).toFixed(0).toString() : '';
                        return (
                            igvValuePercentageString.includes(searchTerm) ||
                            (tasa.descripcion && tasa.descripcion.toLowerCase().includes(searchTerm)) ||
                            estadoText.includes(searchTerm)
                        );
                    });
                }
            }
            renderizarTablaIgv(filteredIgvs);
        }

        function generarReporteIgv() {
            mostrarNotificacion("info", "La funcionalidad de generar reporte de IGV aún no está implementada.");
        }

        // Función para mostrar notificaciones usando AdminLTE Toasts
        function mostrarNotificacion(type, message) {
            $(document).Toasts('create', {
                class: type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-info' : 'bg-danger'),
                title: type === 'success' ? 'Éxito' : (type === 'info' ? 'Información' : 'Error'),
                body: message,
                autohide: true,
                delay: 3000
            });
        }


        // Ejecutar al cargar la página por primera vez
        $(document).ready(function() {
            aplicarFiltrosIgv(); // Renderizar la tabla inicialmente con todos los IGV (y aplicar filtro si hay)
        });

        /*]]>*/
    </script>
</th:block>
</html>
