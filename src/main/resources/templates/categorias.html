<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title layout:fragment="title">Gestión de Categorías</title>
</head>

<section layout:fragment="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Categorías</h3>
                        <div class="card-tools">
                            <a href="javascript:void(0)" onclick="abrirFormularioCategoria('/categorias/nuevo')"
                               class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                                <i class="fas fa-plus"></i> Crear Nueva Categoría
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-info" type="button" data-toggle="collapse" data-target="#collapseCategoryFilters" aria-expanded="false" aria-controls="collapseCategoryFilters">
                                <i class="fas fa-filter"></i> Mostrar/Ocultar Filtros de Categorías
                            </button>
                        </div>

                        <div class="collapse" id="collapseCategoryFilters">
                            <div class="card card-body">
                                <form id="mainFilterForm" onsubmit="event.preventDefault(); aplicarFiltrosCategorias();">
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="filtroNombreCategoriaMain">Buscar por Nombre de Categoría:</label>
                                            <input type="text" id="filtroNombreCategoriaMain" name="nombreCategoria" class="form-control" placeholder="Ej. Aceite, Jarabe"/>
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label>Por Estado:</label><br>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input estado-checkbox-categoria-main" type="checkbox" id="estadoActivoMain" name="estados" value="1">
                                                <label class="form-check-label" for="estadoActivoMain">Activo</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input estado-checkbox-categoria-main" type="checkbox" id="estadoInactivoMain" name="estados" value="0">
                                                <label class="form-check-label" for="estadoInactivoMain">Inactivo</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <button class="btn btn-default" type="submit">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                        <button class="btn btn-primary ml-2" style="background-color:#b45f06 !important; border-color:#b45f06 !important;" type="button" onclick="ejecutarGenerarReporteCategorias()">
                                            <i class="fas fa-file-pdf"></i> Generar Reporte PDF
                                        </button>
                                        <button class="btn btn-secondary ml-2" type="button" onclick="limpiarFiltrosMain()">
                                            <i class="fas fa-redo"></i> Limpiar Filtros
                                        </button>
                                    </div>
                                </form>
                                <div class="alert alert-info text-center mt-3" role="alert">
                                    <i class="fas fa-info-circle"></i> Deje todas las opciones de filtro sin marcar para buscar/generar un reporte de todas las categorías.
                                </div>
                            </div>
                        </div>
                        <div id="tablaCategoriasContainer" class="mt-3"> <table id="categoriasTable" class="table table-bordered table-striped">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre Categoría</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                            </thead>
                            <tbody id="categoriasTableBody">
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="categoriaModal" tabindex="-1" role="dialog" aria-labelledby="categoriaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div id="modalFormContentCategoria">
                </div>
            </div>
        </div>
    </div>
</section>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        /*<![CDATA[*/

        allCategorias = /*[[${categorias}]]*/ []; // Esto solo carga las iniciales, se actualizará al buscar.


        // Función para renderizar la tabla con una lista de categorías
        function renderizarTablaCategorias(categoriasToDisplay) {
            const tableBody = $('#categoriasTableBody');
            tableBody.empty();

            if (categoriasToDisplay.length === 0) {
                // El colspan se mantiene en 4 para Categorías
                tableBody.append('<tr><td colspan="4" class="text-center">No se encontraron categorías.</td></tr>');
                return;
            }

            categoriasToDisplay.forEach(categoria => {
                const estadoText = categoria.estado === 1 ? 'Activo' : 'Inactivo';
                const estadoClass = categoria.estado === 1 ? 'badge badge-success badge-pill' : 'badge badge-danger badge-pill';

                const row = `
                    <tr>
                        <td>${categoria.idCategoria}</td>
                        <td>${categoria.nombreCategoria}</td>
                        <td class="text-center"><span class="${estadoClass}">${estadoText}</span></td>
                        <td>
                            <a href="javascript:void(0)" onclick="abrirFormularioCategoria('/categorias/editar/${categoria.idCategoria}')"
                               class="btn btn-info btn-sm">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="javascript:void(0)" onclick="confirmarEliminarCategoria(${categoria.idCategoria})"
                               class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tableBody.append(row);
            });
        }

        /**
           * Limpia mensajes de error y clases inválidas
           * SOLO dentro del contenedor que le pases.
           *
           * @param {string|HTMLElement} container – selector o elemento DOM
           */
          function clearErrors(container) {
            const $c = (container instanceof HTMLElement)
              ? $(container)
              : $(container);
            $c.find('.text-danger').text('');
            $c.find('.is-invalid').removeClass('is-invalid');
          }

        // Función para mostrar un mensaje de error específico (genérica)
        function displayError(elementId, message) {
            $('#' + elementId).text(message);
            // Asegúrate de que el ID que pasas aquí corresponda al span de error,
            // y que el input esté justo antes del span o se pueda seleccionar correctamente.
            $('#' + elementId).prevAll('.form-control').first().addClass('is-invalid');
        }

        // ===========================================
        // FUNCIONES DE VALIDACIÓN ESPECÍFICAS (PARA CATEGORÍAS)
        // ===========================================

        function validateNombreCategoria(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            if (value === "") {
                displayError(errorElementId, "El nombre de la categoría es obligatorio.");
                return false;
            }
            input.removeClass('is-invalid');
            return true;
        }

        async function checkNombreCategoriaUnico(nombreCategoriaInputId, nombreCategoriaErrorId, categoriaId) {
            const nombreCategoria = $('#' + nombreCategoriaInputId).val();
            if (nombreCategoria.trim() === "") {
                return true; // La validación de campo obligatorio ya lo manejará
            }

            let url = '/categorias/checkNombreCategoria?nombreCategoria=' + encodeURIComponent(nombreCategoria);
            if (categoriaId) {
                url += '&idCategoria=' + categoriaId;
            }

            try {
                const response = await $.ajax({
                    type: "GET",
                    url: url,
                    dataType: "json"
                });
                if (response.exists) {
                    displayError(nombreCategoriaErrorId, "Este nombre de categoría ya está registrado.");
                    return false;
                }
                return true;
            } catch (error) {
                console.error("Error al verificar nombre de categoría:", error);
                displayError(nombreCategoriaErrorId, "Error al verificar nombre de categoría. Intenta de nuevo.");
                return false;
            }
        }

        // Función principal de validación del formulario de Categoría
        async function validarFormularioCategoria() {
            clearErrors('#formCategoria'); // Asumo que el ID del formulario en el modal sigue siendo 'formCategoria'
            let isValid = true;

            if (!validateNombreCategoria('nombreCategoria', 'nombreCategoriaError')) isValid = false;

            if (!isValid) return false;

            const categoriaId = $('#idCategoria').val();
            const nombreCategoriaUnico = await checkNombreCategoriaUnico('nombreCategoria', 'nombreCategoriaError', categoriaId ? parseInt(categoriaId) : null);
            if (!nombreCategoriaUnico) isValid = false;

            return isValid;
        }

        // ===========================================
        // MANEJADORES DE EVENTOS DEL MODAL Y FORMULARIO DE CATEGORÍA
        // ===========================================

         function abrirFormularioCategoria(url) {
            console.log("Intentando abrir formulario de categoria desde URL:", url);
            $('#modalFormContentCategoria').load(url, function(response, status, xhr) {
              if (status === "error") {
                console.error("Error al cargar el formulario de categoria:", xhr.status, xhr.statusText, response);
                Swal.fire({
                  icon: 'error',
                  title: 'Error al cargar formulario',
                  text: 'Hubo un problema al cargar el formulario. Por favor, inténtalo de nuevo.',
                  footer: `Detalles: ${xhr.status} ${xhr.statusText}`
                });
                return;
              }

              console.log("Formulario de categoria cargado exitosamente.");

              // 1) Limpia errores previos SOLO de este form
              clearErrors('#formCategoria'); // Asumo que el ID del formulario en el modal sigue siendo 'formCategoria'

              // 2) (Opcional) Adjunta validaciones en tiempo real
              // p.ej. $('#nombreCategoria').on('input', () => validarNombreProducto());

              // 3) Captura el submit
              $('#formCategoria')
                .off('submit')
                .on('submit', async function(e) {
                  e.preventDefault();
                  // IMPORTANTE: Cambiado a validarFormularioCategoria, no Producto
                  const formIsValid = await validarFormularioCategoria();
                  if (formIsValid) {
                    guardarCategoriaAjax($(this)); // Cambiado a guardarCategoriaAjax
                  } else {
                    console.log("Formulario de categoria inválido. No se envía.");
                    mostrarNotificacion("error", "Por favor, corrige los errores en el formulario.");
                  }
                });

              // 4) Mostrar modal
              $('#categoriaModal').modal('show');
              console.log("Modal de categoria intentando mostrarse.");
            });
          }


        function cerrarFormularioCategoria() {
            $('#categoriaModal').modal('hide');
            $('#modalFormContentCategoria').empty();
            clearErrors('#formCategoria');
            console.log("Modal de categoría cerrado.");
        }

        function guardarCategoriaAjax(formElement) {
            let formData = formElement.serialize();
            let url = formElement.attr('action');

            $.ajax({
                type: "POST",
                url: url,
                data: formData,
                success: function(response) {
                    if (response.status === "success") {
                        mostrarNotificacion("success", response.message);
                        cerrarFormularioCategoria();
                        // Al guardar, recarga la lista usando los filtros actuales del mainFilterForm
                        aplicarFiltrosCategorias();
                    } else {
                        // Si hay un error de validación del backend (ej. nombre duplicado)
                        // Aquí deberías mapear los errores a los campos del formulario
                        if (response.errors) {
                             // Asumimos que response.errors es un objeto directamente, no un JSON string
                            for (const [key, value] of Object.entries(response.errors)) {
                                displayError(key + 'Error', value);
                            }
                        }
                        mostrarNotificacion("error", "Error: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = "Error al procesar la solicitud.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ": " + xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        errorMessage += ": " + xhr.responseText.substring(0, 100) + "...";
                    }
                    mostrarNotificacion("error", errorMessage);
                    console.error("Error AJAX al guardar categoría:", error, xhr.responseText);
                }
            });
        }

        function confirmarEliminarCategoria(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log("Eliminando categoría con ID:", id);
                    $.ajax({
                        type: "GET",
                        url: '/categorias/eliminar/' + id,
                        success: function(response) {
                            if (response.status === "success") {
                                mostrarNotificacion("success", response.message);
                                // Después de eliminar, recarga la lista con los filtros actuales
                                aplicarFiltrosCategorias();
                            } else {
                                mostrarNotificacion("error", "Error: " + response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            let errorMessage = "Error al eliminar la categoría.";
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ": " + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ": " + xhr.responseText.substring(0, 100) + "...";
                            }
                            mostrarNotificacion("error", errorMessage);
                            console.error("Error AJAX al eliminar categoría:", error, xhr.responseText);
                        }
                    });
                }
            });
        }

        // ===========================================
        // FUNCIONES DE FILTRADO Y REPORTE DE CATEGORÍAS (SERVER-SIDE)
        // ===========================================

        // Esta función ahora enviará los filtros al servidor y recargará la tabla
        function aplicarFiltrosCategorias() {
            const nombreCategoria = $('#filtroNombreCategoriaMain').val();
            const estados = [];
            $('.estado-checkbox-categoria-main:checked').each(function() {
                estados.push($(this).val());
            });

            // Construir el objeto CategoriaFilterDTO
            const filterDTO = {
                nombreCategoria: nombreCategoria,
                estados: estados
            };

            // Convertir el DTO a query string para el GET request
            const queryString = $.param(filterDTO);
            const url = '/categorias/buscar?' + queryString; // Nuevo endpoint para buscar/filtrar

            $.ajax({
                type: "GET",
                url: url,
                dataType: "json",
                success: function(response) {
                    renderizarTablaCategorias(response);
                },
                error: function(xhr, status, error) {
                    console.error("Error al buscar categorías con filtros:", error, xhr.responseText);
                    mostrarNotificacion("error", "Error al buscar categorías. Intenta de nuevo.");
                }
            });
        }

        // Ya no es necesario abrir un modal, se genera el PDF directamente
        function ejecutarGenerarReporteCategorias() {
            Swal.fire({
                title: 'Generando Reporte...',
                text: 'Por favor, espera mientras se genera el PDF.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const nombreCategoria = $('#filtroNombreCategoriaMain').val();
            const estados = [];
            $('.estado-checkbox-categoria-main:checked').each(function() {
                estados.push($(this).val());
            });

            // Construir el objeto CategoriaFilterDTO
            const filterDTO = {
                nombreCategoria: nombreCategoria,
                estados: estados
            };

            // Convertir el DTO a query string para el GET request
            const queryString = $.param(filterDTO);
            const url = '/categorias/reporte/pdf?' + queryString;

            setTimeout(() => { // Pequeño delay para asegurar que el Swal.showLoading() se vea
                const newWindow = window.open(url, '_blank');
                if (newWindow) {
                    Swal.close();
                    mostrarNotificacion("success", "El reporte PDF se está generando y debería abrirse en una nueva pestaña.");
                } else {
                    Swal.close();
                    mostrarNotificacion("error", "Error: Tu navegador bloqueó la apertura del PDF. Por favor, permite los pop-ups para este sitio.");
                }
            }, 300);
        }

        // Función para limpiar los filtros del formulario principal
        function limpiarFiltrosMain() {
            $('#filtroNombreCategoriaMain').val('');
            $('.estado-checkbox-categoria-main').prop('checked', false);
            aplicarFiltrosCategorias(); // Vuelve a cargar la tabla sin filtros
        }


        // Función para mostrar notificaciones usando AdminLTE Toasts
        function mostrarNotificacion(type, message) {
            $(document).Toasts('create', {
                class: type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-info' : 'bg-danger'),
                title: type === 'success' ? 'Éxito' : (type === 'info' ? 'Información' : 'Error'),
                body: message,
                autohide: true,
                delay: 3000
            });
        }

        // Ejecutar al cargar la página por primera vez
        $(document).ready(function() {
            aplicarFiltrosCategorias(); // Carga inicial de datos con los filtros (vacíos al inicio)
        });

        /*]]>*/
    </script>
</th:block>
</html>
