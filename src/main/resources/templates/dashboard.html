<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title layout:fragment="title">Dashboard</title>
</head>
<section layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Resumen General</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="form-group">
                        <label for="dashboardPeriod">Seleccionar Período (para los cuadros):</label>
                        <select class="form-control" id="dashboardPeriod">
                            <option value="today">Hoy</option>
                            <option value="weekly">Semanal</option>
                            <option value="monthly" selected>Mensual</option>
                            <option value="yearly">Anual</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-info">
                        <div class="inner">
                            <h3 id="totalSalesAmount">S/ 0.00</h3>
                            <p>Total Ventas</p>
                        </div>
                        <div class="icon">
                            <i class="ion ion-cash"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-success">
                        <div class="inner">
                            <h3 id="numberOfSales">0</h3>
                            <p>Cantidad de Ventas</p>
                        </div>
                        <div class="icon">
                            <i class="ion ion-bag"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-warning">
                        <div class="inner">
                            <h3 id="userRegistrations">0</h3>
                            <p>Usuarios Registrados</p>
                        </div>
                        <div class="icon">
                            <i class="ion ion-person-add"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-danger">
                        <div class="inner">
                            <h3 id="clientRegistrations">0</h3>
                            <p>Clientes Registrados</p>
                        </div>
                        <div class="icon">
                            <i class="ion ion-pie-graph"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <div class="card card-primary card-outline">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="far fa-chart-bar"></i>
                                Ventas y Compras por Mes
                            </h3>
                        </div>
                        <div class="card-body">
                            <canvas id="salesPurchasesChart" style="height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</section>
<th:block layout:fragment="scripts">
    <script>
        $(document).ready(function() {
          console.log("jQuery y el DOM están listos en layout.html.");

          // Variable global para almacenar la instancia del gráfico
          let mySalesPurchasesChart;

          // Function to load dashboard stats data (small boxes)
          function loadDashboardStatsData(period) {
            console.log("Cargando datos de los small boxes para el período:", period);
            $.ajax({
                url: '/api/dashboard/stats?period=' + period,
                method: 'GET',
                success: function(data) {
                    $('#totalSalesAmount').text('S/ ' + data.totalSales.toFixed(2));
                    $('#numberOfSales').text(data.numberOfSales);
                    $('#userRegistrations').text(data.userRegistrations);
                    $('#clientRegistrations').text(data.clientRegistrations);
                },
                error: function(xhr, status, error) {
                    console.error("Error al cargar datos de los small boxes:", xhr.status, xhr.statusText, error);
                    $('#totalSalesAmount').text('Error');
                    $('#numberOfSales').text('Error');
                    $('#userRegistrations').text('Error');
                    $('#clientRegistrations').text('Error');
                }
            });
          }

          // Function to load and render the sales/purchases chart
          function loadSalesPurchasesChart() {
              console.log("Cargando datos para el gráfico de ventas y compras.");
              $.ajax({
                  url: '/api/dashboard/chart-data', // Endpoint para los datos del gráfico
                  method: 'GET',
                  success: function(data) {
                      const labels = data.labels; // Nombres de los meses (Enero, Febrero, etc.)
                      const thisYearSales = data.thisYearSales;
                      const lastYearSales = data.lastYearSales;
                      const thisYearPurchases = data.thisYearPurchases;
                      const lastYearPurchases = data.lastYearPurchases;

                      const ctx = document.getElementById('salesPurchasesChart').getContext('2d');

                      // Destruir el gráfico existente si lo hay para evitar duplicados
                      if (mySalesPurchasesChart) {
                          mySalesPurchasesChart.destroy();
                      }

                      mySalesPurchasesChart = new Chart(ctx, {
                          type: 'bar', // Tipo de gráfico: barras
                          data: {
                              labels: labels, // Eje X: Meses
                              datasets: [
                                  {
                                      label: 'Ventas ' + new Date().getFullYear(),
                                      backgroundColor: 'rgba(0, 123, 255, 0.7)', // Azul AdminLTE info
                                      borderColor: 'rgba(0, 123, 255, 1)',
                                      borderWidth: 1,
                                      data: thisYearSales,
                                      // Estos dos ayudan a agrupar barras si hay múltiples datasets por label (mes)
                                      barPercentage: 0.5,
                                      categoryPercentage: 0.6
                                  },
                                   {
                                      label: 'Compras ' + new Date().getFullYear(),
                                      backgroundColor: 'rgba(40, 167, 69, 0.7)', // Verde AdminLTE success
                                      borderColor: 'rgba(40, 167, 69, 1)',
                                      borderWidth: 1,
                                      data: thisYearPurchases,
                                      barPercentage: 0.5,
                                      categoryPercentage: 0.6
                                  },
                                  {
                                      label: 'Ventas ' + (new Date().getFullYear() - 1),
                                      backgroundColor: 'rgba(108, 117, 125, 0.5)', // Gris AdminLTE secondary
                                      borderColor: 'rgba(108, 117, 125, 1)',
                                      borderWidth: 1,
                                      data: lastYearSales,
                                      barPercentage: 0.5,
                                      categoryPercentage: 0.6
                                  },
                                   {
                                      label: 'Compras ' + (new Date().getFullYear() - 1),
                                      backgroundColor: 'rgba(255, 193, 7, 0.5)', // Amarillo AdminLTE warning
                                      borderColor: 'rgba(255, 193, 7, 1)',
                                      borderWidth: 1,
                                      data: lastYearPurchases,
                                      barPercentage: 0.5,
                                      categoryPercentage: 0.6
                                  }
                              ]
                          },
                          options: {
                              responsive: true,
                              maintainAspectRatio: false, // Permite que el gráfico no mantenga siempre la misma relación de aspecto
                              scales: {
                                  y: {
                                      beginAtZero: true,
                                      title: {
                                          display: true,
                                          text: 'Monto (S/)'
                                      }
                                  },
                                  x: {
                                      title: {
                                          display: true,
                                          text: 'Mes'
                                      }
                                  }
                              },
                              plugins: {
                                  tooltip: {
                                      callbacks: {
                                          label: function(context) {
                                              let label = context.dataset.label || '';
                                              if (label) {
                                                  label += ': ';
                                              }
                                              if (context.parsed.y !== null) {
                                                  label += 'S/ ' + context.parsed.y.toFixed(2);
                                              }
                                              return label;
                                          }
                                      }
                                  }
                              }
                          }
                      });
                  },
                  error: function(xhr, status, error) {
                      console.error("Error al cargar datos del gráfico:", xhr.status, xhr.statusText, error);
                  }
              });
          }


          // --- Ejecución inicial y manejadores de eventos ---

          // Carga inicial de datos para los small boxes (período por defecto 'monthly')
          loadDashboardStatsData($('#dashboardPeriod').val());
          // Carga inicial de datos para el gráfico
          loadSalesPurchasesChart();

          // Event listener para el cambio de período de los small boxes
          $('#dashboardPeriod').change(function() {
            const selectedPeriod = $(this).val();
            loadDashboardStatsData(selectedPeriod);
            // El gráfico no depende de este selector, sus datos son para el año actual/anterior
          });


          // =================================================================
          // Código para la carga dinámica de contenido del menú lateral
          // =================================================================
          /* $('.menu-link').click(function(e) {
            e.preventDefault();
            let url = $(this).data('url');
            console.log("Cargando contenido con AJAX desde:", url);
            $('#content-area').load(url, function(response, status, xhr) {
                if (status === "error") {
                    console.error("Error al cargar el contenido:", xhr.status, xhr.statusText);
                } else {
                    console.log("Contenido cargado exitosamente desde:", url);
                    setTimeout(function() {
                        $('body').removeClass('sidebar-collapse'); // Cierra el sidebar después de la carga
                        $('[data-widget="pushmenu"]').PushMenu(); // Reinicia el pushmenu
                        $('[data-widget="treeview"]').Treeview(); // Reinicia el treeview

                         // Callbacks para recargar datos específicos de cada vista (mantenerlos si los necesitas)
                         if (url === '/usuarios' && typeof recargarListaUsuariosCompleta === 'function') {
                            console.log("Detectado retorno a /usuarios. Iniciando recarga de datos.");
                            recargarListaUsuariosCompleta();
                        } else if (url === '/productos' && typeof recargarListaProductosCompleta === 'function') {
                            console.log("Detectado retorno a /productos. Iniciando recarga de datos.");
                            recargarListaProductosCompleta();
                        } else if (url === '/proveedores' && typeof recargarListaProveedoresCompleta === 'function') {
                            console.log("Detectado retorno a /proveedores. Iniciando recarga de datos.");
                            recargarListaProveedoresCompleta();
                        } else if (url === '/categorias' && typeof recargarListaCategoriasCompleta === 'function') {
                            console.log("Detectado retorno a /categorias. Iniciando recarga de datos.");
                            recargarListaCategoriasCompleta();
                        }else if (url === '/tasa' && typeof recargarListaIgvCompleta === 'function') {
                            console.log("Detectado retorno a /tasa. Iniciando recarga de datos.");
                            recargarListaIgvCompleta();
                        }else if (url === '/informacion-empresa' && typeof inicializarFormularioEmpresa === 'function') {
                            console.log("Detectado retorno a /informacion-empresa. Inicializando formulario.");
                            inicializarFormularioEmpresa();
                        }else if (url === '/merma' && typeof recargarListaMermaCompleta === 'function') {
                            console.log("Detectado retorno a /merma. Iniciando recarga de datos.");
                            recargarListaMermaCompleta();
                        }else if (url === '/clientes' && typeof recargarListaClientesCompleta === 'function') {
                            console.log("Detectado retorno a /clientes. Iniciando recarga de datos.");
                            recargarListaClientesCompleta();
                        } else if (url === '/documento-compra' && typeof recargarListaDocumentosCompraCompleta === 'function') {
                            console.log("Detectado retorno a /documento-compra. Iniciando recarga de datos.");
                            recargarListaDocumentosCompraCompleta();
                        }else if (window.recargarListaVentasCompleta && url === '/ventas') {
                        console.log("Detected return to /ventas. Initiating data reload.");
                        window.recargarListaVentasCompleta();
                        } else if (url === '/') { // Si se navega de nuevo a la raíz (dashboard)
                            console.log("Navigated to dashboard. Reloading dashboard data.");
                            loadDashboardStatsData($('#dashboardPeriod').val()); // Recarga los datos de los small boxes
                            loadSalesPurchasesChart(); // Recarga los datos del gráfico
                        }

                    }, 50); // Pequeño retraso para que AdminLTE reinicie sus componentes
                }
            });
          }); */ // <- Eliminar
        });
    </script>
</th:block>
</html>
