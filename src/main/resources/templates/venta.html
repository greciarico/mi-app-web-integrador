<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title layout:fragment="title">Gestión de Ventas</title>
</head>
<section layout:fragment="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Ventas</h3>
                        <div class="card-tools">
                            <button type="button" onclick="openFormModal(null)"
                                    class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                                <i class="fas fa-plus"></i> Registrar Nueva Venta
                            </button>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" onclick="window.openClienteFormModal()">
                                    <i class="fas fa-plus"></i>Añadir Cliente
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="card card-outline card-success collapsed-card">
                            <div class="card-header">
                                <h3 class="card-title">Filtros de Búsqueda y Reportes</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <form id="ventaFilterForm">
                                    <div class="row">
                                        <div class="form-group col-md-4">
                                            <label for="filtroNombreCliente">Nombre Cliente</label>
                                            <input type="text" id="filtroNombreCliente" name="nombreCliente" class="form-control" placeholder="Nombre o Razón Social">
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="filtroIdCliente">Cliente Específico</label>
                                            <select id="filtroIdCliente" name="idCliente" class="form-control select2bs4" style="width: 100%;">
                                                <option value="">-- Seleccione un Cliente --</option>
                                                <th:block th:each="cliente : ${clientes}">
                                                    <option th:value="${cliente.idCliente}" th:text="${cliente.razonSocial != null and !cliente.razonSocial.isEmpty() ? cliente.razonSocial : (cliente.nombre + ' ' + cliente.apPaterno + ' ' + cliente.apMaterno)}"></option>
                                                </th:block>
                                            </select>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="filtroIdUsuario">Vendedor</label>
                                            <select id="filtroIdUsuario" name="idUsuario" class="form-control select2bs4" style="width: 100%;">
                                                <option value="">-- Seleccione un Vendedor --</option>
                                                <th:block th:each="usuario : ${usuarios}">
                                                    <option th:value="${usuario.idUsuario}" th:text="${usuario.nombre + ' ' + usuario.apPaterno}"></option>
                                                </th:block>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="form-group col-md-3">
                                            <label for="filtroTipoDocumento">Tipo Documento Venta</label>
                                            <select id="filtroTipoDocumento" name="tipoDocumento" class="form-control">
                                                <option value="">Todos</option>
                                                <option value="BOLETA_VENTA">BOLETA_VENTA</option>
                                                <option value="FACTURA_VENTA">FACTURA_VENTA</option>
                                            </select>
                                        </div>
                                        <div class="form-group col-md-3">
                                            <label for="filtroNumDocumento">Número Documento Venta</label>
                                            <input type="text" id="filtroNumDocumento" name="numDocumento" class="form-control" placeholder="Ej: F001-00000001">
                                        </div>

                                        <div class="form-group col-md-3">
                                            <label>Estado</label>
                                            <div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input estado-checkbox-venta" type="checkbox" id="estadoActiva" name="estados" value="1">
                                                    <label class="form-check-label" for="estadoActiva">Activa</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input estado-checkbox-venta" type="checkbox" id="estadoCancelada" name="estados" value="0">
                                                    <label class="form-check-label" for="estadoCancelada">Cancelada</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="form-group col-md-3">
                                            <label for="fechaRegistroVentaStart">Fecha Inicio</label>
                                            <input type="date" id="fechaRegistroVentaStart" name="fechaRegistroStart" class="form-control">
                                        </div>
                                        <div class="form-group col-md-3">
                                            <label for="fechaRegistroVentaEnd">Fecha Fin</label>
                                            <input type="date" id="fechaRegistroVentaEnd" name="fechaRegistroEnd" class="form-control">
                                        </div>
                                        <div class="form-group col-md-3">
                                            <label for="totalMin">Total Mínimo</label>
                                            <input type="number" id="totalMin" name="totalMin" class="form-control" step="0.01" min="0">
                                        </div>
                                        <div class="form-group col-md-3">
                                            <label for="totalMax">Total Máximo</label>
                                            <input type="number" id="totalMax" name="totalMax" class="form-control" step="0.01" min="0">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12 text-right">
                                            <button type="button" class="btn btn-info" onclick="aplicarFiltrosTablaVentas()" >
                                                <i class="fas fa-search"></i> Filtrar Tabla
                                            </button>
                                            <button type="button" class="btn btn-secondary ml-2" onclick="limpiarFiltrosVentas()">
                                                <i class="fas fa-eraser"></i> Limpiar Filtros
                                            </button>
                                            <button type="button" class="btn btn-primary ml-2" onclick="generarReportePdfVentas()" style="background-color:#b45f06 !important; border-color:#b45f06 !important;">
                                                <i class="fas fa-file-pdf"></i> Generar Reporte PDF
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                          <div id="tablaVentasContainer" class="table-responsive">
                            <table id="ventasTable" class="table table-bordered table-striped">
                                <thead>
                                <tr>
                                    <th>ID Venta</th>
                                    <th>Fecha Registro</th>
                                    <th>Cliente</th>
                                    <th>Usuario</th>
                                    <th>Tipo Doc.</th>
                                    <th>N° Documento</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody id="ventasTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para el formulario/visualización de Venta (Cargado con el fragmento) -->
    <div class="modal fade" id="ventaModal" tabindex="-1" role="dialog" aria-labelledby="ventaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content" id="modalContentContainer">
            </div>
        </div>
    </div>

    <!-- *************************************************************** -->
    <!-- MODAL PARA EL FORMULARIO DE CLIENTE - INICIO -->
    <!-- *************************************************************** -->
    <div class="modal fade" id="clienteFormModal" tabindex="-1" role="dialog" aria-labelledby="clienteFormModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" id="clienteFormModalContent">
            </div>
        </div>
    </div>

</section>
<!-- SCRIPT PRINCIPAL CON TODA LA LÓGICA JAVASCRIPT -->
<th:block layout:fragment="scripts">
    <script th:inline="javascript">

        /*<![CDATA[*/
               $(document).ready(function() {
                   // Variables globales para este script
                   let allVentas = /*[[${ventas}]]*/ [];
                   let allProductosData = [];
                   let allClientesData = []; // Esta variable será actualizada por el callback
                   let allIgvData = [];
                   let allUsuariosData = []; // Para llenar el filtro de vendedores
                   const ventaModalElement = $('#ventaModal');
                   const modalContentContainer = document.getElementById('modalContentContainer');
                   // Referencia al modal de cliente para adjuntar eventos de cierre
                   let detalleCount = 0;
                   let modalIsTransitioning = false;

                   // Inicializar Select2 para los filtros avanzados cuando el documento esté listo
                    $('#filtroIdCliente').select2({
                        placeholder: "-- Seleccione un Cliente --",
                        allowClear: true,
                        width: '100%'
                    });
                    $('#filtroIdUsuario').select2({
                        placeholder: "-- Seleccione un Vendedor --",
                        allowClear: true,
                        width: '100%'
                    });

            // Función para predecir el número de documento de venta
      function predictDocumentNumberVenta() {
        const tipoDocumentoSelect = $('#tipoDocumentoVentaSelect');
        const numDocumentoInput = $('#numDocumentoVenta');
        const tipoDocumento = tipoDocumentoSelect.val();

        if (tipoDocumento === 'BOLETA_VENTA' || tipoDocumento === 'FACTURA_VENTA') {
            $.ajax({
                url: '/documento-venta/next-num-documento', 
                type: 'GET',
                data: { tipoDocumento: tipoDocumento },
                success: function(response) {
                    if (response.status === 'success') {
                        numDocumentoInput.val(response.nextNumDocumento); 
                    } else {
                        showNotification('error', response.message || 'Error al predecir el número de documento de venta.');
                        numDocumentoInput.val(''); 
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', status, error);
                    showNotification('error', 'Error de comunicación al predecir el número de documento de venta.');
                    numDocumentoInput.val('');
                }
            });
        } else {
            numDocumentoInput.val(''); 
        }
    }

    $(document).ready(function() {
        // Listener para cuando cambia la selección del "Tipo Documento" en ventas
        $(document).on('change', '#tipoDocumentoVentaSelect', function() {
            predictDocumentNumberVenta();
        });

        // Listener para cuando el modal de registro/edición de venta se muestra (si aplicable)
        $('#modalDocumentoVenta').on('show.bs.modal', function () {
            const idVentaField = $('#idVenta'); 
            if (!idVentaField.length || !idVentaField.val()) {
                predictDocumentNumberVenta();
            }
        });
    });
            // ===============================================
            // FUNCIONES DE UTILIDAD (NOTIFICACIONES, ERRORES)
            // ===============================================

            function showNotification(type, message) {
                Swal.fire({
                    icon: type,
                    title: type.charAt(0).toUpperCase() + type.slice(1),
                    text: message,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    customClass: {
                        container: 'swal2-container-custom'
                    }
                });
            }
            // Esta función limpia los errores en ambos formularios si están presentes
            function clearErrors() {
                const ventaForm = document.getElementById('ventaForm');
                const clienteForm = document.getElementById('clienteForm'); 

                if (ventaForm) {
                    ventaForm.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
                    ventaForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                }
                if (clienteForm) {
                    clienteForm.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
                    clienteForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                }
            }


            function displayError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                if (errorElement) {
                    errorElement.textContent = message;
                    let inputElement = null;
                    if (errorElement.previousElementSibling &&
                       (errorElement.previousElementSibling.tagName === 'INPUT' ||
                        errorElement.previousElementSibling.tagName === 'SELECT')) {
                        inputElement = errorElement.previousElementSibling;
                    } else {
                        const parentDiv = errorElement.closest('.form-group');
                        if (parentDiv) {
                            inputElement = parentDiv.querySelector('input, select');
                        }
                    }
                    if (inputElement) {
                        inputElement.classList.add('is-invalid');
                    }
                }
            }

            // ===============================================
            // LÓGICA DE LA TABLA PRINCIPAL
            // ===============================================

            function getClientDisplayName(client) {
                if (!client) return 'N/A';
                if (client.razonSocial && client.razonSocial.trim() !== '') {
                    return client.razonSocial;
                }
                if (client.nombre && client.nombre.trim() !== '') {
                    let fullName = client.nombre.trim();
                    if (client.apPaterno && client.apPaterno.trim() !== '') fullName += ' ' + client.apPaterno.trim();
                    if (client.apMaterno && client.apMaterno.trim() !== '') fullName += ' ' + client.apMaterno.trim();
                    return fullName;
                }
                return 'Cliente Desconocido';
            }
        //para anular venta
          function renderMainTable(ventasToDisplay) {
                    const tableBody = document.getElementById('ventasTableBody');
                    if (!tableBody) {
                        return;
                    }
                    tableBody.innerHTML = '';
                    if (ventasToDisplay.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay ventas registradas.</td></tr>';
                        return;
                    }

                    const today = new Date();
                    today.setHours(0, 0, 0, 0); 

                    ventasToDisplay.forEach(venta => {
                        const rowClass = venta.estado === 0 ? 'cancelled-sale' : '';
                        const row = document.createElement('tr');
                        if (rowClass) {
                            row.classList.add(rowClass);
                        }

                        let fechaFormatted = 'N/A';
                        let ventaDateForComparison; 

                        if (venta.fechaRegistro) {
                            const dateParts = venta.fechaRegistro.split('-'); // ["YYYY", "MM", "DD"]
                            const year = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1;
                            const day = parseInt(dateParts[2]);

                            // Crea un objeto Date en el huso horario local
                            const localDate = new Date(year, month, day);
                            fechaFormatted = localDate.toLocaleDateString('es-ES');

                            ventaDateForComparison = new Date(year, month, day);
                            ventaDateForComparison.setHours(0, 0, 0, 0); // Limpiar la hora para la comparación
                        } else {
                            ventaDateForComparison = new Date(0); 
                        }
                        const totalFormatted = parseFloat(venta.total).toFixed(2);
                        const clientDisplayName = getClientDisplayName(venta.cliente);

                        // --- Lógica para deshabilitar botón de cancelar (usando ventaDateForComparison) ---
                        // Compara si la fecha de la venta (sin hora) es igual a la fecha de hoy (sin hora)
                        const isSameDay = ventaDateForComparison.getTime() === today.getTime();
                        const canCancel = venta.estado !== 0 && isSameDay; // Solo si no está cancelada y es del mismo día
                        // --- Fin de la lógica para deshabilitar botón ---

                        row.innerHTML = `
                            <td>${venta.idVenta}</td>
                            <td>${fechaFormatted}</td>
                            <td>${clientDisplayName}</td>
                            <td>${venta.usuario ? venta.usuario.nombre : 'N/A'}</td>
                            <td>${venta.tipoDocumento}</td>
                            <td>${venta.numDocumento}</td>
                            <td>S/ ${totalFormatted}</td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" onclick="openViewModal(${venta.idVenta})"
                                            class="btn btn-primary btn-sm">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="/ventas/comprobante/${venta.idVenta}" target="_blank"
                                       class="btn btn-info btn-sm ml-1">
                                        <i class="fas fa-file-invoice"></i> </a>
                                    ${canCancel ? `
                                    <button type="button" onclick="confirmCancelVenta(${venta.idVenta})"
                                            class="btn btn-danger btn-sm ml-1">
                                        <i class="fas fa-times-circle"></i>
                                    </button>
                                    ` : `
                                    <button type="button" class="btn btn-secondary btn-sm ml-1" disabled title="${venta.estado === 0 ? 'Venta ya cancelada' : 'Solo se pueden anular ventas del día actual.'}">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                    `}
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
/// Función para obtener los filtros del formulario
    function getFilterParams() {
    const form = document.getElementById('ventaFilterForm');
    const formData = new FormData(form);
    const params = new URLSearchParams();

    // Aquí manejamos los estados para que solo se envíen si están marcados
    const checkedStates = Array.from(form.querySelectorAll('.estado-checkbox-venta:checked')).map(cb => cb.value);
    if (checkedStates.length > 0) {
        checkedStates.forEach(state => params.append('estados', state));
    }

    for (const [key, value] of formData.entries()) {
        if (key !== 'estados' && value) { 
            params.append(key, value);
        }
    }
    return params.toString();
}

    // Aplica los filtros para actualizar la tabla (AHORA SIEMPRE VIA AJAX)
    window.aplicarFiltrosTablaVentas = function() {
        const filterParams = getFilterParams();
        console.log("Aplicando filtros:", filterParams);

        // Este fetch siempre usa el endpoint /ventas/buscar
        fetch(`/ventas/buscar?${filterParams}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                allVentas = data; // Actualiza la variable global con las ventas filtradas
                renderMainTable(allVentas);
                Swal.close();
            })
            .catch(error => {
                console.error('Error al aplicar filtros:', error);
                showNotification('error', 'Error al cargar las ventas. Inténtalo de nuevo.');
                Swal.close();
            });
    }

    // Genera el reporte PDF usando los filtros actuales (GET)
    window.generarReportePdfVentas = function() {
        const filterParams = getFilterParams();
        const url = `/ventas/reporte/pdf?${filterParams}`;

        Swal.fire({
            title: 'Generando Reporte...',
            text: 'Por favor, espera mientras se genera el PDF.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Pequeño retardo para asegurar que el Swal.showLoading() se vea
        setTimeout(() => {
            const newWindow = window.open(url, '_blank');
            if (newWindow) {
                Swal.close();
                showNotification("success", "El reporte PDF se está generando y debería descargarse pronto.");
            } else {
                Swal.close();
                showNotification("error", "Error: Tu navegador bloqueó la descarga del PDF. Por favor, permite los pop-ups para este sitio.");
            }
        }, 300);
    }

    // Limpia todos los filtros del formulario
    window.limpiarFiltrosVentas = function() {
        document.getElementById('ventaFilterForm').reset();
        $('#filtroIdCliente').val('').trigger('change'); // Limpiar Select2
        $('#filtroIdUsuario').val('').trigger('change'); // Limpiar Select2
        $('.estado-checkbox-venta').prop('checked', false); // Desmarcar todos
        setFilterDateRangeVenta(); // Restablecer límites de fecha
        aplicarFiltrosTablaVentas(); // Volver a cargar la tabla con filtros limpios
    }

    // Función para ajustar el atributo 'max' y 'min' de las fechas en el formulario de filtro
    function setFilterDateRangeVenta() {
        const today = new Date().toISOString().split('T')[0];
        const fechaInicioInput = document.getElementById('fechaRegistroVentaStart');
        const fechaFinInput = document.getElementById('fechaRegistroVentaEnd');

        if (fechaInicioInput) {
            fechaInicioInput.setAttribute('max', today);
            fechaInicioInput.value = ''; // Limpiar al reset
            fechaInicioInput.onchange = function() {
                if (fechaFinInput) fechaFinInput.min = this.value;
            };
        }
        if (fechaFinInput) {
            fechaFinInput.setAttribute('max', today);
            fechaFinInput.value = ''; // Limpiar al reset
            fechaFinInput.onchange = function() {
                if (fechaInicioInput) fechaInicioInput.max = this.value;
            };
        }
    }
    setFilterDateRangeVenta(); // Llamar al inicio para configurar


             // ===============================================
            // Carga de datos iniciales para Select2 y la tabla
            // ===============================================

           window.loadSelectDataAndInitialTable = function() {
            console.log("loadSelectDataAndInitialTable: Iniciando carga de datos...");

            // Crea un array de promesas, cada una con su propio .catch
            // Esto permite que una falla individual no detenga todo Promise.all
            const promises = [
                fetch('/productos/activos')
                    .then(r => {
                        if (!r.ok) throw new Error('Error al cargar productos activos');
                        return r.json();
                    })
                    .then(data => {
                        allProductosData = data;
                        console.log("Productos activos cargados.");
                    })
                    .catch(err => {
                        console.error("Error cargando productos activos:", err);
                        showNotification('error', err.message || 'Error al cargar productos activos.');
                        allProductosData = []; 
                    }),

                fetch('/clientes/activos')
                    .then(r => {
                        if (!r.ok) throw new Error('Error al cargar clientes activos');
                        return r.json();
                    })
                    .then(data => {
                        allClientesData = data;
                        const filtroClienteSelect = $('#filtroIdCliente');
                        filtroClienteSelect.empty().append('<option value="">-- Seleccione un Cliente --</option>');
                        allClientesData.forEach(cliente => {
                            const displayName = getClientDisplayName(cliente);
                            filtroClienteSelect.append(`<option value="${cliente.idCliente}">${displayName}</option>`);
                        });
                        filtroClienteSelect.trigger('change');
                        console.log("Clientes activos cargados.");
                    })
                    .catch(err => {
                        console.error("Error cargando clientes activos:", err);
                        showNotification('error', err.message || 'Error al cargar clientes activos.');
                        allClientesData = [];
                    }),

                fetch('/usuarios/all') 
                    .then(r => {
                        if (!r.ok) throw new Error('Error al cargar usuarios activos');
                        return r.json();
                    })
                    .then(data => {
                        allUsuariosData = data;
                        const filtroUsuarioSelect = $('#filtroIdUsuario');
                        filtroUsuarioSelect.empty().append('<option value="">-- Seleccione un Vendedor --</option>');
                        allUsuariosData.forEach(usuario => {
                            filtroUsuarioSelect.append(`<option value="${usuario.idUsuario}">${usuario.nombre + ' ' + usuario.apPaterno}</option>`);
                        });
                        filtroUsuarioSelect.trigger('change');
                        console.log("Usuarios activos cargados.");
                    })
                    .catch(err => {
                        console.error("Error cargando usuarios activos:", err);
                        showNotification('error', err.message || 'Error al cargar usuarios activos.');
                        allUsuariosData = []; 
                    }),

                fetch('/tasa/activos')
                    .then(r => {
                        if (!r.ok) throw new Error('Error al cargar tasas activas');
                        return r.json();
                    })
                    .then(data => {
                        console.log("IGV activos desde servidor: ", data );
                        allIgvData = data;
                    })
                    .catch(err => {
                        console.error("Error cargando tasas activas:", err);
                        showNotification('error', err.message || 'Error al cargar tasas activas.');
                        allIgvData = [];
                    })
            ];

            // Promise.all espera que todas las promesas en 'promises' se resuelvan.
            // Si una falla y tiene un .catch(), esa promesa se "resuelve" con un error manejado,
            // permitiendo que las otras sigan adelante.
            Promise.all(promises)
                .then(() => {
                    console.log("loadSelectDataAndInitialTable: Todas las cargas de datos para selects (o sus errores) han sido procesadas.");
                    renderMainTable(allVentas); 
                })
                .catch(error => {
                    console.error("loadSelectDataAndInitialTable: Error general NO MANEJADO al cargar datos iniciales.", error);
                    showNotification('error', error.message || 'Error fatal al cargar la página.');
                });
        }          
            loadSelectDataAndInitialTable();

// ===============================================
// LÓGICA DEL FORMULARIO MODAL (CREAR VENTA SOLAMENTE)
// ===============================================

// Declarar loadAndShowModalContent a nivel global
function loadAndShowModalContent(idVenta, url) {
    modalContentContainer.innerHTML = '';
    $('.modal-backdrop').remove();
    $('body').removeClass('modal-open');

    $.ajax({
        url: url,
        type: 'GET',
        success: function(html) {
            $(modalContentContainer).html(html);
            setTimeout(() => {
                const clienteSelectInModal = $('#modalContentContainer #clienteSelect');
                const igvSelectInModal = $('#modalContentContainer #igvSelect');

                                if (igvSelectInModal.length && !igvSelectInModal.hasClass('select2-hidden-accessible')) {
                                  igvSelectInModal
                                    .select2({
                                      placeholder: "-- Seleccione el IGV --",
                                      allowClear: true,
                                      width: '100%',
                                      dropdownParent: $('#ventaModal .modal-content')  
                                    })
                                    .on('change', calculateTotalGeneral);

                                  calculateTotalGeneral();
                                }

                $('#modalContentContainer').find('.detalle-item select[id^="producto-"]').each(function() {
                    if (!$(this).data('select2')) {
                        $(this).select2({
                            placeholder: "-- Seleccione un Producto --",
                            allowClear: true,
                            width: '100%',
                            dropdownParent: $('#ventaModal .modal-content')
                        });
                    }
                });

                // Inicializa los listeners para los campos de pago una vez que el modal se carga
                const cashPaymentInput = document.getElementById('cashPayment');
                const yapePaymentInput = document.getElementById('yapePayment');
                if (cashPaymentInput) {
                    cashPaymentInput.addEventListener('input', calculatePaymentAndChange);
                }
                if (yapePaymentInput) {
                    yapePaymentInput.addEventListener('input', calculatePaymentAndChange);
                }

            
                const igvSelectElement = document.getElementById('igvSelect');
                if (igvSelectElement) {
                    if (!igvSelectElement.dataset.listenerAdded) {
                        igvSelectElement.addEventListener('change', calculateTotalGeneral);
                        igvSelectElement.dataset.listenerAdded = 'true';
                    }
                }

                ventaModalElement.modal('show');
                modalIsTransitioning = false;

                calculateTotalGeneral();
            }, 150);
        },
        error: function(xhr, status, error) {
            showNotification('error', 'No se pudo cargar el formulario de venta. Inténtalo de nuevo.');
            modalIsTransitioning = false;
        }
    });
}


window.openFormModal = function(idVenta) {
    console.log("DEBUG: openFormModal - Función llamada.");
    if (modalIsTransitioning) {
        return;
    }
    modalIsTransitioning = true;
    clearErrors();
    detalleCount = 0;

    let url = '/ventas/nuevo';

    if (ventaModalElement.hasClass('show')) {
        ventaModalElement.one('hidden.bs.modal', () => loadAndShowModalContent(idVenta, url));
        ventaModalElement.modal('hide');
    } else {
        loadAndShowModalContent(idVenta, url);
    }
}

window.closeFormModal = function() {
    if (modalIsTransitioning) {
        return;
    }
    modalIsTransitioning = true;
    ventaModalElement.modal('hide');
    ventaModalElement.one('hidden.bs.modal', function() {
        const igvSelectElement = document.getElementById('igvSelect');
        if (igvSelectElement && igvSelectElement.dataset.listenerAdded === 'true') {
            igvSelectElement.removeEventListener('change', calculateTotalGeneral);
            delete igvSelectElement.dataset.listenerAdded; 
        }

        $('#modalContentContainer').find('select.select2-hidden-accessible').each(function() {
            if ($(this).data('select2')) {
                $(this).select2('destroy');
            }
        });

        modalContentContainer.innerHTML = '';
        modalIsTransitioning = false;
        $('.modal-backdrop').remove();
        $('body').removeClass('modal-open');
    });
    clearErrors();
}

// ===============================================
// LÓGICA DEL MODAL DE VISUALIZACIÓN
// ===============================================

window.openViewModal = function(idVenta) {
    if (modalIsTransitioning) {
        return;
    }
    modalIsTransitioning = true;
    if (!idVenta) {
        showNotification('error', 'ID de venta no proporcionado para visualizar.');
        modalIsTransitioning = false;
        return;
    }
    let url = `/ventas/visualizar/${idVenta}`;
    if (ventaModalElement.hasClass('show')) {
        ventaModalElement.one('hidden.bs.modal', () => loadAndShowModalContent(idVenta, url));
        ventaModalElement.modal('hide');
    } else {
        loadAndShowModalContent(idVenta, url);
    }
}

window.closeViewModal = function() {
    if (modalIsTransitioning) {
        return;
    }
    modalIsTransitioning = true;
    ventaModalElement.modal('hide');
    ventaModalElement.one('hidden.bs.modal', function() {
        modalContentContainer.innerHTML = '';
        modalIsTransitioning = false;
        $('.modal-backdrop').remove();
        $('body').removeClass('modal-open');
    });
}


// ===============================================
// LÓGICA DE DETALLES DE VENTA EN EL FORMULARIO MODAL
// ===============================================

// Declaraciones globales necesarias para los nuevos campos de pago
let cashPaymentInput;
let yapePaymentInput;
let totalPaidAmountInput;
let changeAmountInput;


window.initializeModalDetails = function(modalProducts, modalSale, modalClients, modalIgvs) {
    allProductosData = modalProducts;
    allClientesData = modalClients;
    allIgvData = modalIgvs; 

    const detalleVentasContainer = document.getElementById('detalleVentasContainer');
    if (!detalleVentasContainer) {
        return;
    }
    detalleVentasContainer.innerHTML = '';

    // Asigna los elementos de pago a las variables globales aquí, después de que el HTML del modal se haya cargado
    cashPaymentInput = document.getElementById('cashPayment');
    yapePaymentInput = document.getElementById('yapePayment');
    totalPaidAmountInput = document.getElementById('totalPaidAmount');
    changeAmountInput = document.getElementById('changeAmount');

    if (modalSale && modalSale.detalleVentas && modalSale.detalleVentas.length > 0) {
        modalSale.detalleVentas.forEach(detalle => {
            addDetalleVenta(detalle, allProductosData);
        });
    } else {
        addDetalleVenta(null, allProductosData);
    }

    // Si estamos editando una venta, inicializa los campos de pago y otros
    if (modalSale && modalSale.idVenta != null) {
        if (cashPaymentInput && modalSale.efectivo !== undefined && modalSale.efectivo !== null) {
            cashPaymentInput.value = parseFloat(modalSale.efectivo).toFixed(2);
        }
        if (yapePaymentInput && modalSale.yape !== undefined && modalSale.yape !== null) {
            yapePaymentInput.value = parseFloat(modalSale.yape).toFixed(2);
        }
        const tipoDocumentoVentaSelect = document.getElementById('tipoDocumentoVentaSelect');
        const numDocumentoVenta = document.getElementById('numDocumentoVenta');
        const igvSelect = document.getElementById('igvSelect');
        const fechaRegistroInput = document.getElementById('fechaRegistro');

        if (tipoDocumentoVentaSelect && modalSale.tipoDocumento) {
            tipoDocumentoVentaSelect.value = modalSale.tipoDocumento;
        }
        if (numDocumentoVenta && modalSale.numDocumento) {
            numDocumentoVenta.value = modalSale.numDocumento;
        }
        if (igvSelect && modalSale.igvEntity && modalSale.igvEntity.idIgv) {
            igvSelect.value = modalSale.igvEntity.idIgv;
        }
        if (fechaRegistroInput && modalSale.fechaRegistro) {
            // Asegúrate de que el formato de fecha sea compatible con el input type="hidden"
            fechaRegistroInput.value = modalSale.fechaRegistro.substring(0, 10); // Asume formato "YYYY-MM-DDTHH:MM:SS"
        }

    } else {
        if (cashPaymentInput) cashPaymentInput.value = '0.00';
        if (yapePaymentInput) yapePaymentInput.value = '0.00';
        // Genera un nuevo número de documento para una nueva venta
        document.getElementById('numDocumentoVenta').value = `VTA-${Math.floor(100000 + Math.random() * 900000)}`;
        // Establece la fecha actual para una nueva venta
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('fechaRegistro').value = `${yyyy}-${mm}-${dd}`;
    }

    calculateTotalGeneral();
}

// Resto de funciones como addDetalleVenta, setProductPrice, removeDetalleVenta, updateDetalleTotal
// quedan prácticamente igual. Solo asegúrate de que los IDs y clases coincidan.

window.addDetalleVenta = function(detalle = null, productsArray = allProductosData) {
    const index = detalleCount++;
    const detalleDiv = document.createElement('tr');
    detalleDiv.classList.add('detalle-item');
    detalleDiv.setAttribute('data-index', index);
    detalleDiv.id = `detalleRow-${index}`;
    let activos = productsArray.filter(p => p.estado === 1);

    let productoOptions = activos.map(p =>
        `<option value="${p.idProducto}"
                 data-precio1="${p.precio1 || ''}"
                 data-precio2="${p.precio2 || ''}"
                 data-stock="${p.stock}"
                 data-descripcion="${p.descripcion}"
                 ${detalle && detalle.producto && detalle.producto.idProducto === p.idProducto ? 'selected' : ''}>
             ${p.nombre} (Descripcion: ${p.descripcion}) (Stock: ${p.stock})
          </option>`
    ).join('');

    const initialCantidad = detalle ? (detalle.cantidad || '') : '';
    const initialPrecioUnitario = detalle && detalle.precioUnitario ? (parseFloat(detalle.precioUnitario).toFixed(2) || '') : '';
    const initialTotalDetalle = detalle && detalle.total ? (parseFloat(detalle.total) || 0).toFixed(2) : '0.00';
    detalleDiv.innerHTML = `
        <td>
            <input type="hidden" name="detalleVentas[${index}].idDetalleVenta" value="${detalle ? detalle.idDetalleVenta || '' : ''}">
            <select name="detalleVentas[${index}].producto.idProducto" id="producto-${index}" required
                   class="form-control">
                <option value="">Seleccione un Producto</option>
                ${productoOptions}
            </select>
            <span class="text-danger" id="productoError-${index}"></span>
        </td>
        <td>
            <input type="number" name="detalleVentas[${index}].cantidad" id="cantidad-${index}" placeholder="Cantidad" required min="1"
                   value="${initialCantidad}"
                   class="form-control">
            <span class="text-danger" id="cantidadError-${index}"></span>
        </td>
        <td>
            <input type="number" step="0.01" class="form-control" id="precioUnitario-${index}" placeholder="Precio Unitario" min="0" value="${initialPrecioUnitario}">
            <span class="text-danger" id="precioUnitarioError-${index}"></span>
            <div class="mt-1">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setProductPrice(${index}, 'precio1')">P1</button>
                <button type="button" class="btn btn-sm btn-outline-secondary ml-1" onclick="setProductPrice(${index}, 'precio2')">P2</button>
            </div>
        </td>
        <td>
            <input type="text" class="form-control total-detalle-display bg-light" id="detalleTotalDisplay-${index}" value="${initialTotalDetalle}" readonly>
        </td>
        <td>
            <button type="button" onclick="removeDetalleVenta(this)"
                    class="btn btn-danger btn-sm">
                <i class="fas fa-trash-alt"></i>
            </button>
        </td>
    `;
    const detalleVentasContainer = document.getElementById('detalleVentasContainer');
    if (detalleVentasContainer) {
        detalleVentasContainer.appendChild(detalleDiv);
    } else {
        return;
    }

    setTimeout(() => {
        const newProductoSelect = $(`#producto-${index}`);
        if (newProductoSelect.length && !newProductoSelect.data('select2')) {
            newProductoSelect.select2({
                placeholder: "-- Seleccione un Producto --",
                allowClear: true,
                width: '100%',
                dropdownParent: $('#ventaModal .modal-content')
            });
        }
    }, 10);
    const cantidadInput = document.getElementById(`cantidad-${index}`);
    const precioInput = document.getElementById(`precioUnitario-${index}`);
    const productoSelect = document.getElementById(`producto-${index}`);

    if (cantidadInput) cantidadInput.addEventListener('input', () => updateDetalleTotal(index));
    if (precioInput) precioInput.addEventListener('input', () => updateDetalleTotal(index));
    if (productoSelect) {
        productoSelect.addEventListener('change', () => {
            const selectedOption = productoSelect.options[productoSelect.selectedIndex];
            const precio1 = selectedOption.dataset.precio1;
            // Si el precio unitario inicial no tiene valor o es 0, o si se selecciona un nuevo producto
            // y tiene precio1, se asigna.
            if (precio1 && (initialPrecioUnitario === '' || parseFloat(precioInput.value) === 0 || precioInput.value === '')) {
                precioInput.value = parseFloat(precio1).toFixed(2);
            } else if (precio1 && !precioInput.value) { // Si no hay valor previo, usa precio1
                precioInput.value = parseFloat(precio1).toFixed(2);
            }
            updateDetalleTotal(index);
        });
    }

    // Si el precio unitario no se inicializó desde el detalle (es decir, es una nueva línea vacía)
    // Y si el producto ya está seleccionado, intenta usar precio1
    if (detalle && initialPrecioUnitario === '' && productoSelect && productoSelect.value) {
        const selectedOption = productoSelect.options[productoSelect.selectedIndex];
        const precio1 = selectedOption.dataset.precio1;
        if (precio1) {
            precioInput.value = parseFloat(precio1).toFixed(2);
        }
    } else if (!detalle && productoSelect && productoSelect.value) {
        const selectedOption = productoSelect.options[productoSelect.selectedIndex];
        const precio1 = selectedOption.dataset.precio1;
        if (precio1) {
            precioInput.value = parseFloat(precio1).toFixed(2);
        }
    }
    updateDetalleTotal(index);
}

window.setProductPrice = function(index, priceType) {
    const productoSelect = document.getElementById(`producto-${index}`);
    const precioInput = document.getElementById(`precioUnitario-${index}`);

    if (productoSelect && precioInput && productoSelect.value) {
        const selectedOption = productoSelect.options[productoSelect.selectedIndex];
        let priceValue;
        if (priceType === 'precio1') {
            priceValue = selectedOption.dataset.precio1;
        } else if (priceType === 'precio2') {
            priceValue = selectedOption.dataset.precio2;
        }

        if (priceValue) {
            precioInput.value = parseFloat(priceValue).toFixed(2);
            updateDetalleTotal(index);
        }
    } else {
        showNotification('info', 'Por favor, selecciona un producto primero para fijar el precio.');
    }
}


window.removeDetalleVenta = function(button) {
    const detalleDiv = button.closest('tr.detalle-item');
    if (detalleDiv) {
        const productoSelect = detalleDiv.querySelector('select[id^="producto-"]');
        if (productoSelect && $(productoSelect).data('select2')) {
            $(productoSelect).select2('destroy');
        }
        detalleDiv.remove();
        calculateTotalGeneral();
    }
}

window.updateDetalleTotal = function(index) {
    const cantidadInput = document.getElementById(`cantidad-${index}`);
    const precioUnitarioInput = document.getElementById(`precioUnitario-${index}`);
    const totalDisplay = document.getElementById(`detalleTotalDisplay-${index}`);

    if (cantidadInput && precioUnitarioInput && totalDisplay) {
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const precioUnitario = parseFloat(precioUnitarioInput.value) || 0;
        const totalDetalle = cantidad * precioUnitario;
        totalDisplay.value = totalDetalle.toFixed(2);
        calculateTotalGeneral();
    }
}


window.calculateTotalGeneral = function() {
                let subtotal = 0;
                document.querySelectorAll('.detalle-item').forEach(detalleDiv => {
                    const totalDisplay = detalleDiv.querySelector('.total-detalle-display');
                    if (totalDisplay) {
                        const totalValue = parseFloat(totalDisplay.value) || 0;
                        subtotal += totalValue;
                    }
                });
                const igvSelect = document.getElementById('igvSelect');
                let igvRate = 0;
                if (igvSelect && igvSelect.value) {
                    const selectedIgv = allIgvData.find(tasa => tasa.idIgv == igvSelect.value);
                    if (selectedIgv) {
                        igvRate = parseFloat(selectedIgv.tasa) ;
                    }
                }

                const igvAmount = subtotal * igvRate;
                const totalGeneral = subtotal + igvAmount;

                const subtotalDisplay = document.getElementById('subtotalDisplay');
                if(subtotalDisplay) subtotalDisplay.value = subtotal.toFixed(2);

                const igvCalculatedDisplay = document.getElementById('igvCalculatedDisplay');
                if(igvCalculatedDisplay) igvCalculatedDisplay.value = igvAmount.toFixed(2);

                const totalGeneralDisplay = document.getElementById('totalGeneralDisplay');
                if (totalGeneralDisplay) {
                    totalGeneralDisplay.value = totalGeneral.toFixed(2);
                }
            }

            const igvSelectElement = document.getElementById('igvSelect');
            if (igvSelectElement) {
                igvSelectElement.addEventListener('change', calculateTotalGeneral);
            }


// Calcular Pagos y Cambio 
window.calculatePaymentAndChange = function() {
    const totalSale = parseFloat(document.getElementById('totalGeneralDisplay').value) || 0;
    const cash = parseFloat(cashPaymentInput.value) || 0;
    const yape = parseFloat(yapePaymentInput.value) || 0;

    const totalPaid = cash + yape;
    totalPaidAmountInput.value = totalPaid.toFixed(2);

    let balance = totalPaid - totalSale; // Calcula la diferencia: positivo para vuelto, negativo para faltante

    // Actualiza el campo de cambio con el balance calculado
    changeAmountInput.value = balance.toFixed(2);

    if (balance < 0) {
        changeAmountInput.style.backgroundColor = '#f8d7da'; // Color de fondo para indicar "falta dinero" (rojo claro)
        changeAmountInput.style.color = '#dc3545'; // Color de texto para el valor negativo (rojo oscuro)
    } else {
        // Restablece los estilos si el pago es suficiente o hay vuelto
        changeAmountInput.style.backgroundColor = ''; // Fondo por defecto
        changeAmountInput.style.color = ''; // Color de texto por defecto
    }
};


// ===============================================
// VALIDACIÓN DEL FORMULARIO
// ===============================================

async function validateForm() {
    clearErrors();
    let isValid = true;

    const tipoDocumentoInput = document.getElementById('tipoDocumentoVentaSelect');
    if (tipoDocumentoInput && !tipoDocumentoInput.value) {
        displayError('tipoDocumentoVentaError', 'El tipo de documento es obligatorio.');
        tipoDocumentoInput.classList.add('is-invalid');
        isValid = false;
    } else if (tipoDocumentoInput) {
        tipoDocumentoInput.classList.remove('is-invalid');
    }
    const numDocumentoInput = document.getElementById('numDocumentoVenta');
    if (numDocumentoInput && !numDocumentoInput.value.trim()) {
        displayError('numDocumentoVentaError', 'El número de documento es obligatorio.');
        numDocumentoInput.classList.add('is-invalid');
        isValid = false;
    } else if (numDocumentoInput) {
        numDocumentoInput.classList.remove('is-invalid');
    }
    const clienteSelect = document.getElementById('clienteSelect');
    if (clienteSelect && !clienteSelect.value) {
        displayError('clienteSelectError', 'Debe seleccionar un cliente.');
        clienteSelect.classList.add('is-invalid');
        isValid = false;
    } else if (clienteSelect) {
        clienteSelect.classList.remove('is-invalid');
    }

    // Validación de igvSelect
    const igvSelect = document.getElementById('igvSelect');
    if (igvSelect && !igvSelect.value) {
        displayError('igvSelectError', 'Debe seleccionar un tipo de IGV.');
        igvSelect.classList.add('is-invalid');
        isValid = false;
    } else if (igvSelect) {
        igvSelect.classList.remove('is-invalid');
    }

    const detalleRows = document.querySelectorAll('.detalle-item');
    if (detalleRows.length === 0) {
        showNotification('error', 'Debe añadir al menos un producto a la venta.');
        isValid = false;
    }
    for (const row of detalleRows) {
        const index = row.getAttribute('data-index');
        const productoSelect = document.getElementById(`producto-${index}`);
        const cantidadInput = document.getElementById(`cantidad-${index}`);
        const precioUnitarioInput = document.getElementById(`precioUnitario-${index}`);
        if (productoSelect && !productoSelect.value) {
            displayError(`productoError-${index}`, 'Seleccione un producto.');
            productoSelect.classList.add('is-invalid');
            isValid = false;
        } else if (productoSelect) {
            productoSelect.classList.remove('is-invalid');
        }
        const cantidad = parseFloat(cantidadInput ? cantidadInput.value : '');
        if (cantidadInput && (isNaN(cantidad) || cantidad <= 0)) {
            displayError(`cantidadError-${index}`, 'Cantidad > 0.');
            cantidadInput.classList.add('is-invalid');
            isValid = false;
        } else if (cantidadInput) {
            cantidadInput.classList.remove('is-invalid');
        }
        if (productoSelect && cantidadInput) {
            const selectedOption = productoSelect.options[productoSelect.selectedIndex];
            const availableStock = parseInt(selectedOption.dataset.stock || '0');
            const currentSaleId = document.getElementById('idVenta') ? document.getElementById('idVenta').value : null;
            let oldQuantityInThisDetail = 0;
            if (currentSaleId) {
                const oldSale = allVentas.find(v => v.idVenta == currentSaleId);
                if (oldSale && oldSale.detalleVentas) {
                    const oldDetailForProduct = oldSale.detalleVentas.find(d => d.producto && d.producto.idProducto == productoSelect.value);
                    if (oldDetailForProduct) {
                        oldQuantityInThisDetail = oldDetailForProduct.cantidad;
                    }
                }
            }
            const effectiveAvailableStock = availableStock + oldQuantityInThisDetail;
            if (cantidad > effectiveAvailableStock) {
                displayError(`cantidadError-${index}`, `Stock insuficiente. Disponible: ${availableStock} (cantidad previa en esta venta: ${oldQuantityInThisDetail}).`);
                cantidadInput.classList.add('is-invalid');
                isValid = false;
            }
        }
        const precio = parseFloat(precioUnitarioInput ? precioUnitarioInput.value : '');
        if (precioUnitarioInput && (isNaN(precio) || precio < 0)) {
            displayError(`precioUnitarioError-${index}`, 'Precio >= 0.');
            precioUnitarioInput.classList.add('is-invalid');
            isValid = false;
        } else if (precioUnitarioInput) {
            precioUnitarioInput.classList.remove('is-invalid');
        }
    }

    const totalSaleAmount = parseFloat(document.getElementById('totalGeneralDisplay').value) || 0;
    const totalPaidAmount = parseFloat(document.getElementById('totalPaidAmount').value) || 0;

    if (totalPaidAmount < totalSaleAmount) {
        showNotification('error', `El monto pagado (S/ ${totalPaidAmount.toFixed(2)}) es menor que el total de la venta (S/ ${totalSaleAmount.toFixed(2)}).`);
        isValid = false;
    }

    return isValid;
}
// ===============================================
// LÓGICA DE GUARDADO DE LA VENTA (EN EL CLIENTE)
// ===============================================
window.saveVenta = async function(event) {
    event.preventDefault(); // Evita el envío tradicional del formulario

    // 1. Validar el formulario primero
    const isValid = await validateForm();
    if (!isValid) {
        showNotification('error', 'Por favor, corrige los errores en el formulario.');
        return;
    }

    Swal.fire({
        title: 'Guardando Venta...',
        text: 'Por favor, espera mientras se procesa la venta.',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    // 2. Recopilar todos los datos del formulario, incluyendo los detalles de la venta
    const ventaData = {
        // Campos directos de la venta
        tipoDocumento: document.getElementById('tipoDocumentoVentaSelect').value,
        numDocumento: document.getElementById('numDocumentoVenta').value,
        fechaRegistro: document.getElementById('fechaRegistro').value, 

        cliente: {
            idCliente: document.getElementById('clienteSelect').value
        },
        igvEntity: { // Asegúrate de enviar solo el ID del IGV
            idIgv: document.getElementById('igvSelect').value
        },
        total: parseFloat(document.getElementById('totalGeneralDisplay').value), // Usar el total calculado

        montoEfectivo: parseFloat(document.getElementById('cashPayment').value) || 0,
        montoMonederoElectronico: parseFloat(document.getElementById('yapePayment').value) || 0,
        tipoPago: document.getElementById('tipoPagoSelect').value 
    };

    // 3. Recopilar los detalles de la venta
    const detalleVentas = [];
    document.querySelectorAll('.detalle-item').forEach(row => {
        const index = row.getAttribute('data-index');
        detalleVentas.push({
            idDetalleVenta: document.querySelector(`#detalleVentasContainer input[name="detalleVentas[${index}].idDetalleVenta"]`)?.value || null, // Para edición
            producto: {
                idProducto: document.getElementById(`producto-${index}`).value
            },
            cantidad: parseInt(document.getElementById(`cantidad-${index}`).value),
            precioUnitario: parseFloat(document.getElementById(`precioUnitario-${index}`).value),
            total: parseFloat(document.getElementById(`detalleTotalDisplay-${index}`).value)
        });
    });
    ventaData.detalleVentas = detalleVentas;

    try {
        const response = await fetch('/ventas/guardar', {
            method: 'POST', 
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(ventaData)
        });

        const data = await response.json();

        if (response.ok) { 
            Swal.close();
            showNotification('success', data.message || 'Venta guardada con éxito.');
            closeFormModal(); 
            recargarListaVentasCompleta(); // Actualiza la tabla principal de ventas
            if (data.idVenta) {         
            }
        } else { 
            Swal.close();
            showNotification('error', data.message || 'Error al guardar la venta.');
            if (data.errors) {
                for (const [field, errorMessage] of Object.entries(data.errors)) {
                    displayError(`${field}Error`, errorMessage);
                }
            }
        }
    } catch (error) {
        Swal.close();
        console.error('Error en la comunicación con el servidor:', error);
        showNotification('error', 'Error de conexión con el servidor al guardar la venta.');
    }
};

              // ===============================================
            // CANCELAR VENTA 
            // ===============================================

            window.confirmCancelVenta = function(idVenta) {
                Swal.fire({
                    title: 'Anular Venta',
                    html: `
                        <p>¿Está seguro de que desea anular esta venta? Esta acción no se puede revertir y el stock de productos será repuesto.</p>
                        <input type="password" id="adminPassword" class="swal2-input" placeholder="Contraseña de Administrador" autocomplete="new-password">
                        <div id="passwordError" class="text-danger" style="display:none; margin-top: 5px;"></div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33', // Rojo para anular
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, Anular',
                    cancelButtonText: 'Cancelar',
                    focusConfirm: false,
                    preConfirm: () => {
                        const password = Swal.getPopup().querySelector('#adminPassword').value;
                        if (!password) {
                            Swal.getPopup().querySelector('#passwordError').textContent = 'La contraseña es obligatoria.';
                            Swal.getPopup().querySelector('#passwordError').style.display = 'block';
                            return false; // Evita que el modal se cierre
                        }
                        Swal.getPopup().querySelector('#passwordError').style.display = 'none';
                        return { password: password };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        cancelarVenta(idVenta, result.value.password);
                    }
                });
            }

            async function cancelarVenta(idVenta, adminPassword) {
                Swal.fire({
                    title: 'Anulando Venta...',
                    text: 'Por favor, espera.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    const response = await fetch(`/ventas/cancelar/${idVenta}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ password: adminPassword }) // Enviar la contraseña en el cuerpo
                    });

                    Swal.close(); 

                    if (!response.ok) {
                        const errorData = await response.json();
                        // Muestra el mensaje de error del backend
                        showNotification('error', errorData.message || 'Error al cancelar la venta.');
                        return; // Detiene la ejecución si hay un error
                    }

                    const result = await response.json();
                    showNotification('success', result.message || 'Venta cancelada exitosamente.');
                    recargarListaVentasCompleta(); // Recarga la tabla para reflejar el cambio de estado y color
                } catch (error) {
                    Swal.close(); 
                    console.error('Error al cancelar la venta:', error);
                    showNotification('error', error.message || 'Ocurrió un error de red o interno al intentar cancelar la venta.');
                }
            }


            const clienteFormModalElement = $('#clienteFormModal');
            const clienteFormModalContent = $('#clienteFormModalContent');

            // ===============================================
            // LÓGICA DEL FORMULARIO DE CLIENTE (NUEVO/EDICIÓN)
            // ===============================================

            /**
             * Función para abrir el modal del formulario de cliente.
             * Se llama desde venta.html (botón de la tabla) o desde form_venta.html (botón en el select de cliente).
             */
            window.openClienteFormModal = function() {
                $.ajax({
                    url: '/ventas/cliente/nuevo', // Endpoint del controlador para cargar el fragmento del cliente
                    type: 'GET',
                    success: function(response) {
                        clienteFormModalContent.html(response); // Carga el HTML del formulario en el modal
                        clienteFormModalElement.modal('show'); // Muestra el modal

                        $('#clienteFormModalContent #idTipoCliente').off('change').on('change', toggleClientFields);

                        // Inicializar el estado de los campos al abrir el modal (para edición o nuevo)
                        toggleClientFields();

                        // Adjuntar el manejador de envío del formulario (para guardar el cliente)
                        $('#clienteFormModalContent #formCliente').off('submit').on('submit', saveCliente);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error al cargar el formulario de cliente:', error);
                        showNotification('error', 'Error al cargar el formulario de cliente. Por favor, intente de nuevo.');
                    }
                });
            };

            /**
             * Función para cerrar el modal del cliente.
             * Esta función debe ser llamada por los botones de cerrar/cancelar dentro del modal de cliente.
             * Al cerrar, recarga la lista de clientes en el formulario de ventas.
             */
            window.closeClienteFormModal = function() {
                clienteFormModalElement.modal('hide');
                clienteFormModalElement.one('hidden.bs.modal', function () {
                    clienteFormModalContent.empty(); // Limpiar el contenido al cerrar
                    clearErrors(); // Limpia errores del formulario de cliente al cerrar
                    recargarListaVentasCompleta(); 
                });
            };
            // Función para alternar campos visibles según el tipo de cliente
            function toggleClientFields() {
                const tipoClienteId = parseInt($('#clienteFormModalContent #idTipoCliente').val(), 10);
                clearErrors(); // Limpiar errores al cambiar de tipo

                // Primero, ocultar todos los campos específicos de tipo
                $('#clienteFormModalContent #naturalFields').hide();
                $('#clienteFormModalContent #juridicaFields').hide();

                // Determinar qué conjunto de campos mostrar y qué conjunto de campos limpiar
                if (tipoClienteId === 1) { // Persona Natural (Ajusta el ID si es diferente en tu DB)
                    $('#clienteFormModalContent #naturalFields').show();
                    // Limpiar solo los campos de Persona Jurídica
                    $('#clienteFormModalContent #ruc').val('');
                    $('#clienteFormModalContent #razonSocial').val('');
                    $('#clienteFormModalContent #nombreComercial').val('');
                } else if (tipoClienteId === 2) { // Persona Jurídica (Ajusta el ID si es diferente en tu DB)
                    $('#clienteFormModalContent #juridicaFields').show();
                    // Limpiar solo los campos de Persona Natural
                    $('#clienteFormModalContent #dni').val('');
                    $('#clienteFormModalContent #nombre').val('');
                    $('#clienteFormModalContent #apPaterno').val('');
                    $('#clienteFormModalContent #apMaterno').val('');
                } else { 
                    // Limpiar todos los campos específicos de tipo
                    $('#clienteFormModalContent #dni').val('');
                    $('#clienteFormModalContent #nombre').val('');
                    $('#clienteFormModalContent #apPaterno').val('');
                    $('#clienteFormModalContent #apMaterno').val('');
                    $('#clienteFormModalContent #ruc').val('');
                    $('#clienteFormModalContent #razonSocial').val('');
                    $('#clienteFormModalContent #nombreComercial').val('');
                }
                
            }

            function validateRequiredCliente(inputElementId, errorElementId, fieldName) {
                const input = $('#clienteFormModalContent #' + inputElementId);
                const value = input.val().trim();
                if (value === "") {
                    displayError(errorElementId, `${fieldName} es obligatorio.`);
                    return false;
                }
                input.removeClass('is-invalid');
                return true;
            }

            function validateDniCliente(inputElementId, errorElementId) {
                const input = $('#clienteFormModalContent #' + inputElementId);
                const value = input.val().trim();
                const regex = /^\d{8}$/;

                if (value === "") {
                    displayError(errorElementId, "El DNI es obligatorio.");
                    return false;
                } else if (!regex.test(value)) {
                    displayError(errorElementId, "El DNI debe tener 8 dígitos numéricos.");
                    return false;
                }
                input.removeClass('is-invalid');
                return true;
            }

            async function checkDniUnicoCliente(dniInputId, dniErrorId, idCliente) {
                const dni = $('#clienteFormModalContent #' + dniInputId).val();
                if (dni.trim() === "") return true;

                let url = '/ventas/checkDni?dni=' + encodeURIComponent(dni); 
                if (idCliente) {
                    url += '&idCliente=' + idCliente;
                }
                try {
                    const response = await $.ajax({ type: "GET", url: url, dataType: "json" });
                    if (response.exists) {
                        displayError(dniErrorId, "Este DNI ya está registrado.");
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error("Error al verificar DNI de cliente:", error);
                    displayError(dniErrorId, "Error al verificar DNI. Intenta de nuevo.");
                    return false;
                }
            }

            // Función para guardar el cliente
            window.saveCliente = async function(event) {
                event.preventDefault();

                const idCliente = $('#clienteFormModalContent #idCliente').val() === '' ? null : parseInt($('#clienteFormModalContent #idCliente').val(), 10);
                const fechaRegistro = $('#clienteFormModalContent #fechaRegistro').val();
                const tipoClienteId = parseInt($('#clienteFormModalContent #idTipoCliente').val(), 10);

                const clienteData = {
                    idCliente: idCliente,
                    fechaRegistro: fechaRegistro,
                    tipoCliente: { idRolCliente: tipoClienteId },
                    dni: $('#clienteFormModalContent #dni').val() || null,
                    nombre: $('#clienteFormModalContent #nombre').val() || null,
                    apPaterno: $('#clienteFormModalContent #apPaterno').val() || null,
                    apMaterno: $('#clienteFormModalContent #apMaterno').val() || null,
                    ruc: $('#clienteFormModalContent #ruc').val() || null,
                    razonSocial: $('#clienteFormModalContent #razonSocial').val() || null,
                    nombreComercial: $('#clienteFormModalContent #nombreComercial').val() || null,
                    direccion: $('#clienteFormModalContent #direccion').val(),
                    telefono: $('#clienteFormModalContent #telefono').val() || null,
                    estado: parseInt($('#clienteFormModalContent #estado').val(), 10)
                };

                try {
                    const response = await fetch('/ventas/cliente/guardar', { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(clienteData),
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        showNotification('success', result.message);
                        closeClienteFormModal(); // Cierra el modal y recarga clientes en el select de ventas
                    } else {
                        showNotification('error', result.message);
                        // Opcional: Si el backend devuelve errores de validación específicos, mostrarlos
                        if (result.errors) {
                            result.errors.forEach(err => {
                                displayError(err.field + 'Error', err.defaultMessage);
                            });
                        }
                    }
                } catch (error) {
                    showNotification('error', 'Error al guardar el cliente: ' + error.message);
                }
            };

            function recargarListaVentasCompleta() {
                $.ajax({
                    type: "GET",
                    url: '/ventas/all', 
                    dataType: "json",
                    success: function(response) {
                        allVentas = response; // Actualizar la variable global con los nuevos datos
                        aplicarFiltrosTablaVentas();// Aplicar el filtro actual a la nueva lista (mantener el término de búsqueda)
                    },
                    error: function(xhr, status, error) {
                        console.error("Error al recargar la lista completa de ventas:", error);
                        mostrarNotificacion("error", "Error al recargar la lista de ventas. Verifica el endpoint /ventas/all en tu backend.");
                    }
                });
                }
            window.clearErrors = function() {
                $('.text-danger').text('');
                $('.form-control').removeClass('is-invalid');
            };

            window.displayError = function(elementId, message) {
                $('#' + elementId).text(message);
                $('#' + elementId).prevAll('.form-control').first().addClass('is-invalid');
            };

            window.showNotification = function(type, message) {
                $(document).Toasts('create', {
                    class: type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-info' : 'bg-danger'),
                    title: type === 'success' ? 'Éxito' : (type === 'info' ? 'Información' : 'Error'),
                    body: message,
                    autohide: true,
                    delay: 3000
                });
            };

            // ===============================================
            // INICIALIZACIÓN
            // ===============================================

            recargarListaVentasCompleta();

        }); // Fin de $(document).ready
        /*]]>*/
    </script>
</th:block>
</html>
