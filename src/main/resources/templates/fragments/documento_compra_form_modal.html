<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="formContent">
    <div class="modal-header">
        <h4 class="modal-title" th:text="${documentoCompra.idCompra == null ? 'Registrar Nueva Compra' : 'Editar Documento de Compra'}"></h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeFormModal()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <form id="documentoCompraForm" th:object="${documentoCompra}"> <!-- CORRECCIÓN PRINCIPAL: th:object -->
        <div class="modal-body">
            <input type="hidden" id="idCompra" name="idCompra" th:value="*{idCompra}"/>
            <input type="hidden" id="fechaRegistro" name="fechaRegistro"
                   th:value="*{fechaRegistro != null ? #temporals.format(fechaRegistro, 'yyyy-MM-dd') : ''}"/>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="tipoDocumento">Tipo Documento:</label>
                        <select class="form-control" id="tipoDocumento" name="tipoDocumento" th:field="*{tipoDocumento}">
                            <option value="">-- Seleccione --</option>
                            <option value="Factura">Factura</option>
                            <option value="Boleta">Boleta</option>
                            <option value="Ticket">Ticket</option>
                            <option value="Recibo">Recibo</option>
                        </select>
                        <span class="text-danger" id="tipoDocumentoError"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="numDocumento">N° Documento:</label>
                        <input type="text" class="form-control" id="numDocumento" name="numDocumento" th:field="*{numDocumento}" placeholder="Número de documento">
                        <span class="text-danger" id="numDocumentoError"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="proveedorSelect">Proveedor:</label>
                        <select class="form-control" id="proveedorSelect" name="idProveedor" th:field="*{proveedor.idProveedor}">
                            <option value="">-- Seleccione un Proveedor --</option>
                            <option th:each="prov : ${proveedores}"
                                    th:value="${prov.idProveedor}"
                                    th:text="${prov.razonSocial ?: prov.nombreComercial}"
                                    th:selected="${documentoCompra.proveedor != null and documentoCompra.proveedor.idProveedor == prov.idProveedor}">
                            </option>
                        </select>
                        <span class="text-danger" id="proveedorSelectError"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="fechaRegistroDisplay">Fecha de Registro:</label>
                        <input type="date" class="form-control bg-light" id="fechaRegistroDisplay"
                               th:value="*{fechaRegistro != null ? #temporals.format(fechaRegistro, 'yyyy-MM-dd') : ''}" readonly>
                    </div>
                </div>
            </div>

            <hr/>
            <h5>Detalles de la Compra</h5>
            <div class="table-responsive">
                <table class="table table-bordered" id="detalleCompraTable">
                    <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Total</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody id="detalleComprasContainer">
                    <!-- Las filas de detalle de compra se añadirán aquí dinámicamente por JS. -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-secondary btn-sm mt-3" onclick="addDetalleCompra()">
                <i class="fas fa-plus"></i> Añadir Producto
            </button>

            <div class="row mt-4">
                <div class="col-md-6 offset-md-6">
                    <div class="form-group">
                        <label for="totalGeneralDisplay">Total Documento:</label>
                        <input type="text" class="form-control" id="totalGeneralDisplay"
                               th:value="*{total != null ? #numbers.formatDecimal(total, 0, 'COMMA', 2, 'POINT') : '0.00'}" readonly>
                    </div>
                </div>
            </div>

        </div>
        <div class="modal-footer justify-content-between">
            <button type="button" class="btn btn-default" data-dismiss="modal" onclick="closeFormModal()">Cerrar</button>
            <button type="submit" class="btn btn-primary" style="background-color:#183D00 !important; border-color:#183D00 !important;">Guardar</button>
        </div>
    </form>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // Volcar los datos del modelo Thymeleaf a variables JavaScript
        const currentModalProductosData = /*[[${productos}]]*/ [];
        const currentModalDocumentoCompraData = /*[[${documentoCompra}]]*/ null;

        // Llamar a la función de inicialización global
        if (typeof initializeModalDetails === 'function') {
            initializeModalDetails(currentModalProductosData, currentModalDocumentoCompraData);
        } else {
            console.error("Error: initializeModalDetails no está definida en el ámbito global del documento padre.");
            // Fallback: Si la función principal no se carga, al menos inicializa una fila vacía.
            // Esto es solo para evitar un error JS crítico, la carga correcta es lo ideal.
            const detalleComprasContainer = document.getElementById('detalleComprasContainer');
            if (detalleComprasContainer) {
                const tempIndex = new Date().getTime(); // Usar un índice temporal
                const rowHtml = `
                    <tr>
                        <td>
                            <select class="form-control" id="producto-${tempIndex}">
                                <option value="">Seleccione un Producto</option>
                                ${currentModalProductosData.map(p => `<option value="${p.idProducto}" data-precio="${p.precioUnitario}">${p.nombre} (Stock: ${p.stock})</option>`).join('')}
                            </select>
                            <span class="text-danger" id="productoError-${tempIndex}"></span>
                        </td>
                        <td>
                            <input type="number" class="form-control" id="cantidad-${tempIndex}" placeholder="Cantidad" min="1" value="1">
                            <span class="text-danger" id="cantidadError-${tempIndex}"></span>
                        </td>
                        <td>
                            <input type="number" step="0.01" class="form-control" id="precioUnitario-${tempIndex}" placeholder="Precio Unitario" min="0" value="0.00">
                            <span class="text-danger" id="precioUnitarioError-${tempIndex}"></span>
                        </td>
                        <td>
                            <input type="text" class="form-control total-detalle-display bg-light" id="detalleTotalDisplay-${tempIndex}" value="0.00" readonly>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); window.calculateTotalGeneral();">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
                detalleComprasContainer.innerHTML = rowHtml;
                // Adjuntar eventos para la fila temporal de fallback
                const cantidadInput = document.getElementById(`cantidad-${tempIndex}`);
                const precioInput = document.getElementById(`precioUnitario-${tempIndex}`);
                const productoSelect = document.getElementById(`producto-${tempIndex}`);

                if (cantidadInput && precioInput && productoSelect) {
                    const updateFn = () => {
                        const cant = parseFloat(cantidadInput.value) || 0;
                        const prec = parseFloat(precioInput.value) || 0;
                        document.getElementById(`detalleTotalDisplay-${tempIndex}`).value = (cant * prec).toFixed(2);
                        window.calculateTotalGeneral();
                    };
                    cantidadInput.addEventListener('input', updateFn);
                    precioInput.addEventListener('input', updateFn);
                    productoSelect.addEventListener('change', () => {
                        const selectedProduct = currentModalProductosData.find(p => p.idProducto == productoSelect.value);
                        if (selectedProduct) {
                            precioInput.value = parseFloat(selectedProduct.precioUnitario).toFixed(2);
                        }
                        updateFn();
                    });
                    updateFn();
                }
            }
        }

        // Re-adjuntar el evento submit después de que el fragmento se carga
        document.getElementById('documentoCompraForm').onsubmit = function(event) {
            event.preventDefault();
            saveDocumentoCompra(this); // 'this' se refiere al formulario
        };

        // Si es un formulario nuevo, establecer la fecha actual al cargar el fragmento
        // O si ya tiene un valor (viene de la edición), no sobrescribirlo
        if (!document.getElementById('idCompra').value && !document.getElementById('fechaRegistroDisplay').value) {
            document.getElementById('fechaRegistroDisplay').value = new Date().toISOString().split('T')[0];
        }
        /*]]>*/
    </script>
</div>
</body>
</html>
