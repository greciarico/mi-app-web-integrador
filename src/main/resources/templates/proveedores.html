<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title layout:fragment="title">Gestión de Proveedores</title>
</head>
<section layout:fragment="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Proveedores</h3>
                        <div class="card-tools">
                            <a href="javascript:void(0)" onclick="abrirFormularioProveedor('/proveedores/nuevo')"
                               class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                                <i class="fas fa-plus"></i> Crear Nuevo Proveedor
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-info" type="button" data-toggle="collapse" data-target="#collapseProveedorFilters" aria-expanded="false" aria-controls="collapseProveedorFilters">
                                <i class="fas fa-filter"></i> Mostrar/Ocultar Filtros de Proveedores
                            </button>
                        </div>

                        <div class="collapse" id="collapseProveedorFilters">
                            <div class="card card-body">
                                <form id="mainProveedorFilterForm" onsubmit="event.preventDefault(); aplicarFiltrosProveedores();">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="filtroGeneralProveedorMain">Búsqueda General (RUC, Nombre Comercial, Razón Social, Correo):</label>
                                                <input type="text" id="filtroGeneralProveedorMain" name="nombreRucRazonSocialCorreo" class="form-control" placeholder="Buscar..."/>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Estado:</label>
                                                <div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input estado-checkbox-proveedor" type="checkbox" id="estadoActivoMain" name="estados" value="1">
                                                        <label class="form-check-label" for="estadoActivoMain">Activo</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input estado-checkbox-proveedor" type="checkbox" id="estadoInactivoMain" name="estados" value="0">
                                                        <label class="form-check-label" for="estadoInactivoMain">Inactivo</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="fechaRegistroDesdeMain">Fecha de Registro Desde:</label>
                                                <input type="date" id="fechaRegistroDesdeMain" name="fechaRegistroDesde" class="form-control" onchange="setProveedorMainDateConstraints()">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="fechaRegistroHastaMain">Fecha de Registro Hasta:</label>
                                                <input type="date" id="fechaRegistroHastaMain" name="fechaRegistroHasta" class="form-control" onchange="setProveedorMainDateConstraints()">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <button class="btn btn-default" type="submit">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                        <button class="btn btn-primary ml-2" style="background-color:#b45f06 !important; border-color:#b45f06 !important;" type="button" onclick="ejecutarGenerarReporteProveedores()">
                                            <i class="fas fa-file-pdf"></i> Generar Reporte PDF
                                        </button>
                                        <button class="btn btn-secondary ml-2" type="button" onclick="limpiarFiltrosMainProveedor()">
                                            <i class="fas fa-redo"></i> Limpiar Filtros
                                        </button>
                                    </div>
                                    <div class="alert alert-info text-center mt-3" role="alert">
                                        <i class="fas fa-info-circle"></i> Deje todas las opciones de filtro sin marcar para buscar/generar un reporte de todos los proveedores no eliminados.
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div id="tablaProveedoresContainer" class="mt-3"> <table id="proveedoresTable" class="table table-bordered table-striped">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha Registro</th>
                                <th>RUC</th>
                                <th>Nombre Comercial</th>
                                <th>Razón Social</th>
                                <th>Teléfono</th>
                                <th>Correo</th>
                                <th>Dirección</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                            </thead>
                            <tbody id="proveedoresTableBody">
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="proveedorModal" tabindex="-1" role="dialog" aria-labelledby="proveedorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div id="modalFormContentProveedor">
                </div>
            </div>
        </div>
    </div>
</section>
<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        /*<![CDATA[*/

        // Variable global para almacenar todos los proveedores (esto se carga inicialmente desde el modelo de Thymeleaf)
        // allProveedores = /*[[${proveedores}]]*/ []; // Esta línea ya no es tan necesaria si siempre cargas con aplicarFiltrosProveedores()

        // Función para renderizar la tabla con una lista de proveedores
        function renderizarTablaProveedores(proveedoresToDisplay) {
            const tableBody = $('#proveedoresTableBody');
            tableBody.empty();

            if (proveedoresToDisplay.length === 0) {
                tableBody.append('<tr><td colspan="10" class="text-center">No se encontraron proveedores.</td></tr>');
                return;
            }

            proveedoresToDisplay.forEach(proveedor => {
                const estadoText = proveedor.estado === 1 ? 'Activo' : 'Inactivo';
                const estadoClass = proveedor.estado === 1 ? 'badge badge-success badge-pill' : 'badge badge-danger badge-pill';
                 const fechaRegistroFormatted = proveedor.fechaRegistro
                                              ? proveedor.fechaRegistro.split('-').reverse().join('/')
                                              : 'N/A';
                const row = `
                    <tr>
                        <td>${proveedor.idProveedor}</td>
                        <td>${fechaRegistroFormatted}</td>
                        <td>${proveedor.ruc}</td>
                        <td>${proveedor.nombreComercial}</td>
                        <td>${proveedor.razonSocial}</td>
                        <td>${proveedor.telefono || 'N/A'}</td>
                        <td>${proveedor.correo || 'N/A'}</td>
                        <td>${proveedor.direccion}</td>
                        <td class="text-center"><span class="${estadoClass}">${estadoText}</span></td>
                        <td>
                            <a href="javascript:void(0)" onclick="abrirFormularioProveedor('/proveedores/editar/${proveedor.idProveedor}')"
                               class="btn btn-info btn-sm">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="javascript:void(0)" onclick="confirmarEliminarProveedor(${proveedor.idProveedor})"
                               class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tableBody.append(row);
            });
        }

         /**
         * Limpia mensajes de error y clases inválidas
         * SOLO dentro del contenedor que le pases.
         *
         * @param {string|HTMLElement} container – selector o elemento DOM
         */
        function clearErrors(container) {
          const $c = (container instanceof HTMLElement)
            ? $(container)
            : $(container);
          $c.find('.text-danger').text('');
          $c.find('.is-invalid').removeClass('is-invalid');
        }

        // Función para mostrar un mensaje de error específico (genérica)
        function displayError(elementId, message) {
            $('#' + elementId).text(message);
            $('#' + elementId).prevAll('.form-control').first().addClass('is-invalid');
        }

        // Función para limpiar un error específico y el estado visual
        function clearSpecificError(errorElementId) {
            $('#' + errorElementId).text('');
            $('#' + errorElementId).prevAll('.form-control').first().removeClass('is-invalid');
        }

        // ===========================================
        // FUNCIONES DE VALIDACIÓN EN TIEMPO REAL - PREVIENEN CARACTERES NO VÁLIDOS Y LIMITAN LONGITUD
        // ===========================================

        // Helper para prevenir input y limitar longitud
        function preventInvalidAndLimit(event, regex, maxLength, errorElementId, fieldName) {
            const input = event.target;
            const value = input.value;
            const char = String.fromCharCode(event.which || event.keyCode);

            // Permite backspace, tab, enter, flechas, delete (para edición)
            if (event.which === 8 || event.which === 9 || event.which === 13 || event.which === 37 || event.which === 39 || event.which === 46) {
                clearSpecificError(errorElementId); // Limpia el error al borrar o moverse
                return true;
            }

            // Si el carácter no cumple con la regex, previene su entrada
            if (!regex.test(char)) {
                event.preventDefault();
                displayError(errorElementId, `${fieldName} contiene caracteres no permitidos.`);
                return false;
            }

            // Limita la longitud (si maxLength está definido)
            if (maxLength && value.length >= maxLength) {
                event.preventDefault();
                displayError(errorElementId, `${fieldName} no debe exceder ${maxLength} caracteres.`);
                return false;
            }

            // Si pasa las validaciones, limpia el error
            clearSpecificError(errorElementId);
            return true;
        }

        // Funciones de setup para cada campo en tiempo real
        function setupRucInputProveedor() {
            $('#ruc').off('keydown').on('keydown', function(event) {
                preventInvalidAndLimit(event, /^\d$/, 11, 'rucError', 'El RUC');
            }).off('input').on('input', function() {
                // Para manejar el pegado de texto que excede la longitud o no es numérico
                let value = $(this).val().replace(/\D/g, ''); // Elimina no dígitos al pegar
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }
                $(this).val(value); // Actualiza el valor del input

                if (value.length > 0 && value.length < 11) {
                    displayError('rucError', "El RUC debe tener 11 dígitos.");
                } else {
                    clearSpecificError('rucError');
                }
            }).off('blur').on('blur', function() {
                const value = $(this).val();
                if (value.length > 0 && value.length < 11) {
                    displayError('rucError', "El RUC debe tener 11 dígitos.");
                } else {
                    clearSpecificError('rucError');
                }
            });
        }

        function setupTelefonoInputProveedor() {
            $('#telefono').off('keydown').on('keydown', function(event) {
                preventInvalidAndLimit(event, /^\d$/, 9, 'telefonoError', 'El teléfono');
            }).off('input').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                if (value.length > 9) {
                    value = value.substring(0, 9);
                }
                $(this).val(value);

                if (value.length > 0 && value.length < 9) {
                    displayError('telefonoError', "El teléfono debe tener 9 dígitos.");
                } else {
                    clearSpecificError('telefonoError');
                }
            }).off('blur').on('blur', function() {
                const value = $(this).val();
                if (value.length > 0 && value.length < 9) {
                    displayError('telefonoError', "El teléfono debe tener 9 dígitos.");
                } else {
                    clearSpecificError('telefonoError');
                }
            });
        }

        function setupEmailInputProveedor() {
            $('#correo').off('input').on('input', function() {
                const value = $(this).val().trim();
                const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (value !== "" && !regex.test(value)) {
                    displayError('correoError', "Formato de correo electrónico inválido.");
                } else {
                    clearSpecificError('correoError');
                }
            });
        }

        // Para campos de texto generales (letras, números, espacios y algunos símbolos comunes)
        function setupGeneralTextInput(elementId, errorElementId, fieldName) {
            $('#' + elementId).off('keydown').on('keydown', function(event) {
                // Permite letras, números, espacios, puntos, comas, guiones, slash, ampersand, paréntesis.
                const regex = /^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑ\s.,&/\-()]*$/;
                preventInvalidAndLimit(event, regex, null, errorElementId, fieldName);
            }).off('input').on('input', function() {
                // Limpia el error al escribir correctamente
                clearSpecificError(errorElementId);
            });
        }


        // ===========================================
        // FUNCIONES DE VALIDACIÓN AL ENVIAR EL FORMULARIO (INCLUYEN REQUERIDOS)
        // ===========================================

        function validateRequiredSubmit(inputElementId, errorElementId, fieldName) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            if (value === "") {
                displayError(errorElementId, `${fieldName} es obligatorio.`);
                return false;
            }
            clearSpecificError(errorElementId);
            return true;
        }

        function validateRucSubmit(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^\d{11}$/;

            if (value === "") {
                displayError(errorElementId, "El RUC es obligatorio.");
                return false;
            } else if (!regex.test(value)) {
                displayError(errorElementId, "El RUC debe tener 11 dígitos numéricos.");
                return false;
            }
            clearSpecificError(errorElementId);
            return true;
        }

        function validateAlphanumericRequiredSubmit(inputElementId, errorElementId, fieldName) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            // Regex para validar que el contenido sea alfanumérico con algunos caracteres especiales
            const regex = /^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑ\s.,&/\-()]+$/;

            if (value === "") {
                displayError(errorElementId, `${fieldName} es obligatorio.`);
                return false;
            } else if (!regex.test(value)) {
                displayError(errorElementId, `${fieldName} contiene caracteres no permitidos.`);
                return false;
            }
            clearSpecificError(errorElementId);
            return true;
        }


        function validateTelefonoProveedorSubmit(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^\d{9}$/;

            if (value === "") {
                clearSpecificError(errorElementId);
                return true;
            } else if (!regex.test(value)) {
                displayError(errorElementId, "El teléfono debe tener 9 dígitos numéricos.");
                return false;
            }
            clearSpecificError(errorElementId);
            return true;
        }

        function validateCorreoProveedorSubmit(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (value === "") {
                clearSpecificError(errorElementId);
                return true;
            } else if (!regex.test(value)) {
                displayError(errorElementId, "Formato de correo electrónico inválido.");
                return false;
            }
            clearSpecificError(errorElementId);
            return true;
        }

        async function checkRucUnico(rucInputId, rucErrorId, proveedorId) {
            const ruc = $('#' + rucInputId).val();
            if (ruc.trim() === "") {
                clearSpecificError(rucErrorId);
                return true;
            }

            let url = '/proveedores/checkRuc?ruc=' + encodeURIComponent(ruc);
            if (proveedorId) {
                url += '&idProveedor=' + proveedorId;
            }

            try {
                const response = await $.ajax({
                    type: "GET",
                    url: url,
                    dataType: "json"
                });
                if (response.exists) {
                    displayError(rucErrorId, "Este RUC ya está registrado.");
                    $('#' + rucInputId).addClass('is-invalid');
                    return false;
                }
                clearSpecificError(rucErrorId);
                return true;
            } catch (error) {
                console.error("Error al verificar RUC:", error);
                displayError(rucErrorId, "Error al verificar RUC. Intenta de nuevo.");
                $('#' + rucInputId).addClass('is-invalid');
                return false;
            }
        }

        // Función principal de validación del formulario de Proveedor
        async function validarFormularioProveedor() {
            clearErrors('#formProveedor');
            let isValid = true;

            // Validaciones de campos obligatorios
            if (!validateRucSubmit('ruc', 'rucError')) isValid = false;
            if (!validateAlphanumericRequiredSubmit('nombreComercial', 'nombreComercialError', 'El Nombre Comercial')) isValid = false;
            if (!validateAlphanumericRequiredSubmit('razonSocial', 'razonSocialError', 'La Razón Social')) isValid = false;
            if (!validateAlphanumericRequiredSubmit('direccion', 'direccionError', 'La Dirección')) isValid = false;
            if (!validateRequiredSubmit('estado', 'estadoError', 'El estado')) isValid = false; // Asumiendo que el estado es requerido

            // Validaciones de campos opcionales si se ingresan
            if (!validateTelefonoProveedorSubmit('telefono', 'telefonoError')) isValid = false;
            if (!validateCorreoProveedorSubmit('correo', 'correoError')) isValid = false;

            // Si hay errores de formato, no proceder con la unicidad
            if (!isValid) return false;

            // Validación de unicidad de RUC (solo si RUC es válido hasta ahora)
            const proveedorId = $('#idProveedor').val();
            const rucUnico = await checkRucUnico('ruc', 'rucError', proveedorId ? parseInt(proveedorId) : null);
            if (!rucUnico) isValid = false;

            return isValid;
        }

        // ===========================================
        // MANEJADORES DE EVENTOS DEL MODAL Y FORMULARIO DE PROVEEDOR
        // ===========================================

        function abrirFormularioProveedor(url) {
          console.log("Intentando abrir formulario de proveedor desde URL:", url);
          $('#modalFormContentProveedor').load(url, function(response, status, xhr) {
            if (status === "error") {
              console.error("Error al cargar el formulario de proveedor:", xhr.status, xhr.statusText, response);
              Swal.fire({
                icon: 'error',
                title: 'Error al cargar formulario',
                text: 'Hubo un problema al cargar el formulario. Por favor, inténtalo de nuevo.',
                footer: `Detalles: ${xhr.status} ${xhr.statusText}`
              });
              return;
            }

            console.log("Formulario de proveedor cargado exitosamente.");

            // 1) Limpia SOLO los errores de este formulario
            clearErrors('#formProveedor');

            // 2) Adjunta tus validaciones en tiempo real
            attachRealTimeValidationListenersProveedor();

            // 3) Manejo del submit
            $('#formProveedor').off('submit').on('submit', async function(e) {
              e.preventDefault();
              const formIsValid = await validarFormularioProveedor();
              if (formIsValid) {
                guardarProveedorAjax($(this));
              } else {
                console.log("Formulario de proveedor inválido. No se envía.");
                mostrarNotificacion("error", "Por favor, corrige los errores en el formulario.");
              }
            });

            // 4) Finalmente, muestra el modal
            $('#proveedorModal').modal('show');
            console.log("Modal de proveedor intentando mostrarse.");
          });
        }

        function cerrarFormularioProveedor() {
            $('#proveedorModal').modal('hide');
            // Retraso para asegurar que el modal se oculte completamente antes de limpiar el contenido
            setTimeout(function() {
                $('#modalFormContentProveedor').empty();
                $('.modal-backdrop').remove(); // Limpiar el fondo oscuro del modal si se queda
                $('body').removeClass('modal-open'); // Quitar la clase que bloquea el scroll
            }, 300); // 300ms, coincide con la duración de la transición del modal
            clearErrors('#formProveedor');
            console.log("Modal de proveedor cerrado.");
        }


        // Función para adjuntar todos los escuchadores de validación en tiempo real para proveedores
        function attachRealTimeValidationListenersProveedor() {
            setupRucInputProveedor();
            setupTelefonoInputProveedor();
            setupEmailInputProveedor();
            setupGeneralTextInput('nombreComercial', 'nombreComercialError', 'El Nombre Comercial');
            setupGeneralTextInput('razonSocial', 'razonSocialError', 'La Razón Social');
            setupGeneralTextInput('direccion', 'direccionError', 'La Dirección');
        }


        function guardarProveedorAjax(formElement) {
            // Recopilar datos del formulario
            const idProveedor = $('#idProveedor').val();
            const dataToSend = {
                idProveedor: idProveedor === '' ? null : parseInt(idProveedor, 10),
                ruc: $('#ruc').val(),
                nombreComercial: $('#nombreComercial').val(),
                razonSocial: $('#razonSocial').val(),
                telefono: $('#telefono').val(),
                correo: $('#correo').val(),
                direccion: $('#direccion').val(),
                estado: parseInt($('#estado').val(), 10)
            };

            const url = '/proveedores/guardar'; // Endpoint para guardar/actualizar proveedores

            $.ajax({
                type: "POST",
                url: url,
                contentType: 'application/json', // Importante para enviar JSON
                data: JSON.stringify(dataToSend), // Enviar datos como JSON
                success: function(response) {
                    if (response.status === "success") {
                        mostrarNotificacion("success", response.message);
                        cerrarFormularioProveedor();
                        aplicarFiltrosProveedores(); // CAMBIO: Usar aplicarFiltrosProveedores
                    } else {
                        // Si el backend devuelve errores de validación por campo
                        if (response.errors) {
                            response.errors.forEach(err => {
                                displayError(err.field + 'Error', err.defaultMessage);
                            });
                        }
                        mostrarNotificacion("error", "Error: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = "Error al procesar la solicitud.";
                    // Intenta obtener un mensaje de error más específico del servidor
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ": " + xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        errorMessage += ": " + xhr.responseText.substring(0, Math.min(xhr.responseText.length, 100)) + "...";
                    }
                    mostrarNotificacion("error", errorMessage);
                    console.error("Error AJAX al guardar proveedor:", error, xhr.responseText, xhr);
                }
            });
        }

        function confirmarEliminarProveedor(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡El proveedor será marcado como inactivo!", // Cambiado a inactivo
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, inactivar', // Texto del botón cambiado
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log("Inactivando proveedor con ID:", id);
                    $.ajax({
                        type: "POST", // Cambiado a POST para ser RESTful para una acción de estado
                        url: '/proveedores/inactivar/' + id, // Nuevo endpoint para inactivar
                        success: function(response) {
                            if (response.status === "success") {
                                mostrarNotificacion("success", response.message);
                                aplicarFiltrosProveedores(); // CAMBIO: Usar aplicarFiltrosProveedores
                            } else {
                                mostrarNotificacion("error", "Error: " + response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            let errorMessage = "Error al inactivar el proveedor.";
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ": " + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ": " + xhr.responseText.substring(0, Math.min(xhr.responseText.length, 100)) + "...";
                            }
                            mostrarNotificacion("error", errorMessage);
                            console.error("Error AJAX al inactivar proveedor:", error, xhr.responseText);
                        }
                    });
                }
            });
        }

        // ===========================================
        // FUNCIONES DE FILTRADO Y REPORTE DE PROVEEDORES (SERVER-SIDE)
        // ===========================================

        // Esta función ahora construye el DTO de filtro y lo envía al servidor para la tabla
        function aplicarFiltrosProveedores() {
            const filterDTO = {
                nombreRucRazonSocialCorreo: $('#filtroGeneralProveedorMain').val(),
                estados: [],
                fechaRegistroDesde: $('#fechaRegistroDesdeMain').val(),
                fechaRegistroHasta: $('#fechaRegistroHastaMain').val()
            };

            // Recoger los estados seleccionados
            $('.estado-checkbox-proveedor:checked').each(function() {
                filterDTO.estados.push(parseInt($(this).val()));
            });

            // ELIMINAR ESTE BLOQUE: Si ningún estado está seleccionado, enviar vacío para que el backend maneje "todos no eliminados"
            // if (filterDTO.estados.length === 0) {
            //     // Si ninguno está chequeado, no incluir el parámetro 'estados' en la query string
            //     delete filterDTO.estados;
            // }

            const queryString = $.param(filterDTO, true); // `true` para array params
            const url = '/proveedores/buscar?' + queryString; // Usar un nuevo endpoint para la búsqueda de tabla

            $.ajax({
                type: "GET",
                url: url,
                dataType: "json",
                success: function(response) {
                    renderizarTablaProveedores(response);
                },
                error: function(xhr, status, error) {
                    console.error("Error al buscar proveedores con filtros:", error, xhr.responseText);
                    mostrarNotificacion("error", "Error al buscar proveedores. Intenta de nuevo.");
                }
            });
        }


        // NUEVAS FUNCIONES PARA EL REPORTE PDF DE PROVEEDORES (AHORA USAN LOS FILTROS PRINCIPALES)

        // Limpia los filtros del formulario principal de Proveedores
        function limpiarFiltrosMainProveedor() {
            $('#mainProveedorFilterForm')[0].reset(); // Resetea todos los campos del formulario
            //$('#estadoActivoMain').prop('checked', true); // Marca 'Activo' por defecto
            $('#estadoInactivoMain').prop('checked', false); // Desmarca 'Inactivo'
            setProveedorMainDateConstraints(); // Restablece los límites de fecha
            aplicarFiltrosProveedores(); // Vuelve a cargar la tabla sin filtros (solo Activos)
        }

        // Función para ajustar los atributos 'min' y 'max' de los campos de fecha en el filtro principal
        function setProveedorMainDateConstraints() {
            const today = new Date().toISOString().split('T')[0];
            const fechaDesdeInput = $('#fechaRegistroDesdeMain');
            const fechaHastaInput = $('#fechaRegistroHastaMain');

            fechaDesdeInput.attr('max', today);
            fechaHastaInput.attr('max', today);

            // Ajustar el "max" de la fecha de inicio basado en la fecha de fin
            if (fechaHastaInput.val()) {
                fechaDesdeInput.attr('max', fechaHastaInput.val());
            }

            // Ajustar el "min" de la fecha de fin basado en la fecha de inicio
            if (fechaDesdeInput.val()) {
                fechaHastaInput.attr('min', fechaDesdeInput.val());
            } else {
                fechaHastaInput.removeAttr('min'); // Si no hay fecha de inicio, no hay min
            }
        }

        // Ejecuta la generación del reporte PDF
        function ejecutarGenerarReporteProveedores() {
            Swal.fire({
                title: 'Generando Reporte...',
                text: 'Por favor, espera mientras se genera el PDF.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Recopilar los datos del formulario de filtro principal
            const filterDTO = {
                nombreRucRazonSocialCorreo: $('#filtroGeneralProveedorMain').val(),
                estados: [],
                fechaRegistroDesde: $('#fechaRegistroDesdeMain').val(),
                fechaRegistroHasta: $('#fechaRegistroHastaMain').val()
            };

            // Recoger los estados seleccionados para el reporte
            $('.estado-checkbox-proveedor:checked').each(function() {
                filterDTO.estados.push(parseInt($(this).val()));
            });

            // ELIMINAR ESTE BLOQUE: Si ningún estado está seleccionado, enviar vacío para que el backend maneje "todos no eliminados"
            // if (filterDTO.estados.length === 0) {
            //     // Si ninguno está chequeado, no incluir el parámetro 'estados' en la query string
            //     delete filterDTO.estados;
            // }

            const queryString = $.param(filterDTO, true); // `true` para array params
            const url = '/proveedores/reporte/pdf?' + queryString;

            setTimeout(() => {
                const newWindow = window.open(url, '_blank');
                if (newWindow) {
                    Swal.close();
                    mostrarNotificacion("success", "El reporte PDF se está generando y debería abrirse en una nueva pestaña.");
                } else {
                    Swal.close();
                    mostrarNotificacion("error", "Error: Tu navegador bloqueó la apertura del PDF. Por favor, permite los pop-ups para este sitio.");
                }
            }, 300);
        }

        // Función para mostrar notificaciones usando AdminLTE Toasts
        function mostrarNotificacion(type, message) {
            $(document).Toasts('create', {
                class: type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-info' : 'bg-danger'),
                title: type === 'success' ? 'Éxito' : (type === 'info' ? 'Información' : 'Error'),
                body: message,
                autohide: true,
                delay: 3000
            });
        }


        // Ejecutar al cargar la página por primera vez
        $(document).ready(function() {
            setProveedorMainDateConstraints(); // Asegurarse de que las fechas tengan límites correctos al cargar la página
            // YA NO SE MARCA 'Activo' por defecto si no lo deseas
            // $('#estadoActivoMain').prop('checked', true); // <-- REMOVIDA/COMENTADA
            $('#estadoInactivoMain').prop('checked', false); // Mantenla si quieres Inactivo sin marcar al cargar
            aplicarFiltrosProveedores(); // Carga inicial de datos con los filtros (vacíos o por defecto)
        });

        /*]]>*/
    </script>
</th:block>
</html>
