<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title layout:fragment="title">Gestión de Merma</title>
</head>

<section layout:fragment="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Registros de Merma</h3>
                        <div class="card-tools">
                            <a href="javascript:void(0)" onclick="abrirFormularioMerma('/merma/nuevo')"
                               class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                                <i class="fas fa-plus"></i> Registrar Nueva Merma
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-info" type="button" data-toggle="collapse" data-target="#collapseMermaFilters" aria-expanded="false" aria-controls="collapseMermaFilters">
                                <i class="fas fa-filter"></i> Mostrar/Ocultar Filtros de Merma
                            </button>
                        </div>

                        <div class="collapse" id="collapseMermaFilters">
                            <div class="card card-body">
                                <form id="mainMermaFilterForm" onsubmit="event.preventDefault(); aplicarFiltrosMerma();">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="filtroIdProductoMermaMain">Producto:</label>
                                                <select id="filtroIdProductoMermaMain" name="idProducto" class="form-control">
                                                    <option value="">Todos los Productos</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="filtroNombreProductoMermaMain">Nombre de Producto (búsqueda):</label>
                                                <input type="text" id="filtroNombreProductoMermaMain" name="nombreProducto" class="form-control" placeholder="Buscar por nombre de producto"/>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label for="filtroDescripcionMermaMain">Descripción de Merma:</label>
                                                <input type="text" id="filtroDescripcionMermaMain" name="descripcionMerma" class="form-control" placeholder="Buscar por descripción de la merma"/>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Cantidad:</label>
                                                <div class="input-group">
                                                    <input type="number" id="cantidadMermaMinMain" name="cantidadMin" class="form-control" placeholder="Min">
                                                    <input type="number" id="cantidadMermaMaxMain" name="cantidadMax" class="form-control" placeholder="Max">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Fecha de Registro:</label>
                                                <div class="input-group">
                                                    <input type="date" id="fechaRegistroMermaStartMain" name="fechaRegistroStart" class="form-control" onchange="setMermaMainDateMaxAttributes()">
                                                    <input type="date" id="fechaRegistroMermaEndMain" name="fechaRegistroEnd" class="form-control" onchange="setMermaMainDateMinAttributes()">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <button class="btn btn-default" type="submit">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                        <button class="btn btn-primary ml-2" style="background-color:#b45f06 !important; border-color:#b45f06 !important;" type="button" onclick="ejecutarGenerarReporteMermas()">
                                            <i class="fas fa-file-pdf"></i> Generar Reporte PDF
                                        </button>
                                        <button class="btn btn-secondary ml-2" type="button" onclick="limpiarFiltrosMainMerma()">
                                            <i class="fas fa-redo"></i> Limpiar Filtros
                                        </button>
                                    </div>
                                    <div class="alert alert-info text-center mt-3" role="alert">
                                        <i class="fas fa-info-circle"></i> Deje todas las opciones de filtro sin marcar para buscar/generar un reporte de todas las mermas.
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div id="tablaMermaContainer" class="mt-3"> <table id="mermaTable" class="table table-bordered table-striped">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Fecha Registro</th>
                                <th>Descripción</th>
                                <th>Acciones</th>
                            </tr>
                            </thead>
                            <tbody id="mermaTableBody">
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="mermaModal" tabindex="-1" role="dialog" aria-labelledby="mermaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div id="modalFormContentMerma">
                </div>
            </div>
        </div>
    </div>
</section>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        /*<![CDATA[*/

        // `allMermas` ya no será necesaria para el filtrado en cliente
        // ya que el filtrado se moverá completamente al servidor.
        // Se mantiene si aún la usas para otras funciones (ej. para un "exportar a CSV" en cliente)
        allMermas = [];

        // Función para renderizar la tabla con una lista de Merma
        function renderizarTablaMerma(mermasToDisplay) {
            const tableBody = $('#mermaTableBody');
            tableBody.empty();

            if (mermasToDisplay.length === 0) {
                tableBody.append('<tr><td colspan="6" class="text-center">No se encontraron registros de Merma.</td></tr>');
                return;
            }

            mermasToDisplay.forEach(merma => {
                const fechaRegistroFormatted = merma.fechaRegistro ? new Date(merma.fechaRegistro).toLocaleDateString('es-ES') : 'N/A';
                const productName = merma.producto ? merma.producto.nombre : 'Producto Desconocido';

                const row = `
                    <tr>
                        <td>${merma.idMerma}</td>
                        <td>${productName}</td>
                        <td>${merma.cantidad}</td>
                        <td>${fechaRegistroFormatted}</td>
                        <td>${merma.descripcion || 'N/A'}</td>
                        <td>
                            <a href="javascript:void(0)" onclick="abrirFormularioMerma('/merma/editar/${merma.idMerma}')"
                               class="btn btn-info btn-sm">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="javascript:void(0)" onclick="confirmarEliminarMerma(${merma.idMerma})"
                               class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tableBody.append(row);
            });
        }

        /**
       * Limpia mensajes de error y clases inválidas
       * SOLO dentro del contenedor que le pases.
       *
       * @param {string|HTMLElement} container – selector o elemento DOM
       */
        function clearErrors(container) {
            const $c = (container instanceof HTMLElement)
                ? $(container)
                : $(container);
            $c.find('.text-danger').text('');
            $c.find('.is-invalid').removeClass('is-invalid');
        }

        // Función para mostrar un mensaje de error específico (genérica)
        function displayError(elementId, message) {
            $('#' + elementId).text(message);
            $('#' + elementId).prevAll('.form-control').first().addClass('is-invalid');
        }

        // ===========================================
        // FUNCIONES DE VALIDACIÓN ESPECÍFICAS (PARA MERMA)
        // ===========================================

        function validateCantidadMerma(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const numValue = parseInt(value, 10);

            if (value === "") {
                displayError(errorElementId, "La cantidad es obligatoria.");
                return false;
            } else if (isNaN(numValue) || numValue <= 0 || !/^\d+$/.test(value)) {
                displayError(errorElementId, "La cantidad debe ser un número entero positivo.");
                return false;
            }
            input.removeClass('is-invalid');
            return true;
        }

        function validateProductoMerma(selectElementId, errorElementId) {
            const select = $('#' + selectElementId);
            const value = select.val();
            if (value === "" || value === null) {
                displayError(errorElementId, "Debe seleccionar un producto.");
                return false;
            }
            select.removeClass('is-invalid');
            return true;
        }

        // Función principal de validación del formulario de Merma
        async function validarFormularioMerma() {
            clearErrors('#formMerma');
            let isValid = true;

            if (!validateProductoMerma('idProducto', 'productoError')) isValid = false;
            if (!validateCantidadMerma('cantidad', 'cantidadError')) isValid = false;
            // La descripción es opcional, no necesita validación de obligatoriedad

            return isValid;
        }

        // ===========================================
        // MANEJADORES DE EVENTOS DEL MODAL Y FORMULARIO DE MERMA
        // ===========================================

        function abrirFormularioMerma(url) {
            console.log("Intentando abrir formulario de Merma desde URL:", url);
            $('#modalFormContentMerma').load(url, function(response, status, xhr) {
                if (status === "error") {
                    console.error("Error al cargar el formulario de Merma:", xhr.status, xhr.statusText, response);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al cargar formulario',
                        text: 'Hubo un problema al cargar el formulario de Merma. Por favor, inténtalo de nuevo.',
                        footer: `Detalles: ${xhr.status} ${xhr.statusText}`
                    });
                    return;
                }

                console.log("Formulario de Merma cargado exitosamente.");

                clearErrors('#formMerma');

                // Inicializa Select2 en #idProducto dentro del modal
                setTimeout(() => {
                    $('#idProducto').select2({
                        placeholder: "-- Seleccione o Busque un Producto --",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $('#mermaModal')
                    });
                    console.log("Select2 inicializado en #idProducto.");
                }, 100);

                $('#formMerma')
                    .off('submit')
                    .on('submit', async function(e) {
                        e.preventDefault();
                        const formIsValid = await validarFormularioMerma();
                        if (formIsValid) {
                            guardarMermaAjax();
                        } else {
                            console.log("Formulario de Merma inválido. No se envía.");
                            mostrarNotificacion("error", "Por favor, corrige los errores en el formulario de Merma.");
                        }
                    });

                $('#mermaModal').modal('show');
                console.log("Modal de Merma intentando mostrarse.");
            });
        }

        function cerrarFormularioMerma() {
            $('#mermaModal').modal('hide');
            const selectProducto = $('#idProducto');
            if (selectProducto.data('select2')) {
                selectProducto.select2('destroy');
                console.log("Select2 destruido en #idProducto.");
            }

            setTimeout(function() {
                $('#modalFormContentMerma').empty();
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open');
            }, 300);
            clearErrors('#formMerma');
            console.log("Modal de Merma cerrado.");
        }

        function guardarMermaAjax() {
            const idMerma = $('#idMerma').val();
            const fechaRegistro = $('#fechaRegistro').val();
            const cantidad = parseInt($('#cantidad').val(), 10);
            const descripcion = $('#descripcion').val();
            const idProducto = parseInt($('#idProducto').val(), 10);

            const dataToSend = {
                idMerma: idMerma === '' ? null : parseInt(idMerma, 10),
                fechaRegistro: fechaRegistro,
                cantidad: cantidad,
                descripcion: descripcion,
                producto: { idProducto: idProducto }
            };

            const url = '/merma/guardar';

            $.ajax({
                type: "POST",
                url: url,
                contentType: 'application/json',
                data: JSON.stringify(dataToSend),
                success: function(response) {
                    if (response.status === "success") {
                        mostrarNotificacion("success", response.message);
                        cerrarFormularioMerma();
                        aplicarFiltrosMerma(); // Ahora llama a aplicarFiltrosMerma directamente
                    } else {
                        mostrarNotificacion("error", "Error: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = "Error al procesar la solicitud.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ": " + xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        errorMessage += ": " + xhr.responseText.substring(0, Math.min(xhr.responseText.length, 100)) + "...";
                    }
                    mostrarNotificacion("error", errorMessage);
                    console.error("Error AJAX al guardar Merma:", error, xhr.responseText, xhr);
                }
            });
        }


        function confirmarEliminarMerma(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡Esto repondrá el stock del producto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log("Eliminando Merma con ID:", id);
                    $.ajax({
                        type: "GET",
                        url: '/merma/eliminar/' + id,
                        success: function(response) {
                            if (response.status === "success") {
                                mostrarNotificacion("success", response.message);
                                aplicarFiltrosMerma(); // Ahora llama a aplicarFiltrosMerma
                            } else {
                                mostrarNotificacion("error", "Error: " + response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            let errorMessage = "Error al eliminar la Merma.";
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ": " + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ": " + xhr.responseText.substring(0, Math.min(xhr.responseText.length, 100)) + "...";
                            }
                            mostrarNotificacion("error", errorMessage);
                            console.error("Error AJAX al eliminar Merma:", error, xhr.responseText);
                        }
                    });
                }
            });
        }

        // ===========================================
        // FUNCIONES DE FILTRADO Y REPORTE DE MERMA (SERVER-SIDE)
        // ===========================================

        // Esta función ahora enviará los filtros al servidor y recargará la tabla
        function aplicarFiltrosMerma() {
            const filterDTO = {
                idProducto: $('#filtroIdProductoMermaMain').val() === "" ? null : parseInt($('#filtroIdProductoMermaMain').val()),
                nombreProducto: $('#filtroNombreProductoMermaMain').val(),
                descripcionMerma: $('#filtroDescripcionMermaMain').val(),
                cantidadMin: $('#cantidadMermaMinMain').val() === "" ? null : parseInt($('#cantidadMermaMinMain').val()),
                cantidadMax: $('#cantidadMermaMaxMain').val() === "" ? null : parseInt($('#cantidadMermaMaxMain').val()),
                fechaRegistroStart: $('#fechaRegistroMermaStartMain').val() === "" ? null : $('#fechaRegistroMermaStartMain').val(),
                fechaRegistroEnd: $('#fechaRegistroMermaEndMain').val() === "" ? null : $('#fechaRegistroMermaEndMain').val()
            };

            const queryString = $.param(filterDTO);
            const url = '/merma/buscar?' + queryString; // Asegúrate de tener este endpoint en tu controlador

            $.ajax({
                type: "GET",
                url: url,
                dataType: "json",
                success: function(response) {
                    renderizarTablaMerma(response);
                },
                error: function(xhr, status, error) {
                    console.error("Error al buscar mermas con filtros:", error, xhr.responseText);
                    mostrarNotificacion("error", "Error al buscar mermas. Intenta de nuevo.");
                }
            });
        }

        // Ejecuta la generación del reporte PDF de mermas
        function ejecutarGenerarReporteMermas() {
            Swal.fire({
                title: 'Generando Reporte...',
                text: 'Por favor, espera mientras se genera el PDF.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const filterDTO = {
                idProducto: $('#filtroIdProductoMermaMain').val() === "" ? null : parseInt($('#filtroIdProductoMermaMain').val()),
                nombreProducto: $('#filtroNombreProductoMermaMain').val(),
                descripcionMerma: $('#filtroDescripcionMermaMain').val(),
                cantidadMin: $('#cantidadMermaMinMain').val() === "" ? null : parseInt($('#cantidadMermaMinMain').val()),
                cantidadMax: $('#cantidadMermaMaxMain').val() === "" ? null : parseInt($('#cantidadMermaMaxMain').val()),
                fechaRegistroStart: $('#fechaRegistroMermaStartMain').val() === "" ? null : $('#fechaRegistroMermaStartMain').val(),
                fechaRegistroEnd: $('#fechaRegistroMermaEndMain').val() === "" ? null : $('#fechaRegistroMermaEndMain').val()
            };

            const queryString = $.param(filterDTO);
            const url = '/merma/reporte/pdf?' + queryString;

            setTimeout(() => {
                const newWindow = window.open(url, '_blank');
                if (newWindow) {
                    Swal.close();
                    mostrarNotificacion("success", "El reporte PDF se está generando y debería abrirse en una nueva pestaña.");
                } else {
                    Swal.close();
                    mostrarNotificacion("error", "Error: Tu navegador bloqueó la apertura del PDF. Por favor, permite los pop-ups para este sitio.");
                }
            }, 300);
        }

        // Limpia los filtros del formulario principal de Merma
        function limpiarFiltrosMainMerma() {
            $('#mainMermaFilterForm')[0].reset();
            // Para Select2, necesitas establecer el valor a vacío y triggerear el cambio
            $('#filtroIdProductoMermaMain').val('').trigger('change');
            setMermaMainDateMaxAttributes(); // Restablecer límites de fecha
            setMermaMainDateMinAttributes();
            aplicarFiltrosMerma(); // Vuelve a cargar la tabla sin filtros
        }

        // Función para cargar los productos en el select de filtros
        function cargarProductosEnFiltroMerma() {
            $.ajax({
                type: "GET",
                url: '/merma/productos', // Este endpoint devuelve solo productos activos
                dataType: "json",
                success: function(productos) {
                    const select = $('#filtroIdProductoMermaMain');
                    select.empty();
                    select.append('<option value="">Todos los Productos</option>');
                    productos.forEach(producto => {
                        select.append(`<option value="${producto.idProducto}">${producto.nombre}</option>`);
                    });
                    // Inicializar Select2 en el filtro principal
                    $('#filtroIdProductoMermaMain').select2({
                        placeholder: "-- Seleccione o Busque un Producto --",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $('#collapseMermaFilters') // Asegúrate de que el dropdown se muestre correctamente
                    });
                },
                error: function(xhr, status, error) {
                    console.error("Error al cargar productos para el filtro de merma:", error);
                }
            });
        }

        // Función para ajustar el atributo 'max' de la fecha de inicio del reporte
        function setMermaMainDateMaxAttributes() {
            const today = new Date().toISOString().split('T')[0];
            $('#fechaRegistroMermaStartMain').attr('max', today);

            const fechaFin = $('#fechaRegistroMermaEndMain').val();
            if (fechaFin && $('#fechaRegistroMermaStartMain').val() && new Date(fechaFin) < new Date($('#fechaRegistroMermaStartMain').val())) {
                $('#fechaRegistroMermaEndMain').val($('#fechaRegistroMermaStartMain').val());
            }
            $('#fechaRegistroMermaEndMain').attr('min', $('#fechaRegistroMermaStartMain').val());
        }

        // Función para ajustar el atributo 'min' de la fecha de fin del reporte
        function setMermaMainDateMinAttributes() {
            const today = new Date().toISOString().split('T')[0];
            $('#fechaRegistroMermaEndMain').attr('max', today);

            const fechaInicio = $('#fechaRegistroMermaStartMain').val();
            if (fechaInicio && $('#fechaRegistroMermaEndMain').val() && new Date(fechaInicio) > new Date($('#fechaRegistroMermaEndMain').val())) {
                $('#fechaRegistroMermaStartMain').val($('#fechaRegistroMermaEndMain').val());
            }
            $('#fechaRegistroMermaStartMain').attr('max', $('#fechaRegistroMermaEndMain').val() || today);
        }

        // Función para mostrar notificaciones usando AdminLTE Toasts
        function mostrarNotificacion(type, message) {
            $(document).Toasts('create', {
                class: type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-info' : 'bg-danger'),
                title: type === 'success' ? 'Éxito' : (type === 'info' ? 'Información' : 'Error'),
                body: message,
                autohide: true,
                delay: 3000
            });
        }

        // Ejecutar al cargar la página por primera vez
        $(document).ready(function() {
            cargarProductosEnFiltroMerma(); // Carga los productos para el Select2 del filtro principal
            setMermaMainDateMaxAttributes(); // Inicializa límites de fecha
            setMermaMainDateMinAttributes();
            aplicarFiltrosMerma(); // Carga inicial de datos con los filtros (vacíos al inicio)
        });

        /*]]>*/
    </script>
</th:block>
</html>
