<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title layout:fragment="title">Gestión de Clientes</title>
</head>
<section layout:fragment="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Clientes</h3>
                        <div class="card-tools">
                            <a href="javascript:void(0)" onclick="abrirFormularioCliente('/clientes/nuevo')"
                               class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                                <i class="fas fa-user-plus"></i> Crear Nuevo Cliente
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-info" type="button" data-toggle="collapse" data-target="#collapseClientFilters" aria-expanded="false" aria-controls="collapseClientFilters">
                                <i class="fas fa-filter"></i> Mostrar/Ocultar Filtros Avanzados
                            </button>
                        </div>

                        <div class="collapse" id="collapseClientFilters">
                            <div class="card card-body">
                                <form id="mainClientFilterForm" onsubmit="event.preventDefault(); aplicarFiltrosCliente();">
                                    <div class="form-row">
                                        <div class="form-group col-md-4">
                                            <label for="filtroTipoClienteMain">Filtrar por Tipo de Cliente:</label>
                                            <select class="form-control" id="filtroTipoClienteMain" name="idTipoCliente">
                                                <option value="">Todos</option>
                                                <option th:each="tipo : ${tiposCliente}"
                                                        th:value="${tipo.idRolCliente}"
                                                        th:text="${tipo.rolCliente}">
                                                </option>
                                            </select>
                                        </div>
                                        <div class="form-group col-md-8">
                                            <label for="searchTermClienteMain">Buscar por DNI, RUC, nombre, razón social...</label>
                                            <input type="text" id="searchTermClienteMain" name="nombreCompletoODoc" class="form-control"
                                                   placeholder="DNI, RUC, nombre, razón social..."/>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-md-4">
                                            <label for="filtroDireccionClienteMain">Dirección:</label>
                                            <input type="text" id="filtroDireccionClienteMain" name="direccion" class="form-control" placeholder="Buscar por dirección"/>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="filtroTelefonoClienteMain">Teléfono:</label>
                                            <input type="text" id="filtroTelefonoClienteMain" name="telefono" class="form-control" placeholder="Buscar por teléfono"/>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="filtroEstadoClienteReporteMain">Estado:</label>
                                            <select id="filtroEstadoClienteReporteMain" name="estado" class="form-control">
                                                <option value="">Todos (Activos e Inactivos)</option>
                                                <option value="1">Activo</option>
                                                <option value="0">Inactivo</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label>Fecha de Registro (Desde):</label>
                                            <input type="date" id="fechaRegistroClienteStartMain" name="fechaRegistroStart" class="form-control" onchange="setMainDateMaxAttributesCliente()">
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label>Fecha de Registro (Hasta):</label>
                                            <input type="date" id="fechaRegistroClienteEndMain" name="fechaRegistroEnd" class="form-control" onchange="setMainDateMinAttributesCliente()">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <button class="btn btn-default" type="submit">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                        <button class="btn btn-success ml-2" type="button" onclick="ejecutarGenerarReporteClientes()"
                                                style="background-color:#b45f06 !important; border-color:#b45f06 !important;">
                                            <i class="fas fa-file-pdf"></i> Generar Reporte PDF
                                        </button>
                                        <button class="btn btn-secondary ml-2" type="button" onclick="limpiarFiltrosMainCliente()">
                                            <i class="fas fa-redo"></i> Limpiar Filtros
                                        </button>
                                    </div>
                                </form>
                                <div class="alert alert-info text-center mt-3" role="alert">
                                    <i class="fas fa-info-circle"></i> Deje todas las opciones de filtro sin marcar para buscar/generar un reporte de todos los clientes.
                                </div>
                            </div>
                        </div>

                        <div id="tablaClientesContainer" class="mt-3">
                            <table id="clientesTable" class="table table-bordered table-striped">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Tipo</th>
                                    <th>DNI/RUC</th>
                                    <th>Nombre/Razón Social</th>
                                    <th>Dirección</th>
                                    <th>Teléfono</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody id="clientesTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="clienteModal" tabindex="-1" role="dialog" aria-labelledby="clienteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div id="modalFormContentCliente">
                </div>
            </div>
        </div>
    </div>
</section>
<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        /*<![CDATA[*/

        allClientes = /*[[${clientes}]]*/ []; // Se inicializa vacío, o con la lista inicial si tu controller la pasa.

        // Función para renderizar la tabla con una lista de Cliente
        function renderizarTablaCliente(clientesToDisplay) {
            const tableBody = $('#clientesTableBody');
            tableBody.empty();

            if (clientesToDisplay.length === 0) {
                tableBody.append('<tr><td colspan="8" class="text-center">No se encontraron registros de Clientes.</td></tr>');
                return;
            }

            clientesToDisplay.forEach(cliente => {
                const tipoClienteNombre = cliente.tipoCliente ? cliente.tipoCliente.rolCliente : 'Desconocido';
                const identificacion = cliente.dni || cliente.ruc || 'N/A';
                const nombreDisplay = cliente.nombre ? `${cliente.nombre} ${cliente.apPaterno || ''} ${cliente.apMaterno || ''}`.trim() : cliente.razonSocial || 'N/A';
                const estadoText = cliente.estado === 1 ? 'Activo' : 'Inactivo';
                const estadoClass = cliente.estado === 1 ? 'badge badge-success badge-pill' : 'badge badge-danger badge-pill';

                const row = `
                    <tr>
                        <td>${cliente.idCliente}</td>
                        <td>${tipoClienteNombre}</td>
                        <td>${identificacion}</td>
                        <td>${nombreDisplay}</td>
                        <td>${cliente.direccion || 'N/A'}</td>
                        <td>${cliente.telefono || 'N/A'}</td>
                        <td class="text-center"><span class="${estadoClass}">${estadoText}</span></td>
                        <td>
                            <a href="javascript:void(0)" onclick="abrirFormularioCliente('/clientes/editar/${cliente.idCliente}')"
                               class="btn btn-info btn-sm">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="javascript:void(0)" onclick="confirmarEliminarCliente(${cliente.idCliente})"
                               class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tableBody.append(row);
            });
        }

          /**
         * Limpia mensajes de error y clases inválidas
         * SOLO dentro del contenedor que le pases.
         *
         * @param {string|HTMLElement} container – selector o elemento DOM
         */
        function clearErrors(container) {
          const $c = (container instanceof HTMLElement)
            ? $(container)
            : $(container);
          $c.find('.text-danger').text('');
          $c.find('.is-invalid').removeClass('is-invalid');
        }


        // Función para mostrar un mensaje de error específico (genérica)
        function displayError(elementId, message) {
            $('#' + elementId).text(message);
            // Asegúrate de que el elemento padre tenga el .form-control para aplicar is-invalid
            $('#' + elementId).prevAll('.form-control').first().addClass('is-invalid');
            // En caso de que sea un input-group, busca dentro de él
            if ($('#' + elementId).prevAll('.input-group').length > 0) {
                 $('#' + elementId).prevAll('.input-group').first().find('input, select').first().addClass('is-invalid');
            }
        }

        // ===========================================
        // FUNCIONES DE VALIDACIÓN EN TIEMPO REAL - PREVIENEN CARACTERES NO VÁLIDOS Y LIMITAN LONGITUD
        // ===========================================

        // Helper para prevenir input y limitar longitud
        function preventInvalidAndLimit(event, regex, maxLength, errorElementId, fieldName) {
            const input = event.target;
            const value = input.value;
            const char = String.fromCharCode(event.which || event.keyCode);

            // Permite backspace, tab, enter, flechas, delete (para edición)
            if (event.which === 8 || event.which === 9 || event.which === 13 || event.which === 37 || event.which === 39 || event.which === 46) {
                return true;
            }

            // Si el carácter no cumple con la regex, previene su entrada
            if (!regex.test(char)) {
                event.preventDefault();
                displayError(errorElementId, `${fieldName} solo debe contener caracteres válidos.`);
                return false;
            }

            // Limita la longitud
            if (maxLength && value.length >= maxLength) {
                event.preventDefault();
                displayError(errorElementId, `${fieldName} no debe exceder ${maxLength} caracteres.`);
                return false;
            }

            // Si pasa las validaciones, limpia el error
            clearSpecificError(errorElementId);
            return true;
        }

        // Función para limpiar un error específico y el estado visual
        function clearSpecificError(errorElementId) {
            $('#' + errorElementId).text('');
            $('#' + errorElementId).prevAll('.form-control').first().removeClass('is-invalid');
            if ($('#' + errorElementId).prevAll('.input-group').length > 0) {
                 $('#' + errorElementId).prevAll('.input-group').first().find('input, select').first().removeClass('is-invalid');
            }
        }


        // Funciones específicas para cada campo en tiempo real (keydown para prevenir input)
        function setupDniInput() {
            $('#dni').off('keydown').on('keydown', function(event) {
                preventInvalidAndLimit(event, /^\d$/, 8, 'dniError', 'El DNI');
                // La validación de longitud se hará después de que el carácter sea añadido,
                // por eso la revisión de 8 dígitos es mejor en 'input' o 'blur'
            }).off('input').on('input', function() {
                // Para manejar el pegado de texto que excede la longitud
                let value = $(this).val();
                if (value.length > 8) {
                    $(this).val(value.substring(0, 8));
                }
                if (value.length > 0 && value.length < 8) {
                    displayError('dniError', "El DNI debe tener 8 dígitos.");
                } else {
                    clearSpecificError('dniError');
                }
            }).off('blur').on('blur', function() { // Revisar al salir del campo
                const value = $(this).val();
                if (value.length > 0 && value.length < 8) {
                    displayError('dniError', "El DNI debe tener 8 dígitos.");
                } else {
                    clearSpecificError('dniError');
                }
            });
        }

        function setupRucInput() {
            $('#ruc').off('keydown').on('keydown', function(event) {
                preventInvalidAndLimit(event, /^\d$/, 11, 'rucError', 'El RUC');
            }).off('input').on('input', function() {
                let value = $(this).val();
                if (value.length > 11) {
                    $(this).val(value.substring(0, 11));
                }
                if (value.length > 0 && value.length < 11) {
                    displayError('rucError', "El RUC debe tener 11 dígitos.");
                } else {
                    clearSpecificError('rucError');
                }
            }).off('blur').on('blur', function() {
                const value = $(this).val();
                if (value.length > 0 && value.length < 11) {
                    displayError('rucError', "El RUC debe tener 11 dígitos.");
                } else {
                    clearSpecificError('rucError');
                }
            });
        }

        function setupTelefonoInput() {
            $('#telefono').off('keydown').on('keydown', function(event) {
                preventInvalidAndLimit(event, /^\d$/, 9, 'telefonoError', 'El teléfono');
            }).off('input').on('input', function() {
                let value = $(this).val();
                if (value.length > 9) {
                    $(this).val(value.substring(0, 9));
                }
                if (value.length > 0 && value.length < 9) {
                    displayError('telefonoError', "El teléfono debe tener 9 dígitos.");
                } else {
                    clearSpecificError('telefonoError');
                }
            }).off('blur').on('blur', function() {
                const value = $(this).val();
                if (value.length > 0 && value.length < 9) {
                    displayError('telefonoError', "El teléfono debe tener 9 dígitos.");
                } else {
                    clearSpecificError('telefonoError');
                }
            });
        }

        // Para nombres y apellidos (letras y espacios, acentos y ñ)
        function setupAlphabeticInput(elementId, errorElementId, fieldName) {
            $('#' + elementId).off('keydown').on('keydown', function(event) {
                // Regex para letras (mayúsculas, minúsculas, acentos, ñ) y espacios
                const regex = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]$/;
                preventInvalidAndLimit(event, regex, null, errorElementId, fieldName); // No hay límite de longitud estricto aquí, el backend debería manejarlo
            }).off('input').on('input', function() {
                // Para limpiar errores al escribir correctamente
                clearSpecificError(errorElementId);
            });
        }

        // Para razón social y nombre comercial (letras, números, espacios, algunos caracteres especiales básicos)
        function setupAlphanumericInput(elementId, errorElementId, fieldName) {
            $('#' + elementId).off('keydown').on('keydown', function(event) {
                // Regex para letras, números, espacios, puntos, comas, guiones, y/o
                const regex = /^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑ\s.,&/-]*$/; // Ampliado para más caracteres comunes en nombres comerciales
                const char = String.fromCharCode(event.which || event.keyCode);

                // Permite backspace, tab, enter, flechas, delete (para edición)
                if (event.which === 8 || event.which === 9 || event.which === 13 || event.which === 37 || event.which === 39 || event.which === 46) {
                    return true;
                }

                // Si el carácter no cumple con la regex, previene su entrada
                if (!regex.test(char)) {
                    event.preventDefault();
                    displayError(errorElementId, `${fieldName} contiene caracteres no permitidos.`);
                    return false;
                }
                clearSpecificError(errorElementId);
                return true;
            }).off('input').on('input', function() {
                clearSpecificError(errorElementId);
            });
        }

        // ===========================================
        // FUNCIONES DE VALIDACIÓN AL ENVIAR EL FORMULARIO (INCLUYEN REQUERIDOS)
        // ===========================================

        function validateRequiredSubmit(inputElementId, errorElementId, fieldName) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            if (value === "") {
                displayError(errorElementId, `${fieldName} es obligatorio.`);
                return false;
            }
            clearSpecificError(errorElementId);
            return true;
        }

        function validateDniSubmit(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^\d{8}$/;

            if (value === "") {
                displayError(errorElementId, "El DNI es obligatorio.");
                return false;
            } else if (!regex.test(value)) {
                displayError(errorElementId, "El DNI debe tener 8 dígitos numéricos.");
                return false;
            }
            clearSpecificError(errorElementId);
            return true;
        }

        function validateRucSubmit(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^\d{11}$/;

            if (value === "") {
                displayError(errorElementId, "El RUC es obligatorio.");
                return false;
            } else if (!regex.test(value)) {
                displayError(errorElementId, "El RUC debe tener 11 dígitos numéricos.");
                return false;
            }
            clearSpecificError(errorElementId);
            return true;
        }

        function validateNombreApellidosSubmit(inputElementId, errorElementId, fieldName) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/;

            if (value === "") {
                displayError(errorElementId, `${fieldName} es obligatorio.`);
                return false;
            } else if (!regex.test(value)) {
                displayError(errorElementId, `${fieldName} solo debe contener letras y espacios.`);
                return false;
            }
            clearSpecificError(errorElementId);
            return true;
        }

        // Se usa para razón social y nombre comercial al enviar
        function validateAlphanumericSubmit(inputElementId, errorElementId, fieldName, isRequired) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            // Regex más permisiva para nombres comerciales y razón social
            const regex = /^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑ\s.,&/-]+$/;

            if (isRequired && value === "") {
                displayError(errorElementId, `${fieldName} es obligatorio.`);
                return false;
            }

            // Si tiene valor (sea requerido o no), validar formato
            if (value !== "" && !regex.test(value)) {
                displayError(errorElementId, `${fieldName} contiene caracteres no permitidos.`);
                return false;
            }
            clearSpecificError(errorElementId);
            return true;
        }


        function validateTelefonoSubmit(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^\d{9}$/;

            if (value === "") {
                // Si es opcional y está vacío, es válido
                clearSpecificError(errorElementId);
                return true;
            } else if (!regex.test(value)) {
                displayError(errorElementId, "El teléfono debe tener 9 dígitos numéricos.");
                return false;
            }
            clearSpecificError(errorElementId);
            return true;
        }


        // Función asíncrona para verificar unicidad de DNI (en el backend)
        async function checkDniUnicoCliente(dniInputId, dniErrorId, idCliente) {
            const dni = $('#' + dniInputId).val();
            if (dni.trim() === "") {
                clearSpecificError(dniErrorId);
                return true;
            }

            let url = '/clientes/checkDni?dni=' + encodeURIComponent(dni);
            if (idCliente) {
                url += '&idCliente=' + idCliente;
            }
            try {
                const response = await $.ajax({ type: "GET", url: url, dataType: "json" });
                if (response.exists) {
                    displayError(dniErrorId, "Este DNI ya está registrado.");
                    $('#' + dniInputId).addClass('is-invalid');
                    return false;
                }
                clearSpecificError(dniErrorId);
                return true;
                } catch (error) {
                console.error("Error al verificar DNI de cliente:", error);
                displayError(dniErrorId, "Error al verificar DNI. Intenta de nuevo.");
                $('#' + dniInputId).addClass('is-invalid');
                return false;
            }
        }

        // Función asíncrona para verificar unicidad de RUC (en el backend)
        async function checkRucUnicoCliente(rucInputId, rucErrorId, idCliente) {
            const ruc = $('#' + rucInputId).val();
            if (ruc.trim() === "") {
                clearSpecificError(rucErrorId);
                return true;
            }

            let url = '/clientes/checkRuc?ruc=' + encodeURIComponent(ruc);
            if (idCliente) {
                url += '&idCliente=' + idCliente;
            }
            try {
                const response = await $.ajax({ type: "GET", url: url, dataType: "json" });
                if (response.exists) {
                    displayError(rucErrorId, "Este RUC ya está registrado.");
                    $('#' + rucInputId).addClass('is-invalid');
                    return false;
                }
                clearSpecificError(rucErrorId);
                return true;
            } catch (error) {
                console.error("Error al verificar RUC de cliente:", error);
                displayError(rucErrorId, "Error al verificar RUC. Intenta de nuevo.");
                $('#' + rucInputId).addClass('is-invalid');
                return false;
            }
        }

        // ===========================================
        // FUNCIÓN PRINCIPAL DE VALIDACIÓN DEL FORMULARIO DE CLIENTE AL ENVIAR
        // ===========================================

        async function validarFormularioCliente() {
            clearErrors("#formCliente"); // Limpiar errores antes de la validación final

            let isValid = true;
            const idTipoCliente = parseInt($('#idTipoCliente').val(), 10);
            const idCliente = $('#idCliente').val();

            // Validaciones comunes
            if (!validateRequiredSubmit('idTipoCliente', 'tipoClienteError', 'El tipo de cliente')) isValid = false;
            if (!validateRequiredSubmit('direccion', 'direccionError', 'La dirección')) isValid = false;
            if (!validateTelefonoSubmit('telefono', 'telefonoError')) isValid = false; // Teléfono es opcional, pero si tiene valor, debe ser de 9 dígitos.
            if (!validateRequiredSubmit('estado', 'estadoError', 'El estado')) isValid = false;

            // Validaciones específicas según el tipo de cliente
            if (idTipoCliente === 1) { // Persona Natural
                if (!validateDniSubmit('dni', 'dniError')) isValid = false;
                if (!validateNombreApellidosSubmit('nombre', 'nombreError', 'El nombre')) isValid = false;
                if (!validateNombreApellidosSubmit('apPaterno', 'apPaternoError', 'El apellido paterno')) isValid = false;
                // apMaterno es opcional, no se valida como requerido en submit, pero si tiene valor, validar formato
                if ($('#apMaterno').val().trim() !== '' && !validateAlphanumericSubmit('apMaterno', 'apMaternoError', 'El apellido materno', false)) isValid = false;


                // Unicidad de DNI
                const dniUnico = await checkDniUnicoCliente('dni', 'dniError', idCliente ? parseInt(idCliente) : null);
                if (!dniUnico) isValid = false;

            } else if (idTipoCliente === 2) { // Persona Jurídica
                if (!validateRucSubmit('ruc', 'rucError')) isValid = false;
                if (!validateAlphanumericSubmit('razonSocial', 'razonSocialError', 'La razón social', true)) isValid = false;
                // nombreComercial es opcional, no se valida como requerido en submit, pero si tiene valor, validar formato
                if ($('#nombreComercial').val().trim() !== '' && !validateAlphanumericSubmit('nombreComercial', 'nombreComercialError', 'El nombre comercial', false)) isValid = false;


                // Unicidad de RUC
                const rucUnico = await checkRucUnicoCliente('ruc', 'rucError', idCliente ? parseInt(idCliente) : null);
                if (!rucUnico) isValid = false;
            }

            return isValid;
        }

        // Función para alternar campos visibles según el tipo de cliente
        function toggleClientFields() {
            const tipoCliente = parseInt($('#idTipoCliente').val(), 10);
            clearErrors("#formCliente");// Limpiar errores al cambiar el tipo de cliente

            if (tipoCliente === 1) { // Persona Natural
                $('#naturalFields').show();
                $('#juridicaFields').hide();
                // Limpiar campos de jurídica si se cambia desde allí
                $('#ruc').val('');
                $('#razonSocial').val('');
                $('#nombreComercial').val('');
            } else if (tipoCliente === 2) { // Persona Jurídica
                $('#naturalFields').hide();
                $('#juridicaFields').show();
                // Limpiar campos de natural si se cambia desde allí
                $('#dni').val('');
                $('#nombre').val('');
                $('#apPaterno').val('');
                $('#apMaterno').val('');
            } else { // Si no se ha seleccionado nada o es inválido
                $('#naturalFields').hide();
                $('#juridicaFields').hide();
                // Limpiar todos los campos de cliente si no hay tipo seleccionado
                $('#dni').val('');
                $('#nombre').val('');
                $('#apPaterno').val('');
                $('#apMaterno').val('');
                $('#ruc').val('');
                $('#razonSocial').val('');
                $('#nombreComercial').val('');
            }

            // Adjuntar los escuchadores de validación en tiempo real después de alternar los campos
            attachRealTimeValidationListeners();
        }

        // Función para adjuntar todos los escuchadores de validación en tiempo real
        function attachRealTimeValidationListeners() {
            // Campos numéricos
            setupDniInput();
            setupRucInput();
            setupTelefonoInput();

            // Campos alfabéticos
            setupAlphabeticInput('nombre', 'nombreError', 'El nombre');
            setupAlphabeticInput('apPaterno', 'apPaternoError', 'El apellido paterno');
            setupAlphabeticInput('apMaterno', 'apMaternoError', 'El apellido materno');

            // Campos alfanuméricos (para Razón Social y Nombre Comercial)
            setupAlphanumericInput('razonSocial', 'razonSocialError', 'La razón social');
            setupAlphanumericInput('nombreComercial', 'nombreComercialError', 'El nombre comercial');

            // Dirección (puede tener letras, números, espacios, puntos, comas, etc.)
            setupAlphanumericInput('direccion', 'direccionError', 'La dirección');
        }


        // ===========================================
        // MANEJADORES DE EVENTOS DEL MODAL Y FORMULARIO DE CLIENTE
        // ===========================================

        function abrirFormularioCliente(url) {
          console.log("Intentando abrir formulario de Cliente desde URL:", url);

          // Cargo el formulario en el modal
          $('#modalFormContentCliente').load(url, function(response, status, xhr) {
            if (status === "error") {
              console.error("Error al cargar el formulario de Cliente:", xhr.status, xhr.statusText, response);
              Swal.fire({
                icon: 'error',
                title: 'Error al cargar formulario',
                text: 'Hubo un problema al cargar el formulario. Por favor, inténtalo de nuevo.',
                footer: `Detalles: ${xhr.status} ${xhr.statusText}`
              });
              return;
            }

            console.log("Formulario de Cliente cargado exitosamente.");

            // 1) Limpio SOLO los errores de este formulario
            clearErrors('#formCliente');

            // 2) Inicializo el toggle de campos según tipo de cliente
            $('#idTipoCliente')
              .off('change')
              .on('change', toggleClientFields);
            // Ejecutarlo una vez para el estado inicial
            toggleClientFields();

            // 3) Preparo el submit
            $('#formCliente').off('submit').on('submit', async function(e) {
              e.preventDefault();
              const formIsValid = await validarFormularioCliente();
              if (formIsValid) {
                guardarClienteAjax();
              } else {
                console.log("Formulario de Cliente inválido. No se envía.");
                mostrarNotificacion("error", "Por favor, corrige los errores en el formulario.");
              }
            });

            // 4) Muestro el modal
            $('#clienteModal').modal('show');
            console.log("Modal de Cliente intentando mostrarse.");
          });
        }


        function cerrarFormularioCliente() {
            $('#clienteModal').modal('hide');
            setTimeout(function() {
                $('#modalFormContentCliente').empty();
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open');
            }, 300);
            clearErrors("#formCliente");
            console.log("Modal de Cliente cerrado.");
        }

        // Función para guardar/actualizar cliente con AJAX
        function guardarClienteAjax() {
            const idCliente = $('#idCliente').val();
            const idTipoCliente = parseInt($('#idTipoCliente').val(), 10);
            const tipoClienteObj = { idRolCliente: idTipoCliente };

            const dataToSend = {
                idCliente: idCliente === '' ? null : parseInt(idCliente, 10),
                fechaRegistro: $('#fechaRegistro').val(),
                tipoCliente: tipoClienteObj,
                direccion: $('#direccion').val(),
                telefono: $('#telefono').val(),
                estado: parseInt($('#estado').val(), 10)
            };

            // Añadir campos específicos según el tipo de cliente
            if (idTipoCliente === 1) { // Persona Natural
                dataToSend.dni = $('#dni').val();
                dataToSend.nombre = $('#nombre').val();
                dataToSend.apPaterno = $('#apPaterno').val();
                dataToSend.apMaterno = $('#apMaterno').val().trim() === '' ? null : $('#apMaterno').val(); // Ajuste para enviar null si está vacío
            } else if (idTipoCliente === 2) { // Persona Jurídica
                dataToSend.ruc = $('#ruc').val();
                dataToSend.razonSocial = $('#razonSocial').val();
                dataToSend.nombreComercial = $('#nombreComercial').val().trim() === '' ? null : $('#nombreComercial').val(); // Ajuste para enviar null si está vacío
            }

            const url = '/clientes/guardar';

            $.ajax({
                type: "POST",
                url: url,
                contentType: 'application/json',
                data: JSON.stringify(dataToSend),
                success: function(response) {
                    if (response.status === "success") {
                        mostrarNotificacion("success", response.message);
                        cerrarFormularioCliente();
                        aplicarFiltrosCliente(); // Llama a la nueva función de recarga con filtros
                    } else {
                        if (response.errors) {
                            response.errors.forEach(err => {
                                displayError(err.field + 'Error', err.defaultMessage);
                            });
                        }
                        mostrarNotificacion("error", "Error: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = "Error al procesar la solicitud.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ": " + xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        errorMessage += ": " + xhr.responseText.substring(0, Math.min(xhr.responseText.length, 100)) + "...";
                    }
                    mostrarNotificacion("error", errorMessage);
                    console.error("Error AJAX al guardar Cliente:", error, xhr.responseText, xhr);
                }
            });
        }

       function confirmarEliminarCliente(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡El cliente será marcado como inactivo!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log("Eliminando Cliente con ID:", id);
                    $.ajax({
                        type: "GET",
                        url: '/clientes/eliminar/' + id,
                        success: function(response) {
                            if (response.status === "success") {
                                mostrarNotificacion("success", response.message);
                                recargarListaClientesCompleta();
                            } else {
                                mostrarNotificacion("error", "Error: " + response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            let errorMessage = "Error al eliminar el Cliente.";
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ": " + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ": " + xhr.responseText.substring(0, Math.min(xhr.responseText.length, 100)) + "...";
                            }
                            mostrarNotificacion("error", errorMessage);
                            console.error("Error AJAX al eliminar Cliente:", error, xhr.responseText);
                        }
                    });
                }
            });
        }
        function recargarListaClientesCompleta() {
            const idTipoCliente = $('#filterTipoCliente').val();
            const searchTerm = $('#searchTermCliente').val();

            let url = '/clientes/all?';
            const params = [];
            if (idTipoCliente) {
                params.push('idTipoCliente=' + encodeURIComponent(idTipoCliente));
            }
            if (searchTerm) {
                params.push('searchTerm=' + encodeURIComponent(searchTerm));
            }
            url += params.join('&');

            $.ajax({
                type: "GET",
                url: url,
                dataType: "json",
                success: function(response) {
                    allClientes = response;
                    renderizarTablaCliente(allClientes);
                },
                error: function(xhr, status, error) {
                    console.error("Error al recargar la lista completa de Clientes:", error);
                    mostrarNotificacion("error", "Error al recargar la lista de Clientes. Verifica el endpoint /clientes/all en tu backend.");
                }
            });
        }
        // ===========================================
        // FUNCIONES DE FILTRADO Y REPORTE DE CLIENTES (SERVER-SIDE) - NUEVO ENFOQUE
        // ===========================================

        function aplicarFiltrosCliente() {
            const filterDTO = {
                nombreCompletoODoc: $('#searchTermClienteMain').val(),
                idTipoCliente: $('#filtroTipoClienteMain').val() === "" ? null : parseInt($('#filtroTipoClienteMain').val()),
                direccion: $('#filtroDireccionClienteMain').val(),
                telefono: $('#filtroTelefonoClienteMain').val(),
                estado: $('#filtroEstadoClienteReporteMain').val() === "" ? null : parseInt($('#filtroEstadoClienteReporteMain').val()),
                fechaRegistroStart: $('#fechaRegistroClienteStartMain').val() === "" ? null : $('#fechaRegistroClienteStartMain').val(),
                fechaRegistroEnd: $('#fechaRegistroClienteEndMain').val() === "" ? null : $('#fechaRegistroClienteEndMain').val()
            };

            const queryString = $.param(filterDTO);
            // Usamos el nuevo endpoint /clientes/buscar
            const url = '/clientes/buscar?' + queryString;

            $.ajax({
                type: "GET",
                url: url,
                dataType: "json",
                success: function(response) {
                    renderizarTablaCliente(response);
                },
                error: function(xhr, status, error) {
                    console.error("Error al buscar clientes con filtros:", error, xhr.responseText);
                    mostrarNotificacion("error", "Error al buscar clientes. Intenta de nuevo.");
                }
            });
        }

        function ejecutarGenerarReporteClientes() {
            Swal.fire({
                title: 'Generando Reporte...',
                text: 'Por favor, espera mientras se genera el PDF.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Recoger todos los valores de los campos de filtro del formulario principal
            const filterDTO = {
                nombreCompletoODoc: $('#searchTermClienteMain').val(),
                idTipoCliente: $('#filtroTipoClienteMain').val() === "" ? null : parseInt($('#filtroTipoClienteMain').val()),
                direccion: $('#filtroDireccionClienteMain').val(),
                telefono: $('#filtroTelefonoClienteMain').val(),
                estado: $('#filtroEstadoClienteReporteMain').val() === "" ? null : parseInt($('#filtroEstadoClienteReporteMain').val()),
                fechaRegistroStart: $('#fechaRegistroClienteStartMain').val() === "" ? null : $('#fechaRegistroClienteStartMain').val(),
                fechaRegistroEnd: $('#fechaRegistroClienteEndMain').val() === "" ? null : $('#fechaRegistroClienteEndMain').val()
            };

            const queryString = $.param(filterDTO);
            const url = '/clientes/reporte/pdf?' + queryString;

            setTimeout(() => {
                const newWindow = window.open(url, '_blank');
                if (newWindow) {
                    Swal.close();
                    mostrarNotificacion("success", "El reporte PDF de clientes se está generando y debería abrirse en una nueva ventana.");
                } else {
                    Swal.close();
                    mostrarNotificacion("error", "Error: Tu navegador bloqueó la apertura de la nueva ventana. Por favor, permite los pop-ups para este sitio.");
                }
            }, 300);
        }

        function limpiarFiltrosMainCliente() {
            $('#mainClientFilterForm')[0].reset(); // Resetea todos los campos del formulario
            // Para Select2 si lo estuvieras usando en los filtros de la tabla
            // $('#filtroTipoClienteMain').val('').trigger('change');
            setMainDateMaxAttributesCliente(); // Restablecer límites de fecha
            setMainDateMinAttributesCliente();
            aplicarFiltrosCliente(); // Vuelve a cargar la tabla sin filtros
        }


        // Funciones para ajustar fechas (renombradas para ser específicas de clientes y de la página principal)
        function setMainDateMaxAttributesCliente() {
            const today = new Date().toISOString().split('T')[0];
            $('#fechaRegistroClienteStartMain').attr('max', today);

            const fechaFin = $('#fechaRegistroClienteEndMain').val();
            if (fechaFin && $('#fechaRegistroClienteStartMain').val() && new Date(fechaFin) < new Date($('#fechaRegistroClienteStartMain').val())) {
                $('#fechaRegistroClienteEndMain').val($('#fechaRegistroClienteStartMain').val());
            }
            $('#fechaRegistroClienteEndMain').attr('min', $('#fechaRegistroClienteStartMain').val());
        }

        function setMainDateMinAttributesCliente() {
            const today = new Date().toISOString().split('T')[0];
            $('#fechaRegistroClienteEndMain').attr('max', today);

            const fechaInicio = $('#fechaRegistroClienteStartMain').val();
            if (fechaInicio && $('#fechaRegistroClienteEndMain').val() && new Date(fechaInicio) > new Date($('#fechaRegistroClienteEndMain').val())) {
                $('#fechaRegistroClienteStartMain').val($('#fechaRegistroClienteEndMain').val());
            }
            $('#fechaRegistroClienteStartMain').attr('max', $('#fechaRegistroClienteEndMain').val() || today);
        }

        function mostrarNotificacion(type, message) {
            $(document).Toasts('create', {
                class: type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-info' : 'bg-danger'),
                title: type === 'success' ? 'Éxito' : (type === 'info' ? 'Información' : 'Error'),
                body: message,
                autohide: true,
                delay: 3000
            });
        }
        // ===========================================
// FUNCIONES PARA AUTOCONPLETAR CON API RENIEC/SUNAT
// ===========================================

/**
 * Busca datos de DNI o RUC usando la API externa y autocompleta el formulario.
 * Se llama al perder el foco del campo (onblur) o al hacer clic en el botón "Buscar".
 * @param {string} triggerType 'dni' o 'ruc' para indicar qué botón o campo lo disparó.
 */
async function buscarDatosDniRuc(triggerType) {
    const idTipoCliente = parseInt($('#idTipoCliente').val(), 10);
    let numeroDocumento;
    let tipoDocumentoApi;
    let inputFieldId;
    let errorFieldId;

    if (idTipoCliente === 1) { // Persona Natural - DNI
        numeroDocumento = $('#dni').val().trim();
        tipoDocumentoApi = 'dni';
        inputFieldId = 'dni';
        errorFieldId = 'dniError';
        // Solo buscar si el DNI tiene 8 dígitos y es numérico
        if (numeroDocumento.length !== 8 || !/^\d+$/.test(numeroDocumento)) {
            displayError(errorFieldId, "El DNI debe tener 8 dígitos numéricos para buscar.");
            return;
        }
    } else if (idTipoCliente === 2) { // Persona Jurídica - RUC
        numeroDocumento = $('#ruc').val().trim();
        tipoDocumentoApi = 'ruc';
        inputFieldId = 'ruc';
        errorFieldId = 'rucError';
        // Solo buscar si el RUC tiene 11 dígitos y es numérico
        if (numeroDocumento.length !== 11 || !/^\d+$/.test(numeroDocumento)) {
            displayError(errorFieldId, "El RUC debe tener 11 dígitos numéricos para buscar.");
            return;
        }
    } else {
        // No hay tipo de cliente seleccionado, no se puede buscar por documento
        return;
    }

    // Limpiar errores previos del campo de documento
    clearSpecificError(errorFieldId);

    // Evitar múltiples llamadas si el campo está vacío o no es válido para búsqueda
    if (!numeroDocumento) {
        return;
    }

    // Mostrar indicador de carga y deshabilitar botón
    const btnToDisable = triggerType === 'dni' ? $('#btnBuscarDni') : $('#btnBuscarRuc');
    btnToDisable.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Buscando...').prop('disabled', true);
    $('#' + inputFieldId).prop('disabled', true); // Deshabilitar el input mientras busca

    try {
        const response = await $.ajax({
            type: "GET",
            url: `/clientes/buscarPorDocumento?tipoDocumento=${tipoDocumentoApi}&numeroDocumento=${numeroDocumento}`,
            dataType: "json"
        });

        if (response) {
            mostrarNotificacion("success", `Datos de ${tipoDocumentoApi.toUpperCase()} encontrados.`);
            if (tipoDocumentoApi === 'dni') {
                $('#nombre').val(response.nombres || '');
                $('#apPaterno').val(response.apellidoPaterno || '');
                $('#apMaterno').val(response.apellidoMaterno || '');
                // La dirección a menudo no viene de RENIEC en APIs gratuitas.
                // Si tu API la da, puedes autocompletarla:
                // $('#direccion').val(response.direccion || $('#direccion').val());
            } else if (tipoDocumentoApi === 'ruc') {
                $('#razonSocial').val(response.razonSocial || '');
                $('#nombreComercial').val(response.nombreComercial || '');
                // Si tu API de SUNAT da la dirección:
                $('#direccion').val(response.direccion || $('#direccion').val());
            }
        } else {
            // Esto no debería ejecutarse si el backend ya maneja el 404
            mostrarNotificacion("info", `No se encontraron datos para el ${tipoDocumentoApi.toUpperCase()} proporcionado.`);
        }
    } catch (xhr) {
        let errorMessage = `Error al buscar datos de ${tipoDocumentoApi.toUpperCase()}.`;
        if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
        } else if (xhr.status === 404) {
            errorMessage = `${tipoDocumentoApi.toUpperCase()} no encontrado o no existe.`;
        } else if (xhr.status === 429) { // Too Many Requests - Límite de API
            errorMessage = `Se excedió el límite de consultas a la API. Intente más tarde o ingrese los datos manualmente.`;
        } else if (xhr.status === 400) { // Bad Request
            errorMessage = `${tipoDocumentoApi.toUpperCase()} inválido o formato incorrecto.`;
        } else {
            errorMessage += " Por favor, intente de nuevo o ingrese los datos manualmente.";
        }
        displayError(errorFieldId, errorMessage);
        mostrarNotificacion("error", errorMessage);
        console.error(`Error AJAX al buscar datos de ${tipoDocumentoApi.toUpperCase()}:`, xhr);
    } finally {
        // Habilitar el botón y el input de nuevo
        btnToDisable.html('<i class="fas fa-search"></i> Buscar').prop('disabled', false);
        $('#' + inputFieldId).prop('disabled', false);
    }
}
        $(document).ready(function() {
            // Inicializa los atributos max/min para las fechas de filtro
            setMainDateMaxAttributesCliente();
            setMainDateMinAttributesCliente();
            // Carga la tabla de clientes con los filtros iniciales (probablemente vacíos)
            aplicarFiltrosCliente();
        });

        /*]]>*/
    </script>
</th:block>
</html>
