<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title layout:fragment="title">Gestión de Documentos de Compra</title>
    <th:block layout:fragment="styles">
        <style>
            /* Estilos generales para los modales Bootstrap/AdminLTE */
            .modal-xl {
                max-width: 900px; /* Asegura un ancho más grande para el modal de compra */
            }
            .bg-light {
                background-color: #f8f9fa !important; /* Color para campos readonly */
            }
            /* NUEVO ESTILO PARA FILAS DE DOCUMENTOS INACTIVOS/CANCELADOS (similar a venta.html) */
            .cancelled-item { /* Renombrado para consistencia con 'venta.html' si lo deseas, o usa table-danger-custom */
                background-color: #f8d7da !important; /* Rojo claro para indicar cancelación */
                color: #721c24 !important; /* Texto oscuro para contraste */
            }
            .cancelled-item a, .cancelled-item button {
                color: #721c24 !important; /* Asegura que los enlaces y botones también se vean afectados */
            }
            /* Asegurarse de que el color de los iconos también se vea afectado */
            .cancelled-item .fas {
                color: #721c24 !important;
            }

        </style>
    </th:block>
</head>

<section layout:fragment="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Documentos de Compra</h3>
                        <div class="card-tools">
                            <button type="button" onclick="openFormModal(null)"
                                    class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                                <i class="fas fa-plus"></i> Registrar Nueva Compra
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="card card-primary card-outline collapsed-card"> <div class="card-header">
                            <h3 class="card-title">
                                <a href="#collapseFiltrosCompra" data-toggle="collapse" role="button" aria-expanded="false" aria-controls="collapseFiltrosCompra" class="d-block text-dark">
                                    <i class="fas fa-filter"></i> Mostrar/Ocultar Filtros
                                </a>
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-plus"></i> </button>
                            </div>
                        </div>
                            <div class="card-body" id="collapseFiltrosCompra"> <form id="documentoCompraFilterForm">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="filtroNumDocumentoCompra">N° Documento:</label>
                                            <input type="text" class="form-control" id="filtroNumDocumentoCompra" name="numDocumento" placeholder="Número de documento">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="filtroProveedorCompra">Proveedor:</label>
                                            <select class="form-control select2" id="filtroProveedorCompra" name="idProveedor" style="width: 100%;">
                                                <option value="">Todos los Proveedores</option>
                                                <option th:each="prov : ${proveedores}"
                                                        th:value="${prov.idProveedor}"
                                                        th:text="${prov.razonSocial}">
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Estados:</label><br>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input estado-checkbox-compra" type="checkbox" id="estadoCompraActiva" name="estados" value="1">
                                                <label class="form-check-label" for="estadoCompraActiva">Activa</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input estado-checkbox-compra" type="checkbox" id="estadoCompraCancelada" name="estados" value="0">
                                                <label class="form-check-label" for="estadoCompraCancelada">Anulada</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-12 text-right">
                                        <button type="button" class="btn btn-info" onclick="aplicarFiltrosTablaDocumentosCompra()">
                                            <i class="fas fa-filter"></i> Filtrar Tabla
                                        </button>
                                        <button type="button" class="btn btn-secondary ml-2" onclick="limpiarFiltrosTablaDocumentoCompra()">
                                            <i class="fas fa-redo"></i> Limpiar Filtros
                                        </button>
                                        <button type="button" class="btn btn-info ml-2" onclick="generarReportePDFDocumentoCompra()" style="background-color:#b45f06 !important; border-color:#b45f06 !important;">
                                            <i class="fas fa-file-alt"></i> Generar Reporte
                                        </button>
                                    </div>
                                </div>
                            </form>
                            </div>
                        </div>
                        <div id="tablaDocumentosCompraContainer" class="table-responsive">
                            <table id="documentosCompraTable" class="table table-bordered table-striped">
                                <thead>
                                <tr>
                                    <th>ID Compra</th>
                                    <th>Fecha Registro</th>
                                    <th>Proveedor</th>
                                    <th>Tipo Doc.</th>
                                    <th>N° Documento</th>
                                    <th>Total</th>
                                    <th>Estado</th> <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody id="documentosCompraTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="documentoCompraModal" tabindex="-1" role="dialog" aria-labelledby="documentoCompraModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content" id="modalFormContent">
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewDocumentoCompraModal" tabindex="-1" role="dialog" aria-labelledby="viewDocumentoCompraModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" id="modalViewContent">
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirmar Anulación de Compra</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeDeleteConfirmModal()">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres **anular** este documento de compra?</p>
                    <p class="text-danger small">Esta acción revertirá el stock de los productos y no se puede deshacer.</p>
                    <div class="form-group mt-3">
                        <label for="adminPasswordInput">Contraseña del Administrador:</label>
                        <input type="password" class="form-control" id="adminPasswordInput" placeholder="Ingrese su contraseña de administrador" required>
                        <small id="adminPasswordError" class="text-danger"></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closeDeleteConfirmModal()">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">Confirmar Anulación</button>
                </div>
            </div>
        </div>
    </div>
</section>
<th:block layout:fragment="scripts">
    <script src="/plugins/jquery/jquery.min.js"></script>
    <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">

        /*<![CDATA[*/

            // Variables globales para los datos iniciales y el contador de detalles
            allDocumentosCompra = []; // Inicializar como array vacío, siempre se cargará por AJAX
            allProductosData = []; // Ahora se carga por AJAX en openFormModal
            allProveedoresData = /*[[${proveedores}]]*/ []; // Pasados desde el controlador

            // Elementos del DOM del modal principal
            const documentoCompraModalElement = $('#documentoCompraModal'); // Usando jQuery para el modal Bootstrap
            const viewDocumentoCompraModalElement = $('#viewDocumentoCompraModal'); // Nuevo modal para visualizar
            const deleteConfirmModalElement = $('#deleteConfirmModal'); // Usando jQuery
            const modalFormContent = document.getElementById('modalFormContent');
            const modalViewContent = document.getElementById('modalViewContent'); // Contenido para el modal de visualización

            let detalleCount = 0; // Contador para generar IDs únicos para los detalles
            let documentIdToCancel = null; // RENOMBRADO: ID del documento a ANULAR

            // Obtener la fecha de hoy para comparaciones
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Establecer a la medianoche para comparación de fechas


            // ===============================================
            // FUNCIONES DE UTILIDAD (NOTIFICACIONES, ERRORES)
            // ===============================================

            function showNotification(type, message) {
                Swal.fire({
                    icon: type, // 'success', 'error', 'warning', 'info', 'question'
                    title: type.charAt(0).toUpperCase() + type.slice(1), // Capitalizar el tipo
                    text: message,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    customClass: {
                        container: 'swal2-container-custom' // Para posibles estilos CSS personalizados si se requieren
                    }
                });
            }

            function clearErrors() {
                // Solo buscar errores dentro del modal activo para evitar limpiar la tabla principal
                const currentForm = document.getElementById('documentoCompraForm');
                if (currentForm) {
                    currentForm.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
                    currentForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                }
            }

            function displayError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                if (errorElement) {
                    errorElement.textContent = message;
                    let inputElement = null;
                    // Buscar el input o select asociado, ya sea hermano anterior o dentro del mismo form-group
                    if (errorElement.previousElementSibling &&
                       (errorElement.previousElementSibling.tagName === 'INPUT' ||
                        errorElement.previousElementSibling.tagName === 'SELECT')) {
                        inputElement = errorElement.previousElementSibling;
                    } else {
                        const parentDiv = errorElement.closest('.form-group'); // Buscar el contenedor de form-group
                        if (parentDiv) {
                            inputElement = parentDiv.querySelector('input, select');
                        }
                    }

                    if (inputElement) {
                        inputElement.classList.add('is-invalid');
                    }
                }
            }

            // ===============================================
            // LÓGICA DE LA TABLA PRINCIPAL
            // ===============================================

            // (Esta función es principalmente para la carga inicial y recargas)
            function renderDocumentosCompraTable(documentsToDisplay) {
                const tableBody = document.getElementById('documentosCompraTableBody');
                if (!tableBody) { // Agrega esta validación por si acaso
                    console.error("Error: Elemento 'documentosCompraTableBody' no encontrado.");
                    return;
                }
                tableBody.innerHTML = ''; // Limpiar la tabla

                if (documentsToDisplay.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay documentos de compra registrados.</td></tr>'; // Actualizado a colspan 8
                    return;
                }

                documentsToDisplay.forEach(doc => {
                    const row = document.createElement('tr');

                    // --- INICIO DE LA CORRECCIÓN DE FECHA ---
                    let fechaFormatted = 'N/A';
                    let docDateForComparison; // Variable para la comparación de la fecha de anulación

                    if (doc.fechaRegistro) {
                        // Divide la cadena "YYYY-MM-DD" en componentes
                        const dateParts = doc.fechaRegistro.split('-'); // ["YYYY", "MM", "DD"]
                        const year = parseInt(dateParts[0]);
                        // Los meses en JavaScript son 0-indexados (0 para Enero, 11 para Diciembre)
                        const month = parseInt(dateParts[1]) - 1;
                        const day = parseInt(dateParts[2]);

                        // Crea un objeto Date en el huso horario local
                        const localDate = new Date(year, month, day);
                        fechaFormatted = localDate.toLocaleDateString('es-ES');

                        // También para la comparación: asegúrate de que sea la fecha correcta
                        docDateForComparison = new Date(year, month, day);
                        docDateForComparison.setHours(0, 0, 0, 0); // Limpiar la hora para la comparación
                    } else {
                        docDateForComparison = new Date(0); // Fecha por defecto si no hay fecha de registro (ej: 1970-01-01)
                    }
                    // --- FIN DE LA CORRECCIÓN DE FECHA ---

                    // *** CAMBIO CLAVE AQUÍ: Agregar clase condicionalmente basada en el estado ***
                    const rowClass = (doc.estado !== null && doc.estado === 0) ? 'cancelled-item' : ''; // Usar 'cancelled-item'
                    if (rowClass) {
                        row.classList.add(rowClass); // Aplica la clase si el estado es 0
                    }

                    // Lógica para el estado visual en la tabla
                    let estadoHtml = '';
                    if (doc.estado === 1) {
                        estadoHtml = '<span class="badge badge-success">Activo</span>';
                    } else if (doc.estado === 0) {
                        estadoHtml = '<span class="badge badge-danger">Anulado</span>';
                        if (doc.usuarioAnulacion && doc.fechaAnulacion) {
                            const anulacionDate = new Date(doc.fechaAnulacion);
                            const formattedAnulacionDate = anulacionDate.toLocaleDateString('es-ES', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            estadoHtml += `<br><small>Por: ${doc.usuarioAnulacion.nombre} ${doc.usuarioAnulacion.apPaterno} el ${formattedAnulacionDate}</small>`;
                        }
                    } else {
                        estadoHtml = '<span class="badge badge-secondary">Desconocido</span>';
                    }

                    // Lógica condicional para los botones de acción
                    let actionButtonsHtml = '';
                    const isCancelled = (doc.estado !== null && doc.estado === 0);
                    // La anulación solo se permite si NO está cancelado Y es del día actual
                    const isCancellableToday = !isCancelled && (docDateForComparison.getTime() === today.getTime()); // Usar docDateForComparison

                    actionButtonsHtml = `
                        <button type="button" onclick="openViewModal(${doc.idCompra})"
                                class="btn btn-info btn-sm">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm ml-1 ${!isCancellableToday ? 'disabled' : ''}" ${!isCancellableToday ? 'disabled' : ''} onclick="confirmCancelCompra(${doc.idCompra})">
                            <i class="fas fa-ban"></i> </button>
                    `;

                    row.innerHTML = `
                        <td>${doc.idCompra}</td>
                        <td>${fechaFormatted}</td>
                        <td>${doc.proveedor ? doc.proveedor.razonSocial : 'N/A'}</td>
                        <td>${doc.tipoDocumento}</td>
                        <td>${doc.numDocumento}</td>
                        <td>S/ ${parseFloat(doc.total).toFixed(2)}</td>
                        <td>${estadoHtml}</td> <td>
                            <div class="btn-group">
                                ${actionButtonsHtml}
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            // Función para recargar la lista de documentos de compra (llamada después de CRUD)
            window.recargarListaDocumentosCompraCompleta = function() { // Hacer global
                fetch('/documento-compra/all')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok for /documento-compra/all');
                        }
                        return response.json();
                    })
                    .then(data => {
                        allDocumentosCompra = data; // Actualizar la variable global
                        renderDocumentosCompraTable(allDocumentosCompra); // Volver a renderizar la tabla
                    })
                    .catch(error => {
                        console.error('Error al recargar la lista de documentos de compra:', error);
                        showNotification('error', 'Error al recargar la lista de documentos de compra.');
                    });
            }

          // Referencia al formulario de filtros de DocumentoCompra
const documentoCompraFilterForm = document.getElementById('documentoCompraFilterForm'); // ¡Asegúrate de que este ID exista en tu HTML!


// 1. Función para recolectar los parámetros de filtro de DocumentoCompra
function getDocumentoCompraFilterParams() {
    const form = documentoCompraFilterForm;
    const formData = new FormData(form);
    const params = new URLSearchParams();

    // Especialmente importante para los checkboxes de estado
    const checkedStates = Array.from(form.querySelectorAll('.estado-checkbox-compra:checked')).map(cb => cb.value);
    if (checkedStates.length > 0) {
        checkedStates.forEach(state => params.append('estados', state));
    }
    // Si no hay checkboxes marcados, 'estados' NO se añadirá a 'params',
    // lo que permite al backend mostrar todos los estados por defecto.

    // Recoger los demás campos del formulario
    for (const [key, value] of formData.entries()) {
        if (key === 'idProveedor' && value === '') {
            // No añadir idProveedor si está vacío (para que el backend no filtre por null/0)
            continue;
        }
        if (key === 'numDocumento' && !value.trim()) {
            // No añadir numDocumento si está vacío o solo espacios
            continue;
        }
        // Excluir 'estados' ya que lo manejamos manualmente arriba
        if (key !== 'estados') {
             // Asegurarse de que no se envíen parámetros vacíos para campos de texto
            if (typeof value === 'string' && value.trim() === '') {
                continue;
            }
            params.append(key, value);
        }
    }
    return params.toString();
}

// 2. Función para aplicar los filtros de DocumentoCompra a la tabla
window.aplicarFiltrosTablaDocumentosCompra = function() {
    const filterParams = getDocumentoCompraFilterParams();
    console.log("Aplicando filtros de Documento Compra:", filterParams); // DEBUG

    Swal.fire({
        title: 'Cargando Documentos de Compra...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    fetch(`/documento-compra/buscar?${filterParams}`) // Llama al nuevo endpoint
        .then(response => {
            if (!response.ok) {
                // Si la respuesta no es OK (ej. 500 Internal Server Error), intenta leer el mensaje de error del cuerpo
                return response.json().then(err => { throw new Error(err.message || 'Error desconocido al filtrar documentos de compra'); });
            }
            return response.json();
        })
        .then(data => {
            allDocumentosCompra = data; // Actualizar la variable global
            renderDocumentosCompraTable(allDocumentosCompra); // Renderizar la tabla con los datos filtrados

            Swal.close();
            showNotification('success', 'Documentos de Compra filtrados exitosamente.');
        })
        .catch(error => {
            console.error("Error al filtrar documentos de compra:", error);
            Swal.close();
            showNotification('error', 'Error al filtrar documentos de compra: ' + error.message);
        });
}

// 3. Función para limpiar los filtros de DocumentoCompra
window.limpiarFiltrosTablaDocumentoCompra = function() {
    documentoCompraFilterForm.reset(); // Reinicia el formulario HTML
    // Si usas Select2, necesitas reiniciarlo manualmente
    $('#filtroProveedorCompra').val('').trigger('change');

    // Desmarcar los checkboxes de estado
    $('.estado-checkbox-compra').prop('checked', false);

    // Si tienes campos de fecha en el filtro, asegúrate de limpiarlos también
    // Ejemplo: $('#fechaRegistroStartFilter').val('');

    aplicarFiltrosTablaDocumentosCompra(); // Aplicar los filtros limpios para recargar la tabla
}


/**
 * Genera el reporte PDF de documentos de compra utilizando los filtros actualmente aplicados en la tabla.
 */
window.generarReportePDFDocumentoCompra = function() {
    const filterParams = getDocumentoCompraFilterParams(); // Reutiliza la función para obtener los filtros de la tabla

    Swal.fire({
        title: 'Generando Reporte...',
        text: 'Por favor, espera mientras se genera el PDF de documentos de compra.',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    // Construye la URL del PDF con los filtros de la tabla
    const url = '/documento-compra/reporte/pdf?' + filterParams;

    // Pequeño retardo para asegurar que el SweetAlert se muestre
    setTimeout(() => {
        const newWindow = window.open(url, '_blank');
        if (newWindow) {
            Swal.close();
            showNotification("success", "El reporte PDF se está generando y debería abrirse en una nueva pestaña.");
        } else {
            Swal.close();
            showNotification("error", "Error: Tu navegador bloqueó la descarga del PDF. Por favor, permite los pop-ups para este sitio.");
        }
    }, 300);
}


            // ===============================================
            // LÓGICA DEL FORMULARIO MODAL (PARA DOCUMENTO DE COMPRA)
            // ===============================================

            function openFormModal(idCompra) {
                // Este modal ahora solo se usará para 'Registrar Nueva Compra'
                // Por lo tanto, `idCompra` siempre será `null` o no se usará.
                if (idCompra !== null) {
                     console.warn("Intentando abrir el formulario de compra en modo edición. Esta funcionalidad ha sido deshabilitada.");
                     return; // Evita abrir el modal si se pasa un ID para edición.
                }

                clearErrors(); // Limpiar errores antes de abrir el modal
                detalleCount = 0; // Resetear el contador de detalles cada vez que se abre el modal

                const url = '/documento-compra/nuevo'; // Siempre apuntar a la URL de nuevo

                $.ajax({ // Usar jQuery AJAX para cargar el fragmento
                    url: url,
                    type: 'GET',
                    success: function(html) {
                        modalFormContent.innerHTML = html; // Cargar el fragmento HTML en el modal
                        documentoCompraModalElement.modal('show'); // Mostrar el modal usando Bootstrap JS

                        // Re-adjuntar el manejador de envío del formulario después de que se cargue
                        const form = document.getElementById('documentoCompraForm');
                        if (form) {
                            form.onsubmit = function(event) {
                                event.preventDefault();
                                saveDocumentoCompra(form);
                            };
                        } else {
                            console.error("Formulario no encontrado en el modal.");
                        }

                        // Después de cargar el formulario (nuevo), cargar los productos activos
                        $.ajax({
                            url: '/productos/activos', // Asegúrate de que este endpoint devuelve solo productos activos
                            method: 'GET',
                            success: function(productos) {
                                // Actualizar allProductosData y llamar a initializeModalDetails
                                allProductosData = productos; // Actualiza la variable global
                                if (window.initializeModalDetails) { // Asegura que la función esté definida en el fragmento cargado
                                    window.initializeModalDetails(productos, null); // Pasa los productos obtenidos y null para los datos del documento
                                } else {
                                    console.warn("initializeModalDetails function not found in modal fragment.");
                                }

                                // Listener para el botón "Añadir Producto" dentro del modal
                                // Asumiendo que el botón tiene el ID 'addDetalleButton'
                                const addDetalleBtn = document.getElementById('addDetalleButton');
                                if (addDetalleBtn) {
                                    addDetalleBtn.onclick = function() {
                                        window.addDetalleCompra(null, allProductosData); // Pasa los productos a la función
                                    };
                                } else {
                                    console.warn("Botón 'Añadir Producto' no encontrado en el fragmento del modal. Asegúrate de que tenga id='addDetalleButton'.");
                                }

                            },
                            error: function(xhr, status, error) {
                                showNotification('error', 'Error al cargar los productos: ' + (xhr.responseJSON ? xhr.responseJSON.message : error));
                                closeFormModal(); // Cierra el modal si los productos son esenciales
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Error al cargar el formulario:', error, xhr.responseText);
                        showNotification('error', 'No se pudo cargar el formulario. Inténtalo de nuevo.');
                    }
                });
            }

            function closeFormModal() {
                documentoCompraModalElement.modal('hide'); // Ocultar el modal usando Bootstrap JS
                // Limpiar el contenido del modal después de que se haya ocultado completamente
                documentoCompraModalElement.on('hidden.bs.modal', function () {
                    modalFormContent.innerHTML = '';
                    documentoCompraModalElement.off('hidden.bs.modal'); // Remover el listener para evitar duplicados
                    recargarListaDocumentosCompraCompleta(); // Recargar la tabla principal al cerrar el modal
                });
                clearErrors(); // Limpiar errores al cerrar
            }

            // ===============================================
            // LÓGICA DEL MODAL DE VISUALIZACIÓN
            // ===============================================

            function openViewModal(idCompra) {
                // Se asume que el fragmento para ver el detalle es `documento_compra_view_modal.html`
                const url = `/documento-compra/ver/${idCompra}`; // Este endpoint debe devolver el fragmento HTML

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(html) {
                        modalViewContent.innerHTML = html; // Cargar el fragmento HTML en el modal de visualización
                        viewDocumentoCompraModalElement.modal('show'); // Mostrar el modal de visualización
                    },
                    error: function(xhr, status, error) {
                        console.error('Error al cargar los detalles del documento de compra:', error, xhr.responseText);
                        showNotification('error', 'No se pudo cargar los detalles. Inténtalo de nuevo.');
                    }
                });
            }

            function closeViewModal() {
                viewDocumentoCompraModalElement.modal('hide');
                // Limpiar el contenido del modal después de que se haya ocultado completamente
                viewDocumentoCompraModalElement.on('hidden.bs.modal', function () {
                    modalViewContent.innerHTML = '';
                    viewDocumentoCompraModalElement.off('hidden.bs.modal'); // Remover el listener
                });
            }

            // ===============================================
            // LÓGICA DE DETALLES DE COMPRA EN EL FORMULARIO MODAL
            // (Estas funciones deben ser globales para ser accesibles desde el fragmento)
            // ===============================================

            // Esta función se llama desde el script dentro del fragmento del modal
            // para inicializar los detalles de compra y los productos.
            window.initializeModalDetails = function(modalProductos, modalDocumento) {
                // Actualizar la variable global allProductosData si es necesario,
                // o simplemente usar modalProductos dentro del fragmento.
                allProductosData = modalProductos; // Ahora esta línea es crucial, modalProductos son los productos fetchados por AJAX
                const detalleComprasContainer = document.getElementById('detalleComprasContainer');
                if (!detalleComprasContainer) {
                    console.error("Error: 'detalleComprasContainer' no encontrado en el modal cargado.");
                    return;
                }
                detalleComprasContainer.innerHTML = ''; // Limpiar detalles existentes

                // NOTA: Con la eliminación de la edición, modalDocumento siempre será null aquí
                // al abrir el formulario. Si tuvieras un modo "solo lectura" donde el formulario
                // se cargara con datos, esta parte sería útil.
                if (modalDocumento && modalDocumento.detalleCompras && modalDocumento.detalleCompras.length > 0) {
                    modalDocumento.detalleCompras.forEach(detalle => {
                        addDetalleCompra(detalle, modalProductos); // Pasar productos al añadir detalle
                    });
                } else {
                    addDetalleCompra(null, modalProductos); // Añadir una fila vacía para nuevos documentos
                }
                calculateTotalGeneral();
            }

            // MODIFICADO: productosList ahora tiene un valor por defecto
            window.addDetalleCompra = function(detalle = null, productosList = allProductosData) {
                const index = detalleCount++;
                const detalleDiv = document.createElement('tr'); // Cambiado a <tr> para compatibilidad con la tabla
                detalleDiv.classList.add('detalle-item'); // Mantener la clase para estilos y selección
                detalleDiv.setAttribute('data-index', index);
                detalleDiv.id = `detalleRow-${index}`; // Añadir un ID para la fila

                let productoOptions = productosList.map(p => // Usar productosList
                    `<option value="${p.idProducto}" data-precio="${p.precioUnitario}" ${detalle && detalle.producto && detalle.producto.idProducto === p.idProducto ? 'selected' : ''}>
                        ${p.nombre} (Stock: ${p.stock})
                    </option>`
                ).join('');

                const initialCantidad = detalle ? (detalle.cantidad || '') : '';
                const initialPrecioUnitario = detalle ? (parseFloat(detalle.precioUnitario).toFixed(2) || '') : ''; // Formatear a 2 decimales
                const initialTotalDetalle = detalle ? (parseFloat(detalle.total) || 0).toFixed(2) : '0.00';


                detalleDiv.innerHTML = `
                    <td>
                        <input type="hidden" name="detalleCompras[${index}].idDetalleCompra" value="${detalle ? detalle.idDetalleCompra || '' : ''}">
                        <select name="detalleCompras[${index}].producto.idProducto" id="producto-${index}" required
                               class="form-control">
                            <option value="">Seleccione un Producto</option>
                            ${productoOptions}
                        </select>
                        <span class="text-danger" id="productoError-${index}"></span>
                    </td>
                    <td>
                        <input type="number" name="detalleCompras[${index}].cantidad" id="cantidad-${index}" placeholder="Cantidad" required min="1"
                               value="${initialCantidad}"
                               class="form-control">
                        <span class="text-danger" id="cantidadError-${index}"></span>
                    </td>
                    <td>
                        <input type="number" name="detalleCompras[${index}].precioUnitario" id="precioUnitario-${index}" placeholder="Precio Unitario" required min="0" step="0.01"
                               value="${initialPrecioUnitario}"
                               class="form-control">
                        <span class="text-danger" id="precioUnitarioError-${index}"></span>
                    </td>
                    <td>
                        <input type="text" class="form-control total-detalle-display bg-light" id="detalleTotalDisplay-${index}" value="${initialTotalDetalle}" readonly>
                    </td>
                    <td>
                        <button type="button" onclick="removeDetalleCompra(this)"
                               class="btn btn-danger btn-sm">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                const detalleComprasContainer = document.getElementById('detalleComprasContainer');
                detalleComprasContainer.appendChild(detalleDiv);

                // Adjuntar event listeners para la nueva fila
                const cantidadInput = document.getElementById(`cantidad-${index}`);
                const precioInput = document.getElementById(`precioUnitario-${index}`);
                const productoSelect = document.getElementById(`producto-${index}`);

                if (cantidadInput) cantidadInput.addEventListener('input', () => updateDetalleTotal(index));
                if (precioInput) precioInput.addEventListener('input', () => updateDetalleTotal(index));
                if (productoSelect) {
                    productoSelect.addEventListener('change', () => {
                        const selectedProduct = productosList.find(p => p.idProducto == productoSelect.value); // Usar productosList
                        if (selectedProduct) {
                            precioInput.value = parseFloat(selectedProduct.precioUnitario).toFixed(2);
                        }
                        updateDetalleTotal(index);
                    });
                }

                // Si el precio unitario no se inicializó desde el detalle, intenta usar el del producto
                if (detalle && initialPrecioUnitario === '' && productoSelect && productoSelect.value) {
                    const selectedProduct = productosList.find(p => p.idProducto == productoSelect.value); // Usar productosList
                    if (selectedProduct) {
                        precioInput.value = parseFloat(selectedProduct.precioUnitario).toFixed(2);
                    }
                } else if (!detalle && productoSelect && productoSelect.value) { // Para nueva fila con producto pre-seleccionado
                     const selectedProduct = productosList.find(p => p.idProducto == productoSelect.value); // Usar productosList
                     if (selectedProduct) {
                         precioInput.value = parseFloat(selectedProduct.precioUnitario).toFixed(2);
                     }
                }
                updateDetalleTotal(index);
            }

            window.removeDetalleCompra = function(button) {
                const detalleDiv = button.closest('tr.detalle-item'); // Seleccionar el <tr>
                if (detalleDiv) { // Agrega esta validación por si acaso
                    detalleDiv.remove();
                    calculateTotalGeneral();
                }
            }

            window.updateDetalleTotal = function(index) {
                const cantidadInput = document.getElementById(`cantidad-${index}`); // Asegura que existan
                const precioUnitarioInput = document.getElementById(`precioUnitario-${index}`); // Asegura que existan
                const totalDisplay = document.getElementById(`detalleTotalDisplay-${index}`); // Asegura que existan

                if (cantidadInput && precioUnitarioInput && totalDisplay) { // Validación de existencia
                    const cantidad = parseFloat(cantidadInput.value) || 0;
                    const precioUnitario = parseFloat(precioUnitarioInput.value) || 0;
                    const totalDetalle = cantidad * precioUnitario;
                    totalDisplay.value = totalDetalle.toFixed(2); // Usar .value para inputs
                    calculateTotalGeneral();
                }
            }

            window.calculateTotalGeneral = function() {
                let totalGeneral = 0;
                document.querySelectorAll('.detalle-item').forEach(detalleDiv => {
                    const totalDisplay = detalleDiv.querySelector('.total-detalle-display');
                    if (totalDisplay) { // Validación de existencia
                        // Para inputs, leer el valor con .value
                        const totalValue = parseFloat(totalDisplay.value) || 0;
                        totalGeneral += totalValue;
                    }
                });
                const totalGeneralDisplay = document.getElementById('totalGeneralDisplay'); // Asegura que exista
                if (totalGeneralDisplay) { // Validación de existencia
                    totalGeneralDisplay.value = totalGeneral.toFixed(2); // Usar .value para inputs
                }
            }

            // ===============================================
            // VALIDACIÓN DEL FORMULARIO
            // ===============================================

            async function validateForm() {
                clearErrors();
                let isValid = true;

                // Validar campos principales
                const tipoDocumentoInput = document.getElementById('tipoDocumentoSelect'); // Corregido ID
                if (tipoDocumentoInput && !tipoDocumentoInput.value) {
                    displayError('tipoDocumentoError', 'El tipo de documento es obligatorio.');
                    tipoDocumentoInput.classList.add('is-invalid');
                    isValid = false;
                } else if (tipoDocumentoInput) {
                    tipoDocumentoInput.classList.remove('is-invalid');
                }

                const numDocumentoInput = document.getElementById('numDocumento');
                if (numDocumentoInput && !numDocumentoInput.value.trim()) { // Agregado null check
                    displayError('numDocumentoError', 'El número de documento es obligatorio.');
                    numDocumentoInput.classList.add('is-invalid');
                    isValid = false;
                } else if (numDocumentoInput) { // Solo remueve si existe
                    numDocumentoInput.classList.remove('is-invalid');
                }

                const proveedorSelect = document.getElementById('proveedorSelect');
                if (proveedorSelect && !proveedorSelect.value) { // Agregado null check
                    displayError('proveedorSelectError', 'Debe seleccionar un proveedor.');
                    proveedorSelect.classList.add('is-invalid');
                    isValid = false;
                } else if (proveedorSelect) { // Solo remueve si existe
                    proveedorSelect.classList.remove('is-invalid');
                }


                // Validar detalles de compra
                const detalleRows = document.querySelectorAll('.detalle-item');
                if (detalleRows.length === 0) {
                    showNotification('error', 'Debe añadir al menos un producto a la compra.');
                    isValid = false;
                }

                for (const row of detalleRows) {
                    const index = row.getAttribute('data-index');

                    const productoSelect = document.getElementById(`producto-${index}`);
                    const cantidadInput = document.getElementById(`cantidad-${index}`);
                    const precioUnitarioInput = document.getElementById(`precioUnitario-${index}`);

                    // Agregadas validaciones de existencia antes de acceder a .value o .classList
                    if (productoSelect && !productoSelect.value) {
                        displayError(`productoError-${index}`, 'Seleccione un producto.');
                        productoSelect.classList.add('is-invalid');
                        isValid = false;
                    } else if (productoSelect) {
                        productoSelect.classList.remove('is-invalid');
                    }

                    const cantidad = parseFloat(cantidadInput ? cantidadInput.value : ''); // Usar null-check y valor vacío
                    if (cantidadInput && (isNaN(cantidad) || cantidad <= 0)) {
                        displayError(`cantidadError-${index}`, 'Cantidad > 0.');
                        cantidadInput.classList.add('is-invalid');
                        isValid = false;
                    } else if (cantidadInput) {
                        cantidadInput.classList.remove('is-invalid');
                    }

                    const precio = parseFloat(precioUnitarioInput ? precioUnitarioInput.value : ''); // Usar null-check y valor vacío
                    if (precioUnitarioInput && (isNaN(precio) || precio < 0)) {
                        displayError(`precioUnitarioError-${index}`, 'Precio >= 0.');
                        precioUnitarioInput.classList.add('is-invalid');
                        isValid = false;
                    } else if (precioUnitarioInput) {
                        precioUnitarioInput.classList.remove('is-invalid');
                    }
                }

                return isValid;
            }

            // ===============================================
            // LÓGICA DE GUARDADO DEL DOCUMENTO DE COMPRA
            // ===============================================

            async function saveDocumentoCompra(form) { // Convertido a async
                if (!(await validateForm())) { // Esperar la validación
                    return;
                }

                // Aquí, `idCompra` siempre será `null` o vacío ya que no hay edición.
                const idCompra = document.getElementById('idCompra') ? document.getElementById('idCompra').value : null;
                const fechaRegistro = document.getElementById('fechaRegistroDisplay') ? document.getElementById('fechaRegistroDisplay').value : ''; // Usar fechaRegistroDisplay
                const idProveedor = document.getElementById('proveedorSelect') ? document.getElementById('proveedorSelect').value : null;
                const tipoDocumento = document.getElementById('tipoDocumentoSelect') ? document.getElementById('tipoDocumentoSelect').value : '';
                const numDocumento = document.getElementById('numDocumento') ? document.getElementById('numDocumento').value : '';
                const totalElement = document.getElementById('totalGeneralDisplay');
                const total = totalElement ? parseFloat(totalElement.value) : 0;

                const detallesCompras = [];
                document.querySelectorAll('.detalle-item').forEach(detalleDiv => {
                    const index = detalleDiv.getAttribute('data-index');
                    // idDetalleCompra no es relevante para una nueva compra, puede ser null.
                    const currentIdDetalleCompra = detalleDiv.querySelector(`input[name="detalleCompras[${index}].idDetalleCompra"]`).value;
                    detallesCompras.push({
                        idDetalleCompra: (currentIdDetalleCompra && currentIdDetalleCompra.trim() !== '') ? parseInt(currentIdDetalleCompra) : null,
                        producto: { idProducto: parseInt(detalleDiv.querySelector(`#producto-${index}`).value) },
                        cantidad: parseInt(detalleDiv.querySelector(`#cantidad-${index}`).value),
                        precioUnitario: parseFloat(detalleDiv.querySelector(`#precioUnitario-${index}`).value),
                        total: parseFloat(detalleDiv.querySelector(`#detalleTotalDisplay-${index}`).value)
                    });
                });

                const data = {
                    idCompra: idCompra ? parseInt(idCompra) : null,
                    fechaRegistro: fechaRegistro,
                    proveedor: { idProveedor: idProveedor ? parseInt(idProveedor) : null },
                    tipoDocumento: tipoDocumento,
                    numDocumento: numDocumento,
                    total: total,
                    detalleCompras: detallesCompras
                };

                const url = '/documento-compra/guardar';

                try {
                    const response = await fetch(url, { // Usar await
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    });

                    if (!response.ok) {
                        const errorData = await response.json(); // Usar await
                        throw new Error(errorData.message || 'Error al guardar el documento de compra.');
                    }
                    const resultData = await response.json(); // Usar await
                    showNotification('success', resultData.message);
                    closeFormModal(); // Esto ahora recarga la tabla
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('error', error.message || 'Ocurrió un error inesperado al guardar.');
                }
            }

            // ===============================================
            // LÓGICA DE ANULACIÓN (Antes 'Cancelación')
            // ===============================================

            // Abrir el modal de confirmación de anulación y pasar el ID de la compra
            window.confirmCancelCompra = function(id) { // RENOMBRADO DE confirmDelete A confirmCancelCompra
                documentIdToCancel = id; // RENOMBRADO: Usar documentIdToCancel
                $('#adminPasswordInput').val(''); // Limpiar el campo de contraseña
                $('#adminPasswordError').text(''); // Limpiar cualquier error previo
                deleteConfirmModalElement.modal('show');
            }

            // Cerrar el modal de confirmación
            window.closeDeleteConfirmModal = function() {
                deleteConfirmModalElement.modal('hide');
                documentIdToCancel = null; // RENOMBRADO
                $('#adminPasswordInput').val('');
                $('#adminPasswordError').text('');
            }

            // Manejar la acción de anulación cuando se confirma en el modal
            document.getElementById('confirmDeleteButton').addEventListener('click', async function() {
                const adminPassword = $('#adminPasswordInput').val();
                if (!adminPassword) {
                    $('#adminPasswordError').text('La contraseña es obligatoria.');
                    return;
                }

                if (documentIdToCancel) { // RENOMBRADO: Usar documentIdToCancel
                    try {
                        const response = await fetch(`/documento-compra/anular/${documentIdToCancel}`, { // Endpoint /anular
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ password: adminPassword }), // Enviar la contraseña en el cuerpo
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            // Mostrar el error en el campo de contraseña del modal
                            $('#adminPasswordError').text(errorData.message || 'Error al anular la compra.');
                            // Mostrar una notificación de error general (opcional, ya que el error específico ya está en el modal)
                            showNotification('error', errorData.message || 'Error al anular el documento de compra.');
                            return; // Detener la ejecución si hay un error
                        }
                        const data = await response.json();
                        showNotification('success', data.message);
                        closeDeleteConfirmModal(); // Cerrar el modal y resetear ID
                        recargarListaDocumentosCompraCompleta(); // Recargar la tabla principal
                    } catch (error) {
                        console.error('Error:', error);
                        // Esto capturaría errores de red o parsing de JSON, no errores del backend manejados por response.ok
                        showNotification('error', 'Ocurrió un error de conexión al anular la compra.');
                    }
                }
            });

            // Función para predecir el número de documento y rellenar el campo
            function predictDocumentNumber() {
                const tipoDocumento = $('#tipoDocumentoSelect').val(); // Obtiene el valor seleccionado
                const numDocumentoInput = $('#numDocumento'); // El campo donde se mostrará el número

                // Siempre se predice el número para una NUEVA compra, ya que la edición fue eliminada.
                // El campo idCompra en el formulario modal debe estar vacío para que esto funcione.
                const idCompraField = document.getElementById('idCompra');
                const isNewDocument = (!idCompraField || !idCompraField.value);

                if (isNewDocument && (tipoDocumento === 'BOLETA' || tipoDocumento === 'FACTURA')) {
                    $.ajax({
                        url: '/documento-compra/next-num-documento',
                        type: 'GET',
                        data: { tipoDocumento: tipoDocumento },
                        success: function(response) {
                            if (response.status === 'success') {
                                numDocumentoInput.val(response.nextNumDocumento); // Rellena el campo con el número predicho
                            } else {
                                showNotification('error', response.message || 'Error al predecir el número de documento.');
                                numDocumentoInput.val(''); // Limpiar si hay error
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('AJAX Error:', status, error);
                            showNotification('error', 'Error de comunicación al predecir el número.');
                            numDocumentoInput.val(''); // Limpiar si hay error
                        }
                    });
                } else if (isNewDocument) { // Si es un documento nuevo pero no es BOLETA/FACTURA, limpiar el campo.
                    numDocumentoInput.val('');
                }
                // Si el formulario se carga para ver detalles (que no es este modal, sino el de solo lectura),
                // el valor del numDocumento vendrá de la base de datos y no se modificará.
            }


            // ===============================================
            // Event Listeners (Añade estos dos si no los tienes)
            // ===============================================

            // 1. Listener para cuando cambia la selección del "Tipo Documento"
            // Esto es crucial para que el número se genere al seleccionar Boleta/Factura.
            // Utiliza delegación de eventos si el modal se carga dinámicamente con AJAX.
            $(document).on('change', '#tipoDocumentoSelect', function() {
                predictDocumentNumber();
            });

            // 2. Listener para cuando el modal de registro/edición se muestra
            // 'modalDocumentoCompra' debe ser el ID de tu modal de Bootstrap.
            // Esto asegura que al abrir el modal para una NUEVA compra, se intente predecir el número.
            $('#documentoCompraModal').on('show.bs.modal', function () { // Corregido el ID a documentoCompraModal
                // Ejecutar predictDocumentNumber solo si el formulario es de CREACIÓN (idCompra está vacío)
                const idCompraField = document.getElementById('idCompra'); // Obtener el elemento por ID nativo
                if (!idCompraField || !idCompraField.value) { // Si el campo no existe o está vacío (es una nueva compra)
                    predictDocumentNumber(); // Predice el número al abrir el modal
                }
                // Asegurarse de que la fecha de registro en el modal muestre la fecha actual al CREAR
                if (!idCompraField || !idCompraField.value) {
                    const todayISO = new Date().toISOString().split('T')[0];
                    const fechaRegistroDisplay = document.getElementById('fechaRegistroDisplay');
                    if (fechaRegistroDisplay) {
                        fechaRegistroDisplay.value = todayISO;
                    }
                }
            });

            // ===============================================
            // INICIALIZACIÓN
            // ===============================================

            $(document).ready(function() {
                recargarListaDocumentosCompraCompleta();
            });

        /*]]>*/
    </script>
</th:block>
</html>
