<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios</title>
    <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css"/>
    <link rel="stylesheet" href="/dist/css/adminlte.min.css"/>
    <script src="/plugins/jquery/jquery.min.js"></script>
    <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/dist/js/adminlte.min.js"></script>
</head>
<body class="hold-transition sidebar-mini">
<section th:fragment="contenido" class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Usuarios</h3>
                        <div class="card-tools">
                            <a href="javascript:void(0)" onclick="abrirFormulario('/usuarios/nuevo')"
                               class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                                <i class="fas fa-plus"></i> Crear Nuevo Usuario
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12"> <div class="input-group">
                                <input type="search" id="searchTerm" class="form-control" placeholder="Buscar por nombre, apellido, DNI, correo, estado..."
                                       onkeyup="aplicarFiltros()"/> <div class="input-group-append">
                                <button class="btn btn-default" type="button" onclick="aplicarFiltros()">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                                <button class="btn btn-secondary ml-2" type="button" onclick="generarReporte()">
                                    <i class="fas fa-file-alt"></i> Generar Reporte
                                </button>
                            </div>
                            </div>
                            </div>
                        </div>
                        <div id="tablaUsuariosContainer">
                            <table id="usuariosTable" class="table table-bordered table-striped">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Apellido Paterno</th>
                                    <th>Apellido Materno</th>
                                    <th>DNI</th>
                                    <th>Rol</th>
                                    <th>Correo</th>
                                    <th>Celular</th>
                                    <th>Estado</th> <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody id="usuariosTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="usuarioModal" tabindex="-1" role="dialog" aria-labelledby="usuarioModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div id="modalFormContent">
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="reporteUsuariosModal" tabindex="-1" role="dialog" aria-labelledby="reporteUsuariosModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div id="modalReporteContent">
                </div>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/

        // Variable global para almacenar todos los usuarios
        // Thymeleaf pasa la lista de usuarios del modelo a esta variable JavaScript
        // Usamos 'let' para poder reasignarla después de operaciones CRUD
        allUsers = /*[[${usuarios}]]*/ [];

       // Función para renderizar la tabla con una lista de usuarios
        function renderizarTabla(usersToDisplay) {
            const tableBody = $('#usuariosTableBody');
            tableBody.empty(); // Limpiar el cuerpo de la tabla antes de añadir nuevos datos

            if (usersToDisplay.length === 0) {
                tableBody.append('<tr><td colspan="9" class="text-center">No se encontraron usuarios.</td></tr>');
                return;
            }

            usersToDisplay.forEach(usuario => {
                const estadoText = usuario.estado === 1 ? 'Activo' : 'Inactivo';
                const estadoClass = usuario.estado === 1 ? 'badge badge-success badge-pill' : 'badge badge-danger badge-pill';

                // ¡CORRECCIÓN AQUÍ!
                // Accedemos a 'tipoRol' porque así se llama la propiedad en tu clase RolUsuario.java
                const rolNombre = usuario.rolUsuario ? usuario.rolUsuario.tipoRol : 'N/A'; // Asegúrate de que exista y usa 'tipoRol'

                const row = `
                    <tr>
                        <td>${usuario.idUsuario}</td>
                        <td>${usuario.nombre}</td>
                        <td>${usuario.apPaterno}</td>
                        <td>${usuario.apMaterno}</td>
                        <td>${usuario.dni}</td>
                        <td>${rolNombre}</td> <td>${usuario.correo}</td>
                        <td>${usuario.telefono}</td>
                        <td class="text-center"><span class="${estadoClass}">${estadoText}</span></td>
                        <td>
                            <a href="javascript:void(0)" onclick="abrirFormulario('/usuarios/editar/${usuario.idUsuario}')"
                               class="btn btn-info btn-sm">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="javascript:void(0)" onclick="confirmarEliminar(${usuario.idUsuario})"
                               class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tableBody.append(row);
            });
        }

        // Función para limpiar todos los mensajes de error
        function clearErrors() {
            $('.text-danger').text('');
            $('.form-control').removeClass('is-invalid');
        }

        // Función para mostrar un mensaje de error específico
        function displayError(elementId, message) {
            $('#' + elementId).text(message);
            $('#' + elementId).prevAll('.form-control').first().addClass('is-invalid');
        }

        // ===========================================
        // FUNCIONES DE VALIDACIÓN ESPECÍFICAS
        // ===========================================

        function validateNombreApellido(inputElementId, errorElementId, fieldName) {
            const input = $('#' + inputElementId);
            let value = input.val();
            const originalValue = value; // Store original value before cleaning
            const regex = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]*$/; // Allows empty string and only letters

            // Remove any non-alphabetic characters
            value = value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');

            // Update input value if characters were removed
            if (value !== originalValue) {
                input.val(value);
            }

            if (value.trim() === "") {
                // If it's just spaces, or empty, clear error and remove invalid class
                displayError(errorElementId, '');
                input.removeClass('is-invalid');
                return true; // Consider valid for real-time if only letters
            } else if (!regex.test(value)) {
                // This case should ideally not be hit if we are stripping invalid chars,
                // but keep for robustness if stripping fails for some reason
                displayError(errorElementId, `${fieldName} solo debe contener letras.`);
                return false;
            } else {
                displayError(errorElementId, ''); // Clear error if valid
                input.removeClass('is-invalid');
                return true;
            }
        }

        function validateTelefono(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            let value = input.val();
            const originalValue = value; // Store original value before cleaning
            const regex = /^\d{9}$/;

            // Remove any non-digit characters and truncate to 9 digits
            value = value.replace(/\D/g, '').substring(0, 9);

            // Update input value if characters were removed or truncated
            if (value !== originalValue) {
                input.val(value);
            }

            if (value.length > 0 && !regex.test(value)) {
                displayError(errorElementId, "El teléfono debe tener 9 dígitos numéricos.");
                input.addClass('is-invalid');
                return false;
            } else if (value.length === 0) {
                // If empty, clear error and remove invalid class (will be checked by main validation on submit)
                displayError(errorElementId, '');
                input.removeClass('is-invalid');
                return true;
            } else {
                displayError(errorElementId, ''); // Clear error if valid
                input.removeClass('is-invalid');
                return true;
            }
        }

        function validateDni(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            let value = input.val();
            const originalValue = value; // Store original value before cleaning
            const regex = /^\d{8}$/;

            // Remove any non-digit characters and truncate to 8 digits
            value = value.replace(/\D/g, '').substring(0, 8);

            // Update input value if characters were removed or truncated
            if (value !== originalValue) {
                input.val(value);
            }

            if (value.length > 0 && !regex.test(value)) {
                displayError(errorElementId, "El DNI debe tener 8 dígitos numéricos.");
                input.addClass('is-invalid');
                return false;
            } else if (value.length === 0) {
                // If empty, clear error and remove invalid class (will be checked by main validation on submit)
                displayError(errorElementId, '');
                input.removeClass('is-invalid');
                return true;
            } else {
                displayError(errorElementId, ''); // Clear error if valid
                input.removeClass('is-invalid');
                return true;
            }
        }

        function validateCorreo(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (value === "") {
                input.removeClass('is-invalid');
                displayError(errorElementId, ''); // Clear error if empty
                return true;
            } else if (!regex.test(value)) {
                displayError(errorElementId, "Formato de correo electrónico inválido.");
                input.addClass('is-invalid');
                return false;
            }
            input.removeClass('is-invalid');
            displayError(errorElementId, ''); // Clear error if valid
            return true;
        }

        function validateContrasena(inputElementId, errorElementId, isNewUser) {
            const input = $('#' + inputElementId);
            const value = input.val();
            const minLength = 6;

            if (isNewUser) {
                if (value === "") {
                    displayError(errorElementId, "La contraseña es obligatoria.");
                    input.addClass('is-invalid');
                    return false;
                } else if (value.length < minLength) {
                    displayError(errorElementId, `La contraseña debe tener al menos ${minLength} caracteres.`);
                    input.addClass('is-invalid');
                    return false;
                }
            } else {
                if (value.length > 0 && value.length < minLength) {
                    displayError(errorElementId, `La contraseña debe tener al menos ${minLength} caracteres (si se proporciona una nueva).`);
                    input.addClass('is-invalid');
                    return false;
                }
            }
            input.removeClass('is-invalid');
            displayError(errorElementId, '');
            return true;
        }

        // Función asíncrona para verificar la unicidad del DNI
        async function checkDniUnico(dniInputId, dniErrorId, userId) {
            const dni = $('#' + dniInputId);
            const value = dni.val().trim();

            if (value.length !== 8) {
                // If not 8 digits, let the DNI format validation handle it
                return true;
            }

            let url = '/usuarios/checkDni?dni=' + value;
            if (userId) {
                url += '&idUsuario=' + userId;
            }

            try {
                const response = await $.ajax({
                    type: "GET",
                    url: url,
                    dataType: "json"
                });
                if (response.exists) {
                    displayError(dniErrorId, "Este DNI ya está registrado.");
                    $('#' + dniInputId).addClass('is-invalid');
                    return false;
                }
                $('#' + dniInputId).removeClass('is-invalid');
                displayError(dniErrorId, '');
                return true;
            } catch (error) {
                console.error("Error al verificar DNI:", error);
                displayError(dniErrorId, "Error al verificar DNI. Intenta de nuevo.");
                $('#' + dniInputId).addClass('is-invalid');
                return false;
            }
        }

        // ===========================================
        // FUNCIÓN PRINCIPAL DE VALIDACIÓN DEL FORMULARIO AL ENVIAR
        // ===========================================

        async function validarFormulario() {
            clearErrors(); // Clear all errors before re-validating

            let isValid = true;

            // Perform final validation checks including emptiness
            // These will set the errors correctly for submission
            if (!validateNombreApellidoSubmit('nombre', 'nombreError', 'El nombre')) isValid = false;
            if (!validateNombreApellidoSubmit('apPaterno', 'apPaternoError', 'El apellido paterno')) isValid = false;
            if (!validateNombreApellidoSubmit('apMaterno', 'apMaternoError', 'El apellido materno')) isValid = false;
            if (!validateTelefonoSubmit('telefono', 'telefonoError')) isValid = false;
            if (!validateDniSubmit('dni', 'dniError')) isValid = false;
            if (!validateCorreo('correo', 'correoError')) isValid = false; // Correo still uses its general validation

            const isNewUser = $('#idUsuario').val() === '';
            if (!validateContrasena('contrasena', isNewUser ? 'contrasenaValidation' : 'contrasenaError', isNewUser)) isValid = false;

            if (!isValid) {
                return false;
            }

            const userId = $('#idUsuario').val();
            const dniUnico = await checkDniUnico('dni', 'dniError', userId ? parseInt(userId) : null);
            if (!dniUnico) {
                isValid = false;
            }

            return isValid;
        }

        // New validation functions for form submission (to ensure fields are not empty)
        function validateNombreApellidoSubmit(inputElementId, errorElementId, fieldName) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/;

            if (value === "") {
                displayError(errorElementId, `${fieldName} es obligatorio.`);
                return false;
            } else if (!regex.test(value)) {
                displayError(errorElementId, `${fieldName} solo debe contener letras.`);
                return false;
            }
            input.removeClass('is-invalid');
            displayError(errorElementId, '');
            return true;
        }

        function validateTelefonoSubmit(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^\d{9}$/;

            if (value === "") {
                displayError(errorElementId, "El teléfono es obligatorio.");
                return false;
            } else if (!regex.test(value)) {
                displayError(errorElementId, "El teléfono debe tener 9 dígitos numéricos.");
                return false;
            }
            input.removeClass('is-invalid');
            displayError(errorElementId, '');
            return true;
        }

        function validateDniSubmit(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^\d{8}$/;

            if (value === "") {
                displayError(errorElementId, "El DNI es obligatorio.");
                return false;
            } else if (!regex.test(value)) {
                displayError(errorElementId, "El DNI debe tener 8 dígitos numéricos.");
                return false;
            }
            input.removeClass('is-invalid');
            displayError(errorElementId, '');
            return true;
        }

        // ===========================================
        // MANEJADORES DE EVENTOS DEL MODAL Y FORMULARIO
        // ===========================================

        function abrirFormulario(url) {
            console.log("Intentando abrir formulario desde URL:", url);
            $('#modalFormContent').load(url, function(response, status, xhr) {
                if (status === "error") {
                    console.error("Error al cargar el formulario:", xhr.status, xhr.statusText, response);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al cargar formulario',
                        text: 'Hubo un problema al cargar el formulario. Por favor, inténtalo de nuevo.',
                        footer: `Detalles: ${xhr.status} ${xhr.statusText}`
                    });
                } else {
                    console.log("Formulario cargado exitosamente. Contenido:", response.substring(0, 200) + "...");
                    // Add oninput event listeners for real-time validation after the form is loaded
                    $('#nombre').on('input', function() { validateNombreApellido('nombre', 'nombreError', 'El nombre'); });
                    $('#apPaterno').on('input', function() { validateNombreApellido('apPaterno', 'apPaternoError', 'El apellido paterno'); });
                    $('#apMaterno').on('input', function() { validateNombreApellido('apMaterno', 'apMaternoError', 'El apellido materno'); });
                    $('#dni').on('input', function() { validateDni('dni', 'dniError'); });
                    $('#telefono').on('input', function() { validateTelefono('telefono', 'telefonoError'); });
                    $('#correo').on('input', function() { validateCorreo('correo', 'correoError'); });
                    $('#contrasena').on('input', function() { validateContrasena('contrasena', $('#idUsuario').val() === '' ? 'contrasenaValidation' : 'contrasenaError', $('#idUsuario').val() === ''); });


                    $('#formUsuario').off('submit').on('submit', async function(e) {
                        e.preventDefault();
                        const formIsValid = await validarFormulario();
                        if (formIsValid) {
                            guardarUsuarioAjax($(this));
                        } else {
                            console.log("Formulario inválido. No se envía.");
                            mostrarNotificacion("error", "Por favor, corrige los errores en el formulario.");
                        }
                    });
                    $('#usuarioModal').modal('show');
                    console.log("Modal de usuario intentando mostrarse.");
                }
            });
        }

        function cerrarFormulario() {
            $('#usuarioModal').modal('hide');
            $('#modalFormContent').empty();
            clearErrors();
            console.log("Modal de usuario cerrado.");
        }

        // Función para guardar/actualizar usuario usando AJAX
        function guardarUsuarioAjax(formElement) {
            let formData = formElement.serialize();
            let url = formElement.attr('action');

            $.ajax({
                type: "POST",
                url: url,
                data: formData,
                success: function(response) {
                    if (response.status === "success") {
                        mostrarNotificacion("success", response.message);
                        cerrarFormulario();
                        // Después de guardar/editar, recargar la lista completa de usuarios
                        recargarListaUsuariosCompleta(); // Se llama aquí
                    } else {
                        mostrarNotificacion("error", "Error: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = "Error al procesar la solicitud.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ": " + xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        errorMessage += ": " + xhr.responseText.substring(0, 100) + "...";
                    }
                    mostrarNotificacion("error", errorMessage);
                    console.error("Error AJAX al guardar usuario:", error, xhr.responseText);
                }
            });
        }

        // Función para confirmar la eliminación de un usuario usando AJAX
        function confirmarEliminar(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log("Eliminando usuario con ID:", id);
                    $.ajax({
                        type: "GET",
                        url: '/usuarios/eliminar/' + id,
                        success: function(response) {
                            if (response.status === "success") {
                                mostrarNotificacion("success", response.message);
                                // Después de eliminar, recargar la lista completa de usuarios
                                recargarListaUsuariosCompleta(); // Se llama aquí
                            } else {
                                mostrarNotificacion("error", "Error: " + response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            let errorMessage = "Error al eliminar el usuario.";
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ": " + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ": " + xhr.responseText.substring(0, 100) + "...";
                            }
                            mostrarNotificacion("error", errorMessage);
                            console.error("Error AJAX al eliminar usuario:", error, xhr.responseText);
                        }
                    });
                }
            });
        }

        // ===========================================
        // FUNCIONES DE FILTRADO Y REPORTE (ACTUALIZADAS)
        // ===========================================

        // Función para recargar la lista completa de usuarios desde el servidor
        // y luego aplicar los filtros locales. (Mantenida)
        function recargarListaUsuariosCompleta() {
            $.ajax({
                type: "GET",
                url: '/usuarios/all', // Este endpoint DEBE existir en tu backend y devolver JSON
                dataType: "json",
                success: function(response) {
                    allUsers = response; // Actualizar la variable global con los nuevos datos
                    aplicarFiltros(); // Aplicar el filtro actual a la nueva lista (mantener el término de búsqueda)
                },
                error: function(xhr, status, error) {
                    console.error("Error al recargar la lista completa de usuarios:", error);
                    mostrarNotificacion("error", "Error al recargar la lista de usuarios. Verifica el endpoint /usuarios/all en tu backend.");
                }
            });
        }

        // La función aplicarFiltros YA NO HACE UNA LLAMADA AJAX a la URL principal,
        // SINO QUE FILTRA LA LISTA allUsers EN EL CLIENTE Y RENDERIZA LA TABLA. (Mantenida)
        function aplicarFiltros() {
            const searchTerm = $('#searchTerm').val().toLowerCase().trim();
            let filteredUsers = allUsers; // Siempre empezamos con la lista completa

            if (searchTerm) {
                // Filtro específico para "activo" o "inactivo"
                if (searchTerm === 'activo') {
                    filteredUsers = allUsers.filter(usuario => usuario.estado === 1);
                } else if (searchTerm === 'inactivo') {
                    filteredUsers = allUsers.filter(usuario => usuario.estado === 0);
                } else {
                    // Si no es "activo" o "inactivo", aplica el filtro general en todos los campos
                    filteredUsers = allUsers.filter(usuario => {
                        const estadoText = usuario.estado === 1 ? 'activo' : 'inactivo'; // Para buscar por texto de estado
                        const rolNombre = usuario.rolUsuario ? usuario.rolUsuario.tipoRol.toLowerCase() : ''; // Para buscar por texto de rol
                        return (
                            (usuario.nombre && usuario.nombre.toLowerCase().includes(searchTerm)) ||
                            (usuario.apPaterno && usuario.apPaterno.toLowerCase().includes(searchTerm)) ||
                            (usuario.apMaterno && usuario.apMaterno.toLowerCase().includes(searchTerm)) ||
                            (usuario.dni && usuario.dni.toLowerCase().includes(searchTerm)) ||
                            (usuario.correo && usuario.correo.toLowerCase().includes(searchTerm)) ||
                            estadoText.includes(searchTerm) ||
                            rolNombre.includes(searchTerm) // Añadir búsqueda por rol
                        );
                    });
                }
            }
            renderizarTabla(filteredUsers); // Renderizar la tabla con los usuarios filtrados
        }

        // NUEVA FUNCIÓN: Abre el modal de generación de reporte
        function generarReporte() {
            console.log("Abriendo modal de generación de reporte.");
            $('#modalReporteContent').load('/usuarios/reporte/modal', function(response, status, xhr) {
                if (status === "error") {
                    console.error("Error al cargar el modal de reporte:", xhr.status, xhr.statusText, response);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Hubo un problema al cargar el formulario de reporte. Por favor, inténtalo de nuevo.',
                        footer: `Detalles: ${xhr.status} ${xhr.statusText}`
                    });
                } else {
                    $('#reporteUsuariosModal').modal('show');
                    console.log("Modal de reporte cargado y mostrado.");
                }
            });
        }

        // NUEVA FUNCIÓN: Cierra el modal de generación de reporte
        function cerrarReporteModal() {
            $('#reporteUsuariosModal').modal('hide');
            $('#modalReporteContent').empty();
            console.log("Modal de reporte cerrado.");
        }

        // NUEVA FUNCIÓN: Ejecuta la generación del reporte PDF con los filtros
        function ejecutarGenerarReporte() {
            const form = $('#formReporteUsuarios');
            const formData = form.serialize(); // Obtiene todos los parámetros del formulario de filtros

            // Construir la URL con los parámetros de los filtros
            const url = '/usuarios/reporte/pdf?' + formData;

            // Abrir una nueva ventana o pestaña para la descarga del PDF
            // Esto es crucial porque la respuesta es un archivo, no JSON.
            window.open(url, '_blank');

            mostrarNotificacion("success", "Generando reporte PDF...");
            cerrarReporteModal(); // Cierra el modal después de iniciar la descarga
        }
        // NUEVA FUNCIÓN: Limpia los filtros del modal de reporte
    function limpiarFiltrosReporte() {
        $('#formReporteUsuarios')[0].reset(); // Resetea el campo de texto
        // Desmarcar todos los checkboxes de roles
        $('.rol-checkbox').prop('checked', false);
        // Desmarcar todos los checkboxes de estados
        $('.estado-checkbox').prop('checked', false);
    }


    // NUEVA FUNCIÓN: Ejecuta la generación del reporte PDF con los filtros
    function ejecutarGenerarReporte() {
        const form = $('#formReporteUsuarios');
        const formData = form.serialize(); // Obtiene todos los parámetros del formulario de filtros

        // Mostrar indicador de carga con SweetAlert2
        Swal.fire({
            title: 'Generando Reporte...',
            html: 'Por favor espera, esto puede tardar unos segundos.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Construir la URL con los parámetros de los filtros
        const url = '/usuarios/reporte/pdf?' + formData;

        // Abrir una nueva ventana o pestaña para la descarga del PDF
        // Esto es crucial porque la respuesta es un archivo, no JSON.
        // Usamos un pequeño retraso para que el Swal.fire() tenga tiempo de renderizarse.
        setTimeout(() => {
            const newWindow = window.open(url, '_blank');
            // Opcional: Intentar detectar si la ventana se abrió y cerró para ocultar el spinner
            // Esto es complicado y a menudo poco fiable, una simple notificación es mejor.
            if (newWindow) {
                // Si la ventana/pestaña se abrió, asumimos que la descarga ha comenzado.
                Swal.close();
                mostrarNotificacion("success", "El reporte PDF se está generando y debería descargarse pronto.");
                cerrarReporteModal(); // Cierra el modal después de iniciar la descarga
            } else {
                // El navegador bloqueó el popup o hubo un problema.
                Swal.close();
                mostrarNotificacion("error", "Error: Tu navegador bloqueó la descarga del PDF. Por favor, permite los pop-ups para este sitio.");
            }
        }, 300); // Pequeño retraso
    }

        // Función para mostrar notificaciones usando AdminLTE Toasts
        function mostrarNotificacion(type, message) {
            $(document).Toasts('create', {
                class: type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-info' : 'bg-danger'),
                title: type === 'success' ? 'Éxito' : (type === 'info' ? 'Información' : 'Error'),
                body: message,
                autohide: true,
                delay: 3000
            });
        }

        // Ejecutar al cargar la página por primera vez
        $(document).ready(function() {
            // La variable allUsers ya viene inicializada por Thymeleaf en la primera carga.
            // Solo necesitamos renderizar la tabla con esos datos.
            aplicarFiltros(); // Esto también aplicará cualquier searchTerm inicial si lo hubiera
        });

        /*]]>*/
    </script>
</section>
</body>
</html>
