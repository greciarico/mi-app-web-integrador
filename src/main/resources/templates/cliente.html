<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes</title>
    <!-- Incluye CSS AdminLTE y dependencias -->
    <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css"/>
    <link rel="stylesheet" href="/dist/css/adminlte.min.css"/>
    <!-- Más estilos -->
    <script src="/plugins/jquery/jquery.min.js"></script>
    <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/dist/js/adminlte.min.js"></script>
</head>
<body class="hold-transition sidebar-mini">
<section th:fragment="contenido" class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Clientes</h3>
                        <div class="card-tools">
                            <a href="javascript:void(0)" onclick="abrirFormularioCliente('/clientes/nuevo')"
                               class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                                <i class="fas fa-user-plus"></i> Crear Nuevo Cliente
                            </a>
                        </div>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body">
                        <!-- FILTROS Y BUSCADOR -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="filterTipoCliente">Filtrar por Tipo de Cliente:</label>
                                    <select class="form-control" id="filterTipoCliente" onchange="aplicarFiltrosCliente()">
                                        <option value="">Todos</option>
                                        <option th:each="tipo : ${tiposCliente}"
                                                th:value="${tipo.idRolCliente}"
                                                th:text="${tipo.rolCliente}"
                                                th:selected="${selectedTipoClienteId != null and selectedTipoClienteId == tipo.idRolCliente}">
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="searchTermCliente">Buscar por nombre, DNI, RUC, razón social...</label>
                                    <div class="input-group">
                                        <input type="search" id="searchTermCliente" class="form-control"
                                               th:value="${searchTerm != null ? searchTerm : ''}"
                                               placeholder="Buscar por DNI, RUC, nombre, razón social..."
                                               onkeyup="aplicarFiltrosCliente()"/>
                                        <div class="input-group-append">
                                            <button class="btn btn-default" type="button" onclick="aplicarFiltrosCliente()">
                                                <i class="fas fa-search"></i> Buscar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- FIN FILTROS Y BUSCADOR -->

                        <!-- Tabla de Clientes -->
                        <div id="tablaClientesContainer">
                            <table id="clientesTable" class="table table-bordered table-striped">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Tipo</th>
                                    <th>DNI/RUC</th>
                                    <th>Nombre/Razón Social</th>
                                    <th>Dirección</th>
                                    <th>Teléfono</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody id="clientesTableBody">
                                <!-- Contenido de la tabla se generará con JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- /.card-body -->
                </div>
                <!-- /.card -->
            </div>
            <!-- /.col -->
        </div>
        <!-- /.row -->
    </div>
    <!-- /.container-fluid -->

    <!-- Modal para el Formulario de Cliente -->
    <div class="modal fade" id="clienteModal" tabindex="-1" role="dialog" aria-labelledby="clienteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div id="modalFormContentCliente">
                    <!-- El fragmento cliente_form_modal.html se insertará aquí -->
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/

        // Variable global para almacenar todos los registros de Cliente (no se usa si se filtra desde el backend)
        // Usamos esta para guardar los clientes cuando vienen del backend filtrados y aplicar filtros solo por UI si es necesario
        let allClientes = /*[[${clientes}]]*/ [];

        // Función para renderizar la tabla con una lista de Cliente
        function renderizarTablaCliente(clientesToDisplay) {
            const tableBody = $('#clientesTableBody');
            tableBody.empty();

            if (clientesToDisplay.length === 0) {
                tableBody.append('<tr><td colspan="8" class="text-center">No se encontraron registros de Clientes.</td></tr>');
                return;
            }

            clientesToDisplay.forEach(cliente => {
                const tipoClienteNombre = cliente.tipoCliente ? cliente.tipoCliente.rolCliente : 'Desconocido'; // CAMBIADO: rolCliente
                const identificacion = cliente.dni || cliente.ruc || 'N/A';
                const nombreDisplay = cliente.nombre ? `${cliente.nombre} ${cliente.apPaterno || ''} ${cliente.apMaterno || ''}`.trim() : cliente.razonSocial || 'N/A';
                const estadoText = cliente.estado === 1 ? 'Activo' : 'Inactivo';
                const estadoClass = cliente.estado === 1 ? 'badge badge-success badge-pill' : 'badge badge-danger badge-pill';

                const row = `
                    <tr>
                        <td>${cliente.idCliente}</td>
                        <td>${tipoClienteNombre}</td>
                        <td>${identificacion}</td>
                        <td>${nombreDisplay}</td>
                        <td>${cliente.direccion || 'N/A'}</td>
                        <td>${cliente.telefono || 'N/A'}</td>
                        <td class="text-center"><span class="${estadoClass}">${estadoText}</span></td>
                        <td>
                            <a href="javascript:void(0)" onclick="abrirFormularioCliente('/clientes/editar/${cliente.idCliente}')"
                               class="btn btn-info btn-sm">
                                <i class="fas fa-edit"></i> Editar
                            </a>
                            <a href="javascript:void(0)" onclick="confirmarEliminarCliente(${cliente.idCliente})"
                               class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i> Eliminar
                            </a>
                        </td>
                    </tr>
                `;
                tableBody.append(row);
            });
        }

        // Función para limpiar todos los mensajes de error (genérica)
        function clearErrors() {
            $('.text-danger').text('');
            $('.form-control').removeClass('is-invalid');
        }

        // Función para mostrar un mensaje de error específico (genérica)
        function displayError(elementId, message) {
            $('#' + elementId).text(message);
            $('#' + elementId).prevAll('.form-control').first().addClass('is-invalid');
        }

        // ===========================================
        // FUNCIONES DE VALIDACIÓN ESPECÍFICAS (PARA CLIENTE)
        // Se usarán en cliente_form_modal.html
        // ===========================================
        // Estas funciones se definen aquí para que estén disponibles globalmente al cargar el modal.
        function validateRequired(inputElementId, errorElementId, fieldName) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            if (value === "") {
                displayError(errorElementId, `${fieldName} es obligatorio.`);
                return false;
            }
            input.removeClass('is-invalid');
            return true;
        }

        function validateDni(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^\d{8}$/; // Exactamente 8 dígitos numéricos

            if (value === "") {
                displayError(errorElementId, "El DNI es obligatorio.");
                return false;
            } else if (!regex.test(value)) {
                displayError(errorElementId, "El DNI debe tener 8 dígitos numéricos.");
                return false;
            }
            input.removeClass('is-invalid');
            return true;
        }

        function validateRuc(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^\d{11}$/; // Exactamente 11 dígitos numéricos

            if (value === "") {
                displayError(errorElementId, "El RUC es obligatorio.");
                return false;
            } else if (!regex.test(value)) {
                displayError(errorElementId, "El RUC debe tener 11 dígitos numéricos.");
                return false;
            }
            input.removeClass('is-invalid');
            return true;
        }

        function validateNombreApellidos(inputElementId, errorElementId, fieldName) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/; // Solo letras y espacios

            if (value === "") {
                displayError(errorElementId, `${fieldName} es obligatorio.`);
                return false;
            } else if (!regex.test(value)) {
                displayError(errorElementId, `${fieldName} solo debe contener letras.`);
                return false;
            }
            input.removeClass('is-invalid');
            return true;
        }

        function validateTelefono(inputElementId, errorElementId) {
            const input = $('#' + inputElementId);
            const value = input.val().trim();
            const regex = /^\d{9}$/; // Exactamente 9 dígitos numéricos (opcional si está vacío)

            if (value === "") {
                input.removeClass('is-invalid'); // No es obligatorio, si está vacío es válido
                return true;
            } else if (!regex.test(value)) {
                displayError(errorElementId, "El teléfono debe tener 9 dígitos numéricos.");
                return false;
            }
            input.removeClass('is-invalid');
            return true;
        }

        // Función asíncrona para verificar unicidad de DNI
        async function checkDniUnicoCliente(dniInputId, dniErrorId, idCliente) {
            const dni = $('#' + dniInputId).val();
            if (dni.trim() === "") return true; // La validación de DNI vacío ya lo maneja

            let url = '/clientes/checkDni?dni=' + encodeURIComponent(dni);
            if (idCliente) {
                url += '&idCliente=' + idCliente;
            }
            try {
                const response = await $.ajax({ type: "GET", url: url, dataType: "json" });
                if (response.exists) {
                    displayError(dniErrorId, "Este DNI ya está registrado.");
                    return false;
                }
                return true;
            } catch (error) {
                console.error("Error al verificar DNI de cliente:", error);
                displayError(dniErrorId, "Error al verificar DNI. Intenta de nuevo.");
                return false;
            }
        }

        // Función asíncrona para verificar unicidad de RUC
        async function checkRucUnicoCliente(rucInputId, rucErrorId, idCliente) {
            const ruc = $('#' + rucInputId).val();
            if (ruc.trim() === "") return true; // La validación de RUC vacío ya lo maneja

            let url = '/clientes/checkRuc?ruc=' + encodeURIComponent(ruc);
            if (idCliente) {
                url += '&idCliente=' + idCliente;
            }
            try {
                const response = await $.ajax({ type: "GET", url: url, dataType: "json" });
                if (response.exists) {
                    displayError(rucErrorId, "Este RUC ya está registrado.");
                    return false;
                }
                return true;
            } catch (error) {
                console.error("Error al verificar RUC de cliente:", error);
                displayError(rucErrorId, "Error al verificar RUC. Intenta de nuevo.");
                return false;
            }
        }

        // ===========================================
        // MANEJADORES DE EVENTOS DEL MODAL Y FORMULARIO DE CLIENTE
        // ===========================================

        function abrirFormularioCliente(url) {
            console.log("Intentando abrir formulario de Cliente desde URL:", url);
            $('#modalFormContentCliente').load(url, function(response, status, xhr) {
                if (status === "error") {
                    console.error("Error al cargar el formulario de Cliente:", xhr.status, xhr.statusText, response);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al cargar formulario',
                        text: 'Hubo un problema al cargar el formulario. Por favor, inténtalo de nuevo.',
                        footer: `Detalles: ${xhr.status} ${xhr.statusText}`
                    });
                } else {
                    console.log("Formulario de Cliente cargado exitosamente.");

                    // Asegúrate de que el select de tipos de cliente tenga el manejador de cambio
                    $('#idTipoCliente').off('change').on('change', function() {
                        toggleClientFields(); // Llamar a la función para alternar campos
                    });

                    // Llamar a toggleClientFields una vez al cargar el formulario
                    // para establecer el estado inicial correcto
                    toggleClientFields();

                    $('#formCliente').off('submit').on('submit', async function(e) {
                        e.preventDefault();
                        const formIsValid = await validarFormularioCliente();
                        if (formIsValid) {
                            guardarClienteAjax();
                        } else {
                            console.log("Formulario de Cliente inválido. No se envía.");
                            mostrarNotificacion("error", "Por favor, corrige los errores en el formulario.");
                        }
                    });
                    $('#clienteModal').modal('show');
                    console.log("Modal de Cliente intentando mostrarse.");
                }
            });
        }

        function cerrarFormularioCliente() {
            $('#clienteModal').modal('hide');
            setTimeout(function() {
                $('#modalFormContentCliente').empty();
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open');
            }, 300);
            clearErrors();
            console.log("Modal de Cliente cerrado.");
        }

        // Función para guardar/actualizar cliente con AJAX
        function guardarClienteAjax() {
            const idCliente = $('#idCliente').val();
            const idTipoCliente = parseInt($('#idTipoCliente').val(), 10);
            const tipoClienteObj = { idRolCliente: idTipoCliente }; // CAMBIADO: idRolCliente

            const dataToSend = {
                idCliente: idCliente === '' ? null : parseInt(idCliente, 10),
                fechaRegistro: $('#fechaRegistro').val(), // Se pasa tal cual, backend lo manejará
                tipoCliente: tipoClienteObj,
                direccion: $('#direccion').val(),
                telefono: $('#telefono').val(),
                estado: parseInt($('#estado').val(), 10) // Estado
            };

            // Añadir campos específicos según el tipo de cliente
            if (idTipoCliente === 1) { // Persona Natural
                dataToSend.dni = $('#dni').val();
                dataToSend.nombre = $('#nombre').val();
                dataToSend.apPaterno = $('#apPaterno').val();
                dataToSend.apMaterno = $('#apMaterno').val();
            } else if (idTipoCliente === 2) { // Persona Jurídica
                dataToSend.ruc = $('#ruc').val();
                dataToSend.razonSocial = $('#razonSocial').val();
                dataToSend.nombreComercial = $('#nombreComercial').val();
            }

            const url = '/clientes/guardar';

            $.ajax({
                type: "POST",
                url: url,
                contentType: 'application/json',
                data: JSON.stringify(dataToSend),
                success: function(response) {
                    if (response.status === "success") {
                        mostrarNotificacion("success", response.message);
                        cerrarFormularioCliente();
                        recargarListaClientesCompleta();
                    } else {
                        mostrarNotificacion("error", "Error: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = "Error al procesar la solicitud.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += ": " + xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        errorMessage += ": " + xhr.responseText.substring(0, Math.min(xhr.responseText.length, 100)) + "...";
                    }
                    mostrarNotificacion("error", errorMessage);
                    console.error("Error AJAX al guardar Cliente:", error, xhr.responseText, xhr);
                }
            });
        }

        function confirmarEliminarCliente(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡El cliente será marcado como inactivo!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log("Eliminando Cliente con ID:", id);
                    $.ajax({
                        type: "GET", // La eliminación es un GET aquí
                        url: '/clientes/eliminar/' + id,
                        success: function(response) {
                            if (response.status === "success") {
                                mostrarNotificacion("success", response.message);
                                recargarListaClientesCompleta();
                            } else {
                                mostrarNotificacion("error", "Error: " + response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            let errorMessage = "Error al eliminar el Cliente.";
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage += ": " + xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                errorMessage += ": " + xhr.responseText.substring(0, Math.min(xhr.responseText.length, 100)) + "...";
                            }
                            mostrarNotificacion("error", errorMessage);
                            console.error("Error AJAX al eliminar Cliente:", error, xhr.responseText);
                        }
                    });
                }
            });
        }

        // ===========================================
        // FUNCIONES DE FILTRADO (CLIENT-SIDE Y SERVER-SIDE)
        // ===========================================

        // Esta función se llama al cargar la página y al aplicar filtros
        // Deberá hacer una llamada AJAX para obtener los datos filtrados del backend
        function recargarListaClientesCompleta() {
            const idTipoCliente = $('#filterTipoCliente').val();
            const searchTerm = $('#searchTermCliente').val();

            let url = '/clientes/all?';
            const params = [];
            if (idTipoCliente) {
                params.push('idTipoCliente=' + encodeURIComponent(idTipoCliente));
            }
            if (searchTerm) {
                params.push('searchTerm=' + encodeURIComponent(searchTerm));
            }
            url += params.join('&');

            $.ajax({
                type: "GET",
                url: url,
                dataType: "json",
                success: function(response) {
                    allClientes = response; // Actualizar la variable global con los nuevos datos
                    renderizarTablaCliente(allClientes); // Renderizar directamente con lo que viene del backend
                },
                error: function(xhr, status, error) {
                    console.error("Error al recargar la lista completa de Clientes:", error);
                    mostrarNotificacion("error", "Error al recargar la lista de Clientes. Verifica el endpoint /clientes/all en tu backend.");
                }
            });
        }

        function aplicarFiltrosCliente() {
            // Esta función ahora solo llama a recargarListaClientesCompleta(),
            // que se encargará de obtener los datos filtrados del servidor.
            recargarListaClientesCompleta();
        }

        function generarReporteCliente() {
            mostrarNotificacion("info", "La funcionalidad de generar reporte de Cliente aún no está implementada.");
        }

        // Función para mostrar notificaciones usando AdminLTE Toasts
        function mostrarNotificacion(type, message) {
            $(document).Toasts('create', {
                class: type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-info' : 'bg-danger'),
                title: type === 'success' ? 'Éxito' : (type === 'info' ? 'Información' : 'Error'),
                body: message,
                autohide: true,
                delay: 3000
            });
        }

        // Ejecutar al cargar la página por primera vez
        $(document).ready(function() {
            // La tabla se renderiza inicialmente con los datos que trae el modelo de Spring.
            renderizarTablaCliente(allClientes);
            // Esto asegura que si hay filtros preestablecidos en la URL, se apliquen al cargar.
            aplicarFiltrosCliente();
        });

        /*]]>*/
    </script>
</section>
</body>
</html>
