<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Productos</title>
  <!-- Incluye CSS AdminLTE y dependencias -->
  <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css"/>
  <link rel="stylesheet" href="/dist/css/adminlte.min.css"/>
  <!-- Más estilos -->
  <script src="/plugins/jquery/jquery.min.js"></script>
  <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/dist/js/adminlte.min.js"></script>
</head>
<body class="hold-transition sidebar-mini">
<section th:fragment="contenido" class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Lista de Productos</h3>
            <div class="card-tools">
              <a href="javascript:void(0)" onclick="abrirFormularioProducto('/productos/nuevo')"
                 class="btn btn-success" style="background-color:#183D00 !important; border-color:#183D00 !important;">
                <i class="fas fa-plus"></i> Crear Nuevo Producto
              </a>
            </div>
          </div>
          <!-- /.card-header -->
          <div class="card-body">
            <!-- BUSCADOR SIMPLIFICADO DE PRODUCTOS -->
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="input-group">
                  <input type="search" id="searchTermProducto" class="form-control" placeholder="Buscar por nombre, descripción, estado..."
                         onkeyup="aplicarFiltrosProductos()"/>
                  <div class="input-group-append">
                    <button class="btn btn-default" type="button" onclick="aplicarFiltrosProductos()">
                      <i class="fas fa-search"></i> Buscar
                    </button>
                    <button class="btn btn-secondary ml-2" type="button" onclick="abrirReporteProductosModal()">
                      <i class="fas fa-file-alt"></i> Generar Reporte
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <!-- FIN BUSCADOR SIMPLIFICADO DE PRODUCTOS -->

            <!-- Tabla de Productos -->
            <div id="tablaProductosContainer">
              <table id="productosTable" class="table table-bordered table-striped">
                <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Presentación</th>
                  <th>Categoría</th>
                  <th>Precio 1</th>
                  <th>Precio 2</th>
                  <th>Stock</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="productosTableBody">
                <!-- Contenido de la tabla se generará con JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
          <!-- /.card-body -->
        </div>
        <!-- /.card -->
      </div>
      <!-- /.col -->
    </div>
    <!-- /.row -->
  </div>
  <!-- /.container-fluid -->

  <!-- Modal para el Formulario de Producto -->
  <div class="modal fade" id="productoModal" tabindex="-1" role="dialog" aria-labelledby="productoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div id="modalFormContentProducto">
          <!-- El fragmento productos_form_modal.html se insertará aquí -->
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="reporteProductosModal" tabindex="-1" role="dialog" aria-labelledby="reporteProductosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document"> <div class="modal-content">
      <div id="modalReporteContentProducto">
      </div>
    </div>
    </div>
  </div>
  <script th:inline="javascript">
    /*<![CDATA[*/

    // Variable global para almacenar todos los productos
    allProducts = /*[[${productos}]]*/ [];

    // Función para renderizar la tabla con una lista de productos
    function renderizarTablaProductos(productsToDisplay) {
        const tableBody = $('#productosTableBody');
        tableBody.empty();

        if (productsToDisplay.length === 0) {
            // CAMBIO: colspan se ajusta a 8 (antes 9)
            tableBody.append('<tr><td colspan="8" class="text-center">No se encontraron productos.</td></tr>');
            return;
        }

        productsToDisplay.forEach(producto => {
            const estadoText = producto.estado === 1 ? 'Activo' : 'Inactivo';
            const estadoClass = producto.estado === 1 ? 'badge badge-success badge-pill' : 'badge badge-danger badge-pill';
            const categoriaNombre = producto.categoria ? producto.categoria.nombreCategoria : 'N/A';

            const row = `
                <tr>
                    <td>${producto.idProducto}</td>
                    <td>${producto.nombre}</td>
                    <td>${producto.descripcion}</td>
                    <td>${categoriaNombre}</td>
                    <td>${producto.precio1 ? producto.precio1.toFixed(2) : 'N/A'}</td>
                    <td>${producto.precio2 ? producto.precio2.toFixed(2) : 'N/A'}</td>
                    <td>${producto.stock}</td>
                    <td class="text-center"><span class="${estadoClass}">${estadoText}</span></td>
                    <td>
                        <a href="javascript:void(0)" onclick="abrirFormularioProducto('/productos/editar/${producto.idProducto}')"
                           class="btn btn-info btn-sm">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="javascript:void(0)" onclick="confirmarEliminarProducto(${producto.idProducto})"
                           class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>
            `;
            tableBody.append(row);
        });
    }

       /**
       * Limpia mensajes de error y clases inválidas
       * SOLO dentro del contenedor que le pases.
       *
       * @param {string|HTMLElement} container – selector o elemento DOM
       */
      function clearErrors(container) {
        const $c = (container instanceof HTMLElement)
          ? $(container)
          : $(container);
        $c.find('.text-danger').text('');
        $c.find('.is-invalid').removeClass('is-invalid');
      }

    // Función para mostrar un mensaje de error específico (genérica)
    function displayError(elementId, message) {
        $('#' + elementId).text(message);
        $('#' + elementId).prevAll('.form-control').first().addClass('is-invalid');
    }

    // ===========================================
    // FUNCIONES DE VALIDACIÓN ESPECÍFICAS (PARA PRODUCTOS - sin 'codigo')
    // ===========================================

    function validateNombreProducto(inputElementId, errorElementId, fieldName) {
        const input = $('#' + inputElementId);
        const value = input.val().trim();
        if (value === "") {
            displayError(errorElementId, `${fieldName} es obligatorio.`);
            return false;
        }
        input.removeClass('is-invalid');
        return true;
    }

    function validateDescripcionProducto(inputElementId, errorElementId, fieldName) {
        const input = $('#' + inputElementId);
        const value = input.val().trim();
        if (value === "") {
            displayError(errorElementId, `${fieldName} es obligatorio.`);
            return false;
        }
        input.removeClass('is-invalid');
        return true;
    }

    function validatePrecio(inputElementId, errorElementId, fieldName) {
        const input = $('#' + inputElementId);
        const value = input.val().trim();
        const regex = /^\d+(\.\d{1,2})?$/; // Números con hasta 2 decimales

        if (value === "") {
            displayError(errorElementId, `${fieldName} es obligatorio.`);
            return false;
        } else if (!regex.test(value) || parseFloat(value) <= 0) {
            displayError(errorElementId, `${fieldName} debe ser un número positivo con hasta 2 decimales.`);
            return false;
        }
        input.removeClass('is-invalid');
        return true;
    }

    function validateStockProducto(inputElementId, errorElementId) {
        const input = $('#' + inputElementId);
        const value = input.val().trim();
        const regex = /^\d+$/; // Solo números enteros

        if (value === "") {
            displayError(errorElementId, "El stock es obligatorio.");
            return false;
        } else if (!regex.test(value) || parseInt(value) < 0) {
            displayError(errorElementId, "El stock debe ser un número entero no negativo.");
            return false;
        }
        input.removeClass('is-invalid');
        return true;
    }

    function validateCategoriaProducto(inputElementId, errorElementId) {
        const input = $('#' + inputElementId);
        const value = input.val();
        if (value === null || value === "" || value === "0") {
            displayError(errorElementId, "La categoría es obligatoria.");
            return false;
        }
        input.removeClass('is-invalid');
        return true;
    }

    // ELIMINADO: Función checkCodigoUnico

    // Función principal de validación del formulario de Producto (sin 'codigo')
    async function validarFormularioProducto() {
        clearErrors('#formProducto');
        let isValid = true;

        if (!validateNombreProducto('nombre', 'nombreError', 'El nombre')) isValid = false;
        if (!validateDescripcionProducto('descripcion', 'descripcionError', 'La descripción')) isValid = false;
        if (!validatePrecio('precio1', 'precio1Error', 'El Precio 1')) isValid = false;
        if (!validatePrecio('precio2', 'precio2Error', 'El Precio 2')) isValid = false;
        if (!validateStockProducto('stock', 'stockError')) isValid = false;
        if (!validateCategoriaProducto('categoria', 'categoriaError')) isValid = false;

        // ELIMINADO: Llamada a checkCodigoUnico

        return isValid;
    }

    // ===========================================
    // MANEJADORES DE EVENTOS DEL MODAL Y FORMULARIO DE PRODUCTO (sin 'codigo')
    // ===========================================

     function abrirFormularioProducto(url) {
      console.log("Intentando abrir formulario de producto desde URL:", url);
      $('#modalFormContentProducto').load(url, function(response, status, xhr) {
        if (status === "error") {
          console.error("Error al cargar el formulario de producto:", xhr.status, xhr.statusText, response);
          Swal.fire({
            icon: 'error',
            title: 'Error al cargar formulario',
            text: 'Hubo un problema al cargar el formulario. Por favor, inténtalo de nuevo.',
            footer: `Detalles: ${xhr.status} ${xhr.statusText}`
          });
          return;
        }

        console.log("Formulario de producto cargado exitosamente.");

        // 1) Limpia errores previos SOLO de este form
        clearErrors('#formProducto');

        // 2) (Opcional) Adjunta validaciones en tiempo real
        // p.ej. $('#nombreProducto').on('input', () => validarNombreProducto());

        // 3) Captura el submit
        $('#formProducto')
          .off('submit')
          .on('submit', async function(e) {
            e.preventDefault();
            const formIsValid = await validarFormularioProducto();
            if (formIsValid) {
              guardarProductoAjax($(this));
            } else {
              console.log("Formulario de producto inválido. No se envía.");
              mostrarNotificacion("error", "Por favor, corrige los errores en el formulario.");
            }
          });

        // 4) Mostrar modal
        $('#productoModal').modal('show');
        console.log("Modal de producto intentando mostrarse.");
      });
    }

    function cerrarFormularioProducto() {
        $('#productoModal').modal('hide');
        $('#modalFormContentProducto').empty();
        clearErrors('#formProducto');
        console.log("Modal de producto cerrado.");
    }

    function guardarProductoAjax(formElement) {
        let formData = formElement.serialize();
        let url = formElement.attr('action');

        $.ajax({
            type: "POST",
            url: url,
            data: formData,
            success: function(response) {
                if (response.status === "success") {
                    mostrarNotificacion("success", response.message);
                    cerrarFormularioProducto();
                    recargarListaProductosCompleta();
                } else {
                    mostrarNotificacion("error", "Error: " + response.message);
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = "Error al procesar la solicitud.";
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage += ": " + xhr.responseJSON.message;
                } else if (xhr.responseText) {
                    errorMessage += ": " + xhr.responseText.substring(0, 100) + "...";
                }
                mostrarNotificacion("error", errorMessage);
                console.error("Error AJAX al guardar producto:", error, xhr.responseText);
            }
        });
    }

    function confirmarEliminarProducto(id) {
        Swal.fire({
            title: '¿Estás seguro?',
            text: "¡No podrás revertir esto!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                console.log("Eliminando producto con ID:", id);
                $.ajax({
                    type: "GET",
                    url: '/productos/eliminar/' + id,
                    success: function(response) {
                        if (response.status === "success") {
                            mostrarNotificacion("success", response.message);
                            recargarListaProductosCompleta();
                        } else {
                            mostrarNotificacion("error", "Error: " + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = "Error al eliminar el producto.";
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage += ": " + xhr.responseJSON.message;
                        } else if (xhr.responseText) {
                            errorMessage += ": " + xhr.responseText.substring(0, 100) + "...";
                        }
                        mostrarNotificacion("error", errorMessage);
                        console.error("Error AJAX al eliminar producto:", error, xhr.responseText);
                    }
                });
            }
        });
    }

    // ===========================================
    // FUNCIONES DE FILTRADO Y REPORTE DE PRODUCTOS (CLIENT-SIDE - sin 'codigo')
    // ===========================================

    function recargarListaProductosCompleta() {
        $.ajax({
            type: "GET",
            url: '/productos/all',
            dataType: "json",
            success: function(response) {
                allProducts = response;
                aplicarFiltrosProductos();
            },
            error: function(xhr, status, error) {
                console.error("Error al recargar la lista completa de productos:", error);
                mostrarNotificacion("error", "Error al recargar la lista de productos. Verifica el endpoint /productos/all en tu backend.");
            }
        });
    }

    function aplicarFiltrosProductos() {
        const searchTerm = $('#searchTermProducto').val().toLowerCase().trim();
        let filteredProducts = allProducts;

        if (searchTerm) {
            if (searchTerm === 'activo') {
                filteredProducts = allProducts.filter(producto => producto.estado === 1);
            } else if (searchTerm === 'inactivo') {
                filteredProducts = allProducts.filter(producto => producto.estado === 0);
            } else {
                filteredProducts = allProducts.filter(producto => {
                    const estadoText = producto.estado === 1 ? 'activo' : 'inactivo';
                    const categoriaNombre = producto.categoria ? producto.categoria.nombreCategoria.toLowerCase() : '';
                    return (
                        (producto.nombre && producto.nombre.toLowerCase().includes(searchTerm)) ||
                        (producto.descripcion && producto.descripcion.toLowerCase().includes(searchTerm)) ||
                        // ELIMINADO: Búsqueda por 'codigo'
                        categoriaNombre.includes(searchTerm) ||
                        estadoText.includes(searchTerm)
                    );
                });
            }
        }
        renderizarTablaProductos(filteredProducts);
    }

    // ============== NUEVAS FUNCIONES PARA EL REPORTE DE PRODUCTOS ==============

    // Abre el modal de filtros del reporte de productos
    function abrirReporteProductosModal() {
        console.log("Abriendo modal de reporte de productos...");
        $('#modalReporteContentProducto').load('/productos/reporte/modal', function(response, status, xhr) {
            if (status === "error") {
                console.error("Error al cargar el formulario de reporte de productos:", xhr.status, xhr.statusText, response);
                Swal.fire({
                    icon: 'error',
                    title: 'Error al cargar reporte',
                    text: 'Hubo un problema al cargar el formulario de reporte. Por favor, inténtalo de nuevo.',
                    footer: `Detalles: ${xhr.status} ${xhr.statusText}`
                });
            } else {
                console.log("Formulario de reporte de productos cargado exitosamente.");
                // Establecer las fechas máximas/mínimas para los campos de fecha
                setReportDateMaxAttributes(); // Para fecha de inicio
                setReportDateMinAttributes(); // Para fecha de fin
                $('#reporteProductosModal').modal('show');
            }
        });
    }

    // Cierra el modal de reporte de productos
    function cerrarReporteProductosModal() {
        $('#reporteProductosModal').modal('hide');
        setTimeout(() => {
            $('#modalReporteContentProducto').empty();
        }, 300);
    }

    // Limpia los filtros del modal de reporte de productos
    function limpiarFiltrosReporteProductos() {
        $('#formReporteProductos')[0].reset();
        $('.estado-checkbox-producto').prop('checked', false);
        setReportDateMaxAttributes(); // Restablecer límites de fecha
        setReportDateMinAttributes();
    }

    // Función para ajustar el atributo 'max' de la fecha de inicio
    function setReportDateMaxAttributes() {
        const today = new Date().toISOString().split('T')[0];
        $('#fechaRegistroStart').attr('max', today);

        // Si la fecha de fin está establecida y es anterior a la fecha de inicio, ajustarla
        const fechaFin = $('#fechaRegistroEnd').val();
        if (fechaFin && $('#fechaRegistroStart').val() && new Date(fechaFin) < new Date($('#fechaRegistroStart').val())) {
            $('#fechaRegistroEnd').val($('#fechaRegistroStart').val());
        }
        $('#fechaRegistroEnd').attr('min', $('#fechaRegistroStart').val());
    }

    // Función para ajustar el atributo 'min' de la fecha de fin
    function setReportDateMinAttributes() {
        const today = new Date().toISOString().split('T')[0];
        $('#fechaRegistroEnd').attr('max', today);

        // Si la fecha de inicio está establecida y es posterior a la fecha de fin, ajustarla
        const fechaInicio = $('#fechaRegistroStart').val();
        if (fechaInicio && $('#fechaRegistroEnd').val() && new Date(fechaInicio) > new Date($('#fechaRegistroEnd').val())) {
            $('#fechaRegistroStart').val($('#fechaRegistroEnd').val());
        }
        $('#fechaRegistroStart').attr('max', $('#fechaRegistroEnd').val() || today); // Si fechaEnd vacía, max es hoy
    }

    // Ejecuta la generación del reporte PDF de productos
    function ejecutarGenerarReporteProductos() {
        Swal.fire({
            title: 'Generando Reporte...',
            text: 'Por favor, espera mientras se genera el PDF.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const form = $('#formReporteProductos');
        const formData = form.serialize();

        const url = '/productos/reporte/pdf?' + formData;

        setTimeout(() => {
            const newWindow = window.open(url, '_blank');
            if (newWindow) {
                Swal.close();
                mostrarNotificacion("success", "El reporte PDF se está generando y debería descargarse pronto.");
                cerrarReporteProductosModal();
            } else {
                Swal.close();
                mostrarNotificacion("error", "Error: Tu navegador bloqueó la descarga del PDF. Por favor, permite los pop-ups para este sitio.");
            }
        }, 300);
    }

    // Función para mostrar notificaciones usando AdminLTE Toasts
    function mostrarNotificacion(type, message) {
        $(document).Toasts('create', {
            class: type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-info' : 'bg-danger'),
            title: type === 'success' ? 'Éxito' : (type === 'info' ? 'Información' : 'Error'),
            body: message,
            autohide: true,
            delay: 3000
        });
    }


    // Ejecutar al cargar la página por primera vez
    $(document).ready(function() {
        aplicarFiltrosProductos();
    });

    /*]]>*/
  </script>
</section>
</body>
</html>
